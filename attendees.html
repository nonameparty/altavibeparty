<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conferma dati — più biglietti</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
  :root{--bg:#000;--text:#fff;--card:#0c0c0f;--border:rgba(255,255,255,.12);--accent:#8b5cf6;--ok:#22c55e}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:22px}
  h1{font-size:28px;font-weight:900;letter-spacing:-.2px;margin:8px 0 14px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .field{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .field input{width:100%;background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:12px}
  .line{display:flex;justify-content:space-between;margin:6px 0;font-size:14px}
  .total{font-size:22px;font-weight:900;margin-top:8px}
  .btn{background:var(--accent);color:#000;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer}
  .ghost{background:transparent;border:1px solid var(--border);color:#fff}
  .slot{border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
  .slot h3{margin:0 0 10px 0;font-size:14px;opacity:.9}
  .useme{width:100%;margin-top:10px;background:#1a1428;border:1px solid rgba(139,92,246,.5);color:#fff}
  .muted{opacity:.8;font-size:13px}
  .save{color:var(--ok);font-weight:800}
  .hr{height:1px;background:var(--border);margin:12px 0}
</style>
</head>
<body>
  <main class="wrap">
    <h1>Conferma dati — più biglietti</h1>
    <div class="grid">
      <section class="card" id="left">
        <div id="slots"></div>
      </section>

      <aside class="card">
        <div class="muted" id="eventMeta">Sab 21 Mar 2026 · 22:30 → 04:30 · Via Italia 38, Biella</div>
        <div class="hr"></div>
        <div id="summaryLines"></div>
        <div class="total">Totale (IVA inclusa) <span id="grand">0€</span></div>
        <div class="hr"></div>
        <div class="muted" style="margin-bottom:10px">
          Se un amico non è ancora registrato, potrà farlo dopo l’acquisto: gli invieremo un link e i biglietti
          saranno già visibili nella sua area personale. La <strong>Protezione cambio nome</strong> (se attiva)
          consente 1 cambio fino a 48h dall’evento.
        </div>
        <div style="display:flex;gap:8px">
          <button id="backBtn" class="btn ghost">Indietro</button>
          <button id="payBtn" class="btn">Paga ora</button>
        </div>
      </aside>
    </div>
  </main>

<script type="module">
/* ==== Auth ==== */
import { onUser } from './auth.v2.js?v=6';

/* ==== Costanti prezzi (stesse del checkout) ==== */
const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90, STD3:40 };
const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '€';

/* ==== Quantità da querystring ==== */
const Q = new URLSearchParams(location.search);
const cart = {
  eb: +(Q.get('eb')||0),
  std: +(Q.get('std')||0),
  fast:+(Q.get('fast')||0),
  vip: +(Q.get('vip')||0),
  nc:  +(Q.get('nc')||0)
};

/* ==== Snapshot sconto da localStorage ==== */
function readDiscount(){
  try{ return JSON.parse(localStorage.getItem('trapperreo_discount_applied')||'null'); }catch{ return null; }
}
const discountSnap = readDiscount(); // {code,type,value,allowedSkus}

/* ==== Costruzione form nominativi ==== */
const slots = document.getElementById('slots');
const kinds = [
  ['eb','Early Bird'],
  ['std','Standard'],
  ['fast','Fast Entry'],
  ['vip','VIP Entry']
];

let currentUser = null;
onUser(u => { currentUser = u || null; });

const slotEls = [];
kinds.forEach(([key,label])=>{
  for(let i=0; i<cart[key]; i++){
    const el = document.createElement('div');
    el.className = 'slot';
    el.innerHTML = `
      <h3>${label} — Biglietto ${i+1}</h3>
      <div class="field">
        <div><input placeholder="Nome"  data-field="first"></div>
        <div><input placeholder="Cognome" data-field="last"></div>
      </div>
      <div class="field" style="grid-template-columns:1fr">
        <div><input placeholder="email@email.it" data-field="email" inputmode="email"></div>
      </div>
      <button class="btn useme" type="button">Usa i miei dati per questo biglietto</button>
    `;
    const btn = el.querySelector('.useme');
    btn.addEventListener('click', ()=>{
      if(!currentUser) return;
      const [f,l] = (currentUser.displayName||'').split(' ');
      el.querySelector('[data-field="first"]').value = f || '';
      el.querySelector('[data-field="last"]').value  = l || '';
      el.querySelector('[data-field="email"]').value = currentUser.email || '';
    });
    slots.appendChild(el);
    slotEls.push(el);
  }
});

/* ==== Calcolo subtotali, sconto e totale ==== */
function stdTotal(q){ const b=Math.floor(q/3), r=q%3; return b*PRICE.STD3 + r*PRICE.STD; }
function parts(){
  return {
    EB: cart.eb * PRICE.EB,
    STD: stdTotal(cart.std),
    FAST: cart.fast * PRICE.FAST,
    VIP: cart.vip * PRICE.VIP
  };
}
function computeDiscount(d, p){
  if(!d) return 0;
  const allow = (d.allowedSkus && d.allowedSkus.length? d.allowedSkus : ['EB','STD','FAST','VIP']);
  const base = (allow.includes('EB')?p.EB:0)+(allow.includes('STD')?p.STD:0)+(allow.includes('FAST')?p.FAST:0)+(allow.includes('VIP')?p.VIP:0);
  if(d.type==='percent') return Math.max(0, +(base*(d.value/100)).toFixed(2));
  if(d.type==='fixed')   return Math.max(0, Math.min(base, d.value));
  return 0;
}

const summaryLines = document.getElementById('summaryLines');
const grand = document.getElementById('grand');

function renderSummary(){
  const p = parts();
  const gross = p.EB+p.STD+p.FAST+p.VIP;
  const disc = computeDiscount(discountSnap, p);
  const prot = cart.nc ? ( (cart.eb+cart.std+cart.fast+cart.vip) * PRICE.NAMECHANGE ) : 0;
  const tot  = Math.max(0, gross - disc) + prot;

  const L=[];
  if(cart.eb)   L.push(`<div class="line"><span>Early Bird × ${cart.eb}</span><span>${money(p.EB)}</span></div>`);
  if(cart.std)  L.push(`<div class="line"><span>Standard × ${cart.std}</span><span>${money(p.STD)}</span></div>`);
  if(cart.fast) L.push(`<div class="line"><span>Fast Entry × ${cart.fast}</span><span>${money(p.FAST)}</span></div>`);
  if(cart.vip)  L.push(`<div class="line"><span>VIP Entry × ${cart.vip}</span><span>${money(p.VIP)}</span></div>`);
  if(discountSnap){
    const tag = `${discountSnap.code} — ${discountSnap.type==='percent' ? '%'+discountSnap.value : '−'+money(discountSnap.value)}`;
    L.push(`<div class="line save"><span>Sconto (${tag})</span><span>- ${money(disc)}</span></div>`);
  }
  if(prot>0){
    const tc = cart.eb+cart.std+cart.fast+cart.vip;
    L.push(`<div class="line"><span>Protezione cambio nome × ${tc}</span><span>${money(prot)}</span></div>`);
  }
  summaryLines.innerHTML = L.join('');
  grand.textContent = money(tot);
}
renderSummary();

/* ==== Bottoni ==== */
document.getElementById('backBtn').addEventListener('click', ()=>history.back());
document.getElementById('payBtn').addEventListener('click', ()=>{
  // TODO: integrare pagamento
  alert('Pagamento: placeholder');
});
</script>
</body>
</html>
