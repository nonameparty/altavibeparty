<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conferma dati — più biglietti</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#000;--text:#fff;--muted:rgba(255,255,255,.78);--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--accent:#8b5cf6;--ok:#22c55e;--danger:#ef4444}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
h1{font-size:28px;font-weight:900;letter-spacing:-.2px;margin-bottom:10px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:8px}
.sectionTitle{font-size:18px;font-weight:900;margin-bottom:10px}
.row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.total{font-size:22px;font-weight:900}
.badge{display:inline-block;background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:13px;margin-right:6px}
label{display:block;margin:6px 0 4px}
input{width:100%;background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.ticket{background:#0b0b0b;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:12px;margin:10px 0}
.ticket .use-me{display:flex;align-items:center;gap:10px;margin-top:8px;background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.45);border-radius:10px;padding:10px}
.use-me input{accent-color:var(--accent)}
.small{font-size:13px;color:var(--muted)}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.save{color:var(--ok);font-weight:800}
.err{border-color:#ef4444 !important;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
</style>
</head>
<body>
<main class="wrap">
  <h1>Conferma dati — <strong>più biglietti</strong></h1>

  <div class="grid">
    <!-- SINISTRA: nominativi -->
    <section class="card">
      <div class="sectionTitle">Inserisci i nominativi</div>
      <div id="tickets"></div>
    </section>

    <!-- DESTRA: riepilogo -->
    <aside class="card">
      <div class="badge">Sab 21 Mar 2026</div>
      <div class="badge">22:30 → 04:30</div>
      <div class="badge">Via Italia 38, Biella</div>

      <div id="lines" style="margin-top:8px"></div>
      <div class="hr"></div>
      <div class="row total"><div>Totale (IVA inclusa)</div><div id="grand">0€</div></div>

      <div class="small" style="margin-top:10px">
        Se un amico non è ancora registrato, potrà farlo dopo l’acquisto:
        gli invieremo un link e i biglietti saranno già visibili nella sua area personale.
        La <strong>Protezione cambio nome</strong> (se attiva) consente 1 cambio fino a 48h dall’evento.
      </div>

      <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
        <button class="btn ghost" id="back">Indietro</button>
        <button class="btn" id="pay">Paga ora</button>
      </div>
    </aside>
  </div>
</main>

<script type="module">
import { onUser } from './auth.v2.js?v=6';

const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90, STD3:40 };
const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '€';
const $ = s => document.querySelector(s);

/* ====== letture ====== */
function readLS(k,def=null){ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch{ return def; } }
function readCart(){ return readLS('trapperreo_cart', {}); }
function readApplied(){ try{ return JSON.parse(localStorage.getItem('trapperreo_discount_applied')||'null'); }catch{ return null; } }

const qs = new URLSearchParams(location.search);
const qty = {
  EB: +(qs.get('eb')||0)   || (readCart().eb|0),
  STD:+(qs.get('std')||0)  || (readCart().std|0),
  FAST:+(qs.get('fast')||0)|| (readCart().fast|0),
  VIP: +(qs.get('vip')||0) || (readCart().vip|0),
};
const nameProt = (+(qs.get('nc')||0) || (readCart().nc|0)) === 1;

/* ====== nominativi con “usa i miei dati” ====== */
const list = document.getElementById('tickets');
const order = [['EB','Early Bird'],['STD','Standard'],['FAST','Fast Entry'],['VIP','VIP Entry']];
const rows = [];
let me = { first:'', last:'', email:'' };

onUser(u=>{
  if(!u) return;
  const p=(u.displayName||'').trim().split(' ');
  me.first=p[0]||''; me.last=p.slice(1).join(' ')||''; me.email=(u.email||'');
});

for(const [sku,label] of order){
  const n = qty[sku]||0; for(let i=0;i<n;i++){
    const el=document.createElement('div'); el.className='ticket'; el.dataset.sku=sku;
    el.innerHTML = `
      <div class="small" style="opacity:.95;margin-bottom:6px">${label} — Biglietto ${i+1}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><label>Nome</label><input class="fn" placeholder="Nome"></div>
        <div><label>Cognome</label><input class="ln" placeholder="Cognome"></div>
      </div>
      <label style="margin-top:6px">Email</label>
      <input class="em" type="email" placeholder="email@email.it">
      <label class="use-me"><input type="checkbox" class="useCheck"> <strong>Usa i miei dati per questo biglietto</strong></label>
    `;
    el.querySelector('.useCheck').addEventListener('change', (e)=>{
      const fn=el.querySelector('.fn'), ln=el.querySelector('.ln'), em=el.querySelector('.em');
      if(e.target.checked){ fn.value=me.first; ln.value=me.last; em.value=me.email; [fn,ln,em].forEach(i=>i.classList.remove('err')); }
      else { fn.value=''; ln.value=''; em.value=''; }
    });
    list.appendChild(el); rows.push(el);
  }
}
if(rows.length===0) list.innerHTML = `<div class="small">Nessun nominativo necessario.</div>`;

/* ====== calcoli ====== */
function stdTotal(q){ const b=Math.floor(q/3), r=q%3; return b*PRICE.STD3 + r*PRICE.STD; }
function parts(){
  return {
    EB: (qty.EB||0)*PRICE.EB,
    STD: stdTotal(qty.STD||0),
    FAST:(qty.FAST||0)*PRICE.FAST,
    VIP: (qty.VIP||0)*PRICE.VIP
  };
}
function allowedSet(snap){
  return (Array.isArray(snap?.allowedSkus) && snap.allowedSkus.length>0) ? snap.allowedSkus : ['EB','STD','FAST','VIP'];
}
function compute(){
  const P = parts();
  const gross = P.EB + P.STD + P.FAST + P.VIP;

  const snap = readApplied(); // {code,type,value,allowedSkus}
  let disc = 0, tag=null;
  if(snap){
    const allow = allowedSet(snap);
    const base =
      (allow.includes('EB')?P.EB:0) + (allow.includes('STD')?P.STD:0) +
      (allow.includes('FAST')?P.FAST:0) + (allow.includes('VIP')?P.VIP:0);
    if(snap.type==='percent') disc=Math.max(0, base*(snap.value/100));
    else if(snap.type==='fixed') disc=Math.max(0, Math.min(base, snap.value));
    tag = `${snap.code} — ${snap.type==='percent' ? '%'+snap.value : '−'+money(snap.value)}`;
  }

  const t = (qty.EB|0)+(qty.STD|0)+(qty.FAST|0)+(qty.VIP|0);
  const prot = nameProt ? t*PRICE.NAMECHANGE : 0;
  const net = Math.max(0, gross - disc) + prot;
  return {P,gross,disc,prot,net,tag};
}

/* ====== render ====== */
const LINES = document.getElementById('lines');
const GRAND = document.getElementById('grand');
function render(){
  const {P,disc,prot,net,tag} = compute();
  const L=[]; const label = k=>({EB:'Early Bird',STD:'Standard',FAST:'Fast Entry',VIP:'VIP Entry'})[k];
  if(qty.EB>0)   L.push(`<div class="row"><div>${label('EB')} × ${qty.EB}</div><div>${money(P.EB)}</div></div>`);
  if(qty.STD>0)  L.push(`<div class="row"><div>${label('STD')} × ${qty.STD}</div><div>${money(P.STD)}</div></div>`);
  if(qty.FAST>0) L.push(`<div class="row"><div>${label('FAST')} × ${qty.FAST}</div><div>${money(P.FAST)}</div></div>`);
  if(qty.VIP>0)  L.push(`<div class="row"><div>${label('VIP')} × ${qty.VIP}</div><div>${money(P.VIP)}</div></div>`);
  if(tag)        L.push(`<div class="row save"><div>Sconto (${tag})</div><div>- ${money(disc)}</div></div>`);
  if(nameProt){
    const t=(qty.EB|0)+(qty.STD|0)+(qty.FAST|0)+(qty.VIP|0);
    L.push(`<div class="row"><div>Protezione cambio nome × ${t}</div><div>${money(prot)}</div></div>`);
  }
  LINES.innerHTML = L.join('');
  GRAND.textContent = money(net);
}
render();

/* ====== validazione minima ====== */
function isEmail(v){ return /^\S+@\S+\.\S+$/.test((v||'').trim()); }
function validate(){
  let ok=true;
  rows.forEach(r=>{
    const fn=r.querySelector('.fn'), ln=r.querySelector('.ln'), em=r.querySelector('.em');
    [fn,ln,em].forEach(i=>i.classList.remove('err'));
    if(!fn.value.trim()){ fn.classList.add('err'); ok=false; }
    if(!ln.value.trim()){ ln.classList.add('err'); ok=false; }
    if(!isEmail(em.value)){ em.classList.add('err'); ok=false; }
  });
  return ok;
}

/* ====== bottoni ====== */
document.getElementById('back').addEventListener('click', ()=>history.back());
document.getElementById('pay').addEventListener('click', ()=>{ if(!validate()) return; alert('Pagamento avviato (simulazione).'); });
</script>
</body>
</html>
