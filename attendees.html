<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conferma dati — più biglietti</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#000;--text:#fff;--muted:rgba(255,255,255,.78);--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--accent:#8b5cf6;--ok:#22c55e;--danger:#ef4444}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
h1{font-size:28px;font-weight:900;letter-spacing:-.2px;margin-bottom:10px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:8px}
.sectionTitle{font-size:18px;font-weight:900;margin-bottom:10px}
.row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.total{font-size:22px;font-weight:900}
.badge{display:inline-block;background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:13px;margin-right:6px}
label{display:block;margin:6px 0 4px}
input{width:100%;background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.ticket{background:#0b0b0b;border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:12px;margin:10px 0}
.small{font-size:13px;color:var(--muted)}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.save{color:var(--ok);font-weight:800}
.err{border-color:var(--danger) !important;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
</style>
</head>
<body>
<main class="wrap">
  <h1>Conferma dati — <strong>più biglietti</strong></h1>

  <div class="grid">
    <!-- SINISTRA: nominativi -->
    <section class="card">
      <div class="sectionTitle">Inserisci i nominativi</div>
      <div id="tickets"></div>

      <div class="card" style="margin-top:10px">
        <div class="sectionTitle" style="margin-bottom:6px">Attenzione</div>
        <div class="small">
          I nominativi devono coincidere con il documento d’identità mostrato all’ingresso.
          Ogni amico riceverà la prevendita via email. La <strong>Protezione cambio nome</strong>
          (se attiva nel checkout) consente <strong>1 cambio</strong> fino a 48h prima dell’evento.
        </div>
      </div>
    </section>

    <!-- DESTRA: riepilogo -->
    <aside class="card">
      <div class="badge">Sab 21 Mar 2026</div>
      <div class="badge">22:30 → 04:30</div>
      <div class="badge">Via Italia 38, Biella</div>

      <div id="lines" style="margin-top:8px"></div>
      <div class="hr"></div>
      <div class="row total"><div>Totale (IVA inclusa)</div><div id="grand">0€</div></div>

      <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
        <button class="btn ghost" id="back">Indietro</button>
        <button class="btn" id="pay">Paga ora</button>
      </div>
    </aside>
  </div>
</main>

<script type="module">
/* ======= Config prezzi (come checkout) ======= */
const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90, STD3:40 };

/* ======= Helpers ======= */
const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '€';
const $ = s => document.querySelector(s);

/* ======= Letture base ======= */
function readLS(k, def=null){ try{ return JSON.parse(localStorage.getItem(k)||'null') ?? def; }catch{ return def; } }
function readCart(){ return readLS('trapperreo_cart', {}); }
function readDiscountSnapshot(){
  const raw = localStorage.getItem('trapperreo_discount_applied')
        || localStorage.getItem('trapperreo_discount')
        || localStorage.getItem('trapperreo_discount_snapshot');
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function normalizeDiscount(d){
  if(!d) return null;
  const out = {
    code: (d.code||d.Code||d.name||'').toString().trim(),
    type: (d.type||d.kind||'').toString().toLowerCase(),  // 'percent' | 'fixed'
    value: Number(d.value ?? d.amount ?? 0),
    active: (d.active ?? d.enabled ?? true) === true,
    scope: (d.scope||'all'),
    userEmail: (d.userEmail||d.email||'')?.toLowerCase?.() || '',
    allowedSkus: Array.isArray(d.allowedSkus)? d.allowedSkus
                 : Array.isArray(d.skus)? d.skus
                 : null
  };
  if(!out.code || !out.active || !out.type || !(out.value>0)) return null;
  return out;
}

const qs = new URLSearchParams(location.search);
const qty = {
  EB: +(qs.get('eb')||0)   || (readCart().eb|0),
  STD:+(qs.get('std')||0)  || (readCart().std|0),
  FAST:+(qs.get('fast')||0)|| (readCart().fast|0),
  VIP: +(qs.get('vip')||0) || (readCart().vip|0),
};
const nameProt = (+(qs.get('nc')||0) || (readCart().nc|0)) === 1;

/* ======= UI generazione nominativi ======= */
const list = $('#tickets');
const order = [['EB','Early Bird'],['STD','Standard'],['FAST','Fast Entry'],['VIP','VIP Entry']];
const rows=[];
for(const [sku,label] of order){
  const n = qty[sku]||0; for(let i=0;i<n;i++){
    const el=document.createElement('div'); el.className='ticket'; el.dataset.sku=sku;
    el.innerHTML = `
      <div class="small" style="opacity:.95;margin-bottom:6px">${label} — Biglietto ${i+1}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><label>Nome</label><input class="fn" placeholder="Nome"></div>
        <div><label>Cognome</label><input class="ln" placeholder="Cognome"></div>
      </div>
      <label style="margin-top:6px">Email</label>
      <input class="em" type="email" placeholder="email@email.it">
    `;
    list.appendChild(el); rows.push(el);
  }
}
if(rows.length===0){
  list.innerHTML='<div class="small">Nessun nominativo necessario.</div>';
}

/* ======= Calcolo subtotale biglietti (con promo 3×40 per STD) ======= */
function stdTotal(q){ const b=Math.floor(q/3), r=q%3; return b*PRICE.STD3 + r*PRICE.STD; }
function subtotalBySku(){
  return {
    EB: (qty.EB||0)*PRICE.EB,
    STD: stdTotal(qty.STD||0),
    FAST:(qty.FAST||0)*PRICE.FAST,
    VIP: (qty.VIP||0)*PRICE.VIP
  };
}

/* ======= Applicazione sconto a livello ordine ======= */
function computeTotals(){
  const parts = subtotalBySku();
  const gross = parts.EB + parts.STD + parts.FAST + parts.VIP;

  const dSnap = normalizeDiscount(readDiscountSnapshot());
  const allowed = dSnap?.allowedSkus || ['EB','STD','FAST','VIP'];

  // base imponibile scontabile = somma dei soli SKU consentiti
  const baseDisc =
      (allowed.includes('EB')   ? parts.EB   : 0) +
      (allowed.includes('STD')  ? parts.STD  : 0) +
      (allowed.includes('FAST') ? parts.FAST : 0) +
      (allowed.includes('VIP')  ? parts.VIP  : 0);

  let disc = 0;
  if(dSnap){
    if(dSnap.type==='percent') disc = Math.max(0, Math.min(gross, baseDisc * (dSnap.value/100)));
    else if(dSnap.type==='fixed') disc = Math.max(0, Math.min(gross, dSnap.value));
  }

  const ticketsCount = (qty.EB|0)+(qty.STD|0)+(qty.FAST|0)+(qty.VIP|0);
  const prot = nameProt ? ticketsCount*PRICE.NAMECHANGE : 0;

  const net = Math.max(0, gross - disc) + prot;
  return { parts, gross, disc, prot, net, dSnap, ticketsCount };
}

/* ======= Rendering ======= */
function label(k){ return {EB:'Early Bird',STD:'Standard',FAST:'Fast Entry',VIP:'VIP Entry'}[k] || k; }

function render(){
  const L = $('#lines');
  const {parts,disc,prot,net,dSnap} = computeTotals();
  const lines=[];
  if(qty.EB>0)   lines.push(`<div class="row"><div>${label('EB')} × ${qty.EB}</div><div>${money(parts.EB)}</div></div>`);
  if(qty.STD>0)  lines.push(`<div class="row"><div>${label('STD')} × ${qty.STD}</div><div>${money(parts.STD)}</div></div>`);
  if(qty.FAST>0) lines.push(`<div class="row"><div>${label('FAST')} × ${qty.FAST}</div><div>${money(parts.FAST)}</div></div>`);
  if(qty.VIP>0)  lines.push(`<div class="row"><div>${label('VIP')} × ${qty.VIP}</div><div>${money(parts.VIP)}</div></div>`);

  if(dSnap && disc>0){
    lines.push(`<div class="row save"><div>Sconto (${dSnap.code})</div><div>-${money(disc)}</div></div>`);
  }
  if(nameProt){
    lines.push(`<div class="row"><div>Protezione cambio nome × ${(qty.EB|0)+(qty.STD|0)+(qty.FAST|0)+(qty.VIP|0)}</div><div>${money(prot)}</div></div>`);
  }
  L.innerHTML = lines.join('');
  $('#grand').textContent = money(net);
}

/* ======= Validazione ======= */
function isEmail(v){ return /^\S+@\S+\.\S+$/.test((v||'').trim()); }
function validateRows(){
  let ok=true;
  rows.forEach(r=>{
    const fn=r.querySelector('.fn'), ln=r.querySelector('.ln'), em=r.querySelector('.em');
    [fn,ln,em].forEach(i=>i.classList.remove('err'));
    if(!fn.value.trim()){ fn.classList.add('err'); ok=false; }
    if(!ln.value.trim()){ ln.classList.add('err'); ok=false; }
    if(!isEmail(em.value)){ em.classList.add('err'); ok=false; }
  });
  return ok;
}

/* ======= Bind ======= */
$('#back').addEventListener('click', ()=>history.back());
$('#pay').addEventListener('click', ()=>{
  if(!validateRows()) return;
  alert('Pagamento avviato (simulazione).');
});

/* init */
render();
</script>
</body>
</html>
