<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Founder ‚Äî TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12);--muted:rgba(255,255,255,.78)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:1100px;margin:auto;padding:22px}
h1{font-size:32px;font-weight:900;margin-bottom:8px}
h2{font-size:20px;font-weight:900}
.muted{color:var(--muted)}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:14px}
input,select{background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.grid2{display:grid;grid-template-columns:1fr auto;gap:10px}
.table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
.badge{display:inline-block;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
.small{font-size:12px}
.right{display:flex;gap:10px;align-items:center}
.notice{display:none;margin:10px 0;padding:12px;border-radius:10px;background:#2a0e0e;border:1px solid #ff6b6b;color:#ffdede}
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<main class="wrap">
  <h1>Pannello Founder</h1>
  <div id="who" class="muted">Verifica permessi‚Ä¶</div>

  <!-- Banner errori -->
  <div id="errBanner" class="notice"></div>

  <!-- Azioni rapide (ora link verso pagine dedicate) -->
  <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <a href="./founder-gift.html" class="btn ghost">Crea omaggio</a>
    <a href="./founder-discount.html" class="btn ghost">Codice sconto</a>
    <a href="./founder-tables.html" class="btn">üçæ Gestione tavoli & bottiglie</a>
    <button id="btnExportCSV" class="btn">Export CSV utenti</button>
  </div>

  <section class="card">
    <div class="right">
      <h2>Statistiche rapide</h2>
      <div id="statLoad" class="spinner" aria-hidden="true" style="display:none"></div>
    </div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px">
      <div class="badge">Utenti attivi: <span id="statActive">‚Äî</span></div>
      <div class="badge">Utenti totali: <span id="statTotal">‚Äî</span></div>
    </div>
  </section>

  <section class="card">
    <div class="right" style="justify-content:space-between;">
      <h2>Gestione utenti</h2>
      <div class="right">
        <button id="btnReload" class="btn ghost small">Carica ultimi</button>
        <div id="listLoad" class="spinner" aria-hidden="true" style="display:none"></div>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <input id="q" placeholder="Cerca per email o nome‚Ä¶" />
      <button id="btnSearch" class="btn">Cerca</button>
    </div>
    <table class="table" id="tbl">
      <thead>
        <tr><th>Nome</th><th>Email</th><th>Ruolo</th><th>Status</th><th>Azioni</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="empty" class="muted small" style="display:none;margin-top:8px">Nessun risultato.</div>
  </section>
</main>

<script type="module">
import { app, onUser, exportUsersCSV } from './auth.v2.js?v=6';
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = getFirestore(app);

// UI refs
const who       = document.getElementById('who');
const errBanner = document.getElementById('errBanner');
const statActive= document.getElementById('statActive');
const statTotal = document.getElementById('statTotal');
const statLoad  = document.getElementById('statLoad');
const qInput    = document.getElementById('q');
const btnSearch = document.getElementById('btnSearch');
const btnReload = document.getElementById('btnReload');
const tbody     = document.querySelector('#tbl tbody');
const emptyMsg  = document.getElementById('empty');
const listLoad  = document.getElementById('listLoad');
const btnExportCSV = document.getElementById('btnExportCSV');

const lc = s => (s||'').toString().trim().toLowerCase();

async function isFounder(email){
  try{
    const snap = await getDoc(doc(db,'config','admins'));
    if(!snap.exists()) return false;
    const founders = snap.data()?.founders || {};
    return founders[lc(email)] === true;
  }catch(_){ return false; }
}

function showError(msg){ errBanner.textContent = msg; errBanner.style.display = 'block'; }
function hideError(){ errBanner.style.display='none'; }

function safeName(v){ return (v?.name || v?.name_lc || v?.email || '').toString(); }
function safeUpdatedAt(v){
  const u = v?.updatedAt || v?.createdAt;
  if (!u) return 0;
  if (typeof u === 'number') return u;
  if (u?.seconds) return u.seconds * 1000 + Math.floor((u.nanoseconds||0)/1e6);
  try { return new Date(u).getTime() || 0; } catch { return 0; }
}

function renderRows(users){
  tbody.innerHTML = '';
  emptyMsg.style.display = users.length ? 'none' : 'block';

  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.name || '‚Äî'}</td>
      <td>${u.email || '‚Äî'}</td>
      <td>
        <select data-uid="${u.uid}" class="roleSel">
          ${['customer','pr','admin','founder'].map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}
        </select>
      </td>
      <td>
        <select data-uid="${u.uid}" class="statusSel">
          ${['active','suspended','deleted'].map(s=>`<option value="${s}" ${u.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn ghost small" data-save="${u.uid}">Salva</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-save]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const uid = btn.getAttribute('data-save');
      const role = tbody.querySelector(`select.roleSel[data-uid="${uid}"]`).value;
      const status = tbody.querySelector(`select.statusSel[data-uid="${uid}"]`).value;
      btn.disabled = true; btn.textContent = 'Salvo‚Ä¶';
      try{
        await setDoc(doc(db,'users',uid), { role, status, updatedAt: Date.now() }, { merge:true });
        btn.textContent = 'Salvato ‚úì';
      }catch(e){
        console.error('save user error', e);
        btn.textContent = 'Errore';
        showError('Errore durante il salvataggio. Controlla le regole o i permessi.');
      }finally{
        setTimeout(()=>{ btn.textContent='Salva'; btn.disabled=false; }, 900);
      }
    });
  });
}

async function runStats(){
  statLoad.style.display = 'inline-block';
  try{
    const snap = await getDocs(collection(db,'users'));
    let active=0;
    snap.forEach(d=>{
      const v = d.data() || {};
      if ((v.status || 'active').toString().toLowerCase() === 'active') active++;
    });
    statActive.textContent = active;
    statTotal.textContent  = snap.size;
  }catch(e){
    console.error('stats error', e);
    showError('Impossibile leggere le statistiche.');
  }finally{
    statLoad.style.display = 'none';
  }
}

async function loadLatest(){
  hideError();
  listLoad.style.display = 'inline-block';
  try{
    const snap = await getDocs(collection(db,'users'));
    const arr = [];
    snap.forEach(d=> arr.push({ uid:d.id, ...d.data() }));
    arr.sort((a,b)=>{
      const byTime = safeUpdatedAt(b) - safeUpdatedAt(a);
      return byTime !== 0 ? byTime : safeName(a).localeCompare(safeName(b));
    });
    renderRows(arr);
  }catch(e){
    console.error('load users error', e);
    showError('Non riesco a caricare la lista utenti (permessi?).');
    renderRows([]);
  }finally{
    listLoad.style.display = 'none';
  }
}

async function searchUsers(qs){
  hideError();
  const term = lc(qs);
  if(!term){ renderRows([]); return; }
  listLoad.style.display = 'inline-block';
  try{
    const snap = await getDocs(collection(db,'users'));
    const out = [];
    snap.forEach(d=>{
      const v = d.data() || {};
      const email = lc(v.email);
      const name  = lc(v.name_lc || v.name);
      if (email === term || (term && name.startsWith(term))) out.push({ uid:d.id, ...v });
    });
    out.sort((a,b)=> safeName(a).localeCompare(safeName(b)));
    renderRows(out);
  }catch(e){
    console.error('search error', e);
    showError('Errore nella ricerca utenti.');
    renderRows([]);
  }finally{
    listLoad.style.display = 'none';
  }
}

onUser(async (u)=>{
  if(!u){ location.href = './login.html?from=./founder.html'; return; }
  const my = await getDoc(doc(db,'users',u.uid)).catch(()=>null);
  const myData = my && my.exists() ? my.data() : {};
  const allowed = (myData.role === 'founder') || await isFounder(u.email||'');
  who.textContent = allowed
    ? `Ciao ${myData.name || u.email} ‚Äî permessi Founder attivi.`
    : 'Accesso negato (solo Founder).';
  if(!allowed){ setTimeout(()=>location.href='./account-2.html', 1200); return; }

  await runStats();
  await loadLatest();

  btnReload.addEventListener('click', loadLatest);
  btnSearch.addEventListener('click', ()=>searchUsers(qInput.value));
  qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') searchUsers(qInput.value); });

  // Export CSV
  btnExportCSV?.addEventListener('click', async ()=>{
    try{
      btnExportCSV.disabled = true; btnExportCSV.textContent = 'Esporto‚Ä¶';
      const n = await exportUsersCSV();
      btnExportCSV.textContent = `Export (${n}) ‚úì`;
    }catch(e){
      console.error(e); showError('Export fallito (permessi/regole?).');
      btnExportCSV.textContent = 'Export CSV utenti';
    }finally{
      setTimeout(()=>{ btnExportCSV.disabled=false; btnExportCSV.textContent='Export CSV utenti'; },1000);
    }
  });
});
</script>
</body>
</html>
