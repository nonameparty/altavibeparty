<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Founder — TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12);--muted:rgba(255,255,255,.78)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:1100px;margin:auto;padding:22px}
h1{font-size:32px;font-weight:900;margin-bottom:8px}
h2{font-size:20px;font-weight:900}
.muted{color:var(--muted)}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:14px}
input,select{background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.grid2{display:grid;grid-template-columns:1fr auto;gap:10px}
.table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
.badge{display:inline-block;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
.small{font-size:12px}
.right{display:flex;gap:10px;align-items:center}
.notice{display:none;margin:10px 0;padding:12px;border-radius:10px;background:#2a0e0e;border:1px solid #ff6b6b;color:#ffdede}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
.modal .box{background:#0f0f10;border:1px solid var(--border);border-radius:14px;padding:16px;width:min(560px,92vw)}
.row{display:flex;gap:8px;margin-top:8px}
</style>
</head>
<body>
<main class="wrap">
  <h1>Pannello Founder</h1>
  <div id="who" class="muted">Verifica permessi…</div>

  <div id="errBanner" class="notice"></div>

  <div class="card" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <a href="./founder-gift.html" class="btn">Crea omaggio</a>
    <a href="./scanner.html" class="btn ghost">Scanner</a>
    <a href="./checkout.html" class="btn ghost">Nuovo ordine</a>
  </div>

  <section class="card">
    <div class="right" style="justify-content:space-between;">
      <h2>Gestione utenti</h2>
      <div class="right">
        <input id="q" placeholder="Cerca email o nome…" />
        <button id="btnSearch" class="btn">Cerca</button>
      </div>
    </div>
    <table class="table" id="tbl">
      <thead>
        <tr><th>Utente</th><th>Biglietti</th><th>Cronologia</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="empty" class="muted small" style="display:none;margin-top:8px">Nessun risultato.</div>
  </section>
</main>

<!-- Modale edit ticket -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="box">
    <h3 style="font-weight:900">Modifica nominativo (gratis staff)</h3>
    <div class="row"><input id="mName" placeholder="Nome e cognome" style="flex:1"></div>
    <div class="row"><input id="mDob"  type="date" style="flex:1"></div>
    <div class="row" style="justify-content:flex-end">
      <button id="mCancel" class="btn ghost">Annulla</button>
      <button id="mSave" class="btn">Salva & rigenera QR</button>
    </div>
  </div>
</div>

<script type="module">
import { app, onUser } from './auth.v2.js?v=6';
import { getFirestore, doc, getDoc, getDocs, collection, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = getFirestore(app);
const who = document.getElementById('who');
const tbody = document.querySelector('#tbl tbody');
const empty = document.getElementById('empty');
const qInput= document.getElementById('q');
const btnSearch=document.getElementById('btnSearch');
const modal = document.getElementById('modal');
const mName = document.getElementById('mName');
const mDob  = document.getElementById('mDob');
const mCancel = document.getElementById('mCancel');
const mSave   = document.getElementById('mSave');

let EDIT = null; // {uid, tid}

function lc(s){ return (s||'').toString().trim().toLowerCase(); }
async function isFounder(email, uid){
  try{
    const cfg = await getDoc(doc(db,'config','admins'));
    const role = await getDoc(doc(db,'users',uid));
    const r = role.exists()? (role.data().role||'') : '';
    const f = cfg.exists()? (cfg.data().founders||{}) : {};
    const a = cfg.exists()? (cfg.data().admins||{})   : {};
    return !!(f[lc(email)] || r==='founder' || a[lc(email)]);
  }catch{ return false; }
}

function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }

function rowTicket(uid, t){
  const state = (t.status||'pending').toLowerCase();
  const color = state==='verified'?'#22c55e':state==='flagged'?'#ef4444':'#ffffff55';
  const editBtn = `<button class="btn ghost small" data-edit="${uid}:${t.id}">Modifica</button>`;
  return `
    <div style="border:1px solid ${color};border-radius:10px;padding:8px;margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div><b>${t.type||'Ticket'}</b> — <span style="opacity:.85">${t.name||'—'} • ${(t.dob||'').toString().slice(0,10)||'—'}</span></div>
        <div style="display:flex;gap:6px;align-items:center">
          <span class="badge">${state}</span>
          ${editBtn}
        </div>
      </div>
    </div>
  `;
}

function renderUsers(list){
  tbody.innerHTML='';
  empty.style.display = list.length? 'none':'block';
  list.forEach(async u=>{
    // tickets
    const ts = await getDocs(collection(db,'users',u.uid,'tickets'));
    const tickets = [];
    ts.forEach(d=> tickets.push({ id:d.id, ...(d.data()||{}) }) );
    // cronologia (ordini)
    const os = await getDocs(collection(db,'users',u.uid,'orders')).catch(()=>({empty:true, forEach:()=>{}}));
    const orders=[];
    os.forEach(o=> orders.push({ id:o.id, ...(o.data()||{}) }) );

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="min-width:220px">
        <div><b>${u.name||'—'}</b></div>
        <div class="small" style="opacity:.8">${u.email||'—'}</div>
      </td>
      <td>${ tickets.length? tickets.map(t=>rowTicket(u.uid,t)).join('') : '<span class="small muted">Nessun ticket</span>' }</td>
      <td style="min-width:240px">
        ${
          orders.length
          ? orders.map(o=>`<div class="small" style="border-bottom:1px dashed rgba(255,255,255,.12);padding:6px 0">
              <div><b>${o.title||'Ordine'}</b> — ${o.total? (o.total.toFixed?o.total.toFixed(2):o.total) +'€':''}</div>
              <div style="opacity:.8">${o.createdAt? (new Date(o.createdAt.seconds*1000)).toLocaleString() : ''}</div>
            </div>`).join('')
          : '<span class="small muted">Nessun ordine</span>'
        }
      </td>
    `;
    tbody.appendChild(tr);
  });

  // bind edit
  tbody.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.onclick = async ()=>{
      const [uid, tid] = btn.getAttribute('data-edit').split(':');
      const snap = await getDoc(doc(db,'users',uid,'tickets',tid));
      if(!snap.exists()) return;
      const t = snap.data()||{};
      EDIT = { uid, tid };
      mName.value = t.name || '';
      mDob.value  = (t.dob||'').toString().slice(0,10) || '';
      openModal();
    };
  });
}

async function searchUsers(term){
  const snap = await getDocs(collection(db,'users'));
  const arr=[]; snap.forEach(d=> arr.push({ uid:d.id, ...(d.data()||{}) }) );
  const q = lc(term);
  const out = q
    ? arr.filter(u=> lc(u.email)==q || lc(u.name_lc||u.name||'').startsWith(q))
    : arr.slice(0,50);
  renderUsers(out);
}

onUser(async (u)=>{
  if(!u){ location.href='./login.html?from=./founder.html'; return; }
  const ok = await isFounder(u.email||'', u.uid);
  who.textContent = ok ? `Ciao ${u.email} — permessi Founder/Admin attivi.` : 'Accesso negato.';
  if(!ok){ setTimeout(()=>location.href='./account-2.html', 1200); return; }
  await searchUsers(''); // primi N
});

btnSearch.onclick = ()=> searchUsers(qInput.value);

mCancel.onclick = ()=> closeModal();
mSave.onclick = async ()=>{
  if(!EDIT) return;
  const { uid, tid } = EDIT;
  const name = mName.value.trim();
  const dob  = mDob.value;
  if(!name || !/^\d{4}-\d{2}-\d{2}$/.test(dob)){ alert('Compila correttamente.'); return; }
  const qr = JSON.stringify({ uid, tid, v:1 });
  await setDoc(doc(db,'users',uid,'tickets',tid), {
    name, dob, qr, locked:true, updatedAt: serverTimestamp()
  }, { merge:true });
  alert('Aggiornato.');
  closeModal(); location.reload();
};
</script>
</body>
</html>
