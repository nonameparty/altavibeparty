<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Founder — TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12);--muted:rgba(255,255,255,.78)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:1100px;margin:auto;padding:22px}
h1{font-size:32px;font-weight:900;margin-bottom:8px}
h2{font-size:20px;font-weight:900}
.muted{color:var(--muted)}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:14px}
input,select{background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.grid2{display:grid;grid-template-columns:1fr auto;gap:10px}
.table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
.badge{display:inline-block;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:3px 8px}
.right{display:flex;gap:10px;align-items:center}
.small{font-size:12px}
.center{display:flex;justify-content:center;align-items:center}
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<main class="wrap">
  <h1>Pannello Founder</h1>
  <div id="who" class="muted">Verifica permessi…</div>

  <section class="card">
    <div class="right">
      <h2>Statistiche rapide</h2>
      <div id="statLoad" class="spinner" aria-hidden="true"></div>
    </div>
    <div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px">
      <div class="badge">Utenti attivi: <span id="statActive">—</span></div>
      <div class="badge">Utenti totali: <span id="statTotal">—</span></div>
    </div>
  </section>

  <section class="card">
    <div class="right" style="justify-content:space-between;">
      <h2>Gestione utenti</h2>
      <div class="right">
        <button id="btnReload" class="btn ghost small">Carica ultimi</button>
        <div id="listLoad" class="spinner" aria-hidden="true" style="display:none"></div>
      </div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <input id="q" placeholder="Cerca per email o nome…" />
      <button id="btnSearch" class="btn">Cerca</button>
    </div>
    <table class="table" id="tbl">
      <thead>
        <tr><th>Nome</th><th>Email</th><th>Ruolo</th><th>Status</th><th>Azioni</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="empty" class="muted small" style="display:none;margin-top:8px">Nessun risultato.</div>
  </section>
</main>

<script type="module">
import { app, onUser } from './auth.v2.js?v=3';
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, getDocs, query, where, orderBy, limit
} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = getFirestore(app);

const who = document.getElementById('who');
const statActive = document.getElementById('statActive');
const statTotal  = document.getElementById('statTotal');
const statLoad   = document.getElementById('statLoad');

const qInput   = document.getElementById('q');
const btnSearch= document.getElementById('btnSearch');
const btnReload= document.getElementById('btnReload');
const tbody    = document.querySelector('#tbl tbody');
const emptyMsg = document.getElementById('empty');
const listLoad = document.getElementById('listLoad');

function lc(s){ return (s||'').toString().trim().toLowerCase(); }

async function isFounder(email){
  try{
    const snap = await getDoc(doc(db,'config','admins'));
    if(!snap.exists()) return false;
    const founders = snap.data()?.founders || {};
    return founders[lc(email)] === true;
  }catch(_){ return false; }
}

function renderRows(users){
  tbody.innerHTML = '';
  emptyMsg.style.display = users.length ? 'none' : 'block';

  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.name || '—'}</td>
      <td>${u.email || '—'}</td>
      <td>
        <select data-uid="${u.uid}" class="roleSel">
          ${['customer','pr','admin','founder'].map(r=>`<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`).join('')}
        </select>
      </td>
      <td>
        <select data-uid="${u.uid}" class="statusSel">
          ${['active','suspended','deleted'].map(s=>`<option value="${s}" ${u.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td><button class="btn ghost small" data-save="${u.uid}">Salva</button></td>
    `;
    tbody.appendChild(tr);
  });

  // Bind salvataggi
  tbody.querySelectorAll('button[data-save]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const uid = btn.getAttribute('data-save');
      const role = tbody.querySelector(`select.roleSel[data-uid="${uid}"]`).value;
      const status = tbody.querySelector(`select.statusSel[data-uid="${uid}"]`).value;
      btn.disabled = true; btn.textContent = 'Salvo…';
      try{
        await setDoc(doc(db,'users',uid), { role, status }, { merge:true });
        btn.textContent = 'Salvato ✓';
      }catch(e){
        console.error(e);
        btn.textContent = 'Errore';
      }finally{
        setTimeout(()=>{ btn.textContent='Salva'; btn.disabled=false; }, 1000);
      }
    });
  });
}

async function runStats(){
  statLoad.style.display = 'inline-block';
  try{
    const all = await getDocs(collection(db,'users'));
    let active=0;
    all.forEach(d=>{ if(lc(d.data().status||'active')==='active') active++; });
    statActive.textContent = active;
    statTotal.textContent  = all.size;
  }catch(e){ console.error(e); }
  statLoad.style.display = 'none';
}

async function loadLatest(){
  listLoad.style.display = 'inline-block';
  try{
    let list = [];
    // prova a ordinare per createdAt
    try{
      const q1 = query(collection(db,'users'), orderBy('createdAt','desc'), limit(50));
      const snap1 = await getDocs(q1);
      snap1.forEach(d=>list.push({uid:d.id, ...d.data()}));
    }catch(_){
      // fallback: prendi tutto e ordina localmente per name_lc
      const snap2 = await getDocs(collection(db,'users'));
      snap2.forEach(d=>list.push({uid:d.id, ...d.data()}));
      list.sort((a,b)=> lc(a.name_lc||a.name).localeCompare(lc(b.name_lc||b.name)));
      list = list.slice(0,50);
    }
    renderRows(list);
  }catch(e){
    console.error(e);
    renderRows([]);
  }
  listLoad.style.display = 'none';
}

async function searchUsers(qs){
  const term = lc(qs);
  if(!term){ renderRows([]); return; }
  listLoad.style.display = 'inline-block';

  const out = [];
  try{
    // 1) by email (exact, case-insensitive: confrontiamo in lowercase)
    const allForEmail = await getDocs(collection(db,'users'));
    allForEmail.forEach(d=>{
      const v=d.data(); if(lc(v.email)===term) out.push({uid:d.id, ...v});
    });

    // 2) by name prefix
    const snap = await getDocs(collection(db,'users'));
    snap.forEach(d=>{
      const v=d.data();
      if(lc(v.name_lc||v.name||'').startsWith(term)) out.push({uid:d.id, ...v});
    });

    // dedup
    const seen = new Set();
    const list = out.filter(x=>{ if(seen.has(x.uid)) return false; seen.add(x.uid); return true; });
    renderRows(list);
  }catch(e){
    console.error(e);
    renderRows([]);
  }
  listLoad.style.display = 'none';
}

onUser(async (u)=>{
  if(!u){ location.href = './login.html?from=./founder.html'; return; }

  // verifica permesso founder
  let allowed = false;
  try{
    const uDoc = await getDoc(doc(db,'users',u.uid));
    const data = uDoc.exists() ? uDoc.data() : {};
    allowed = (data.role === 'founder') || await isFounder(u.email||'');
    who.textContent = allowed
      ? `Ciao ${data.name || u.email} — hai pieni poteri Founder.`
      : 'Accesso negato (solo Founder).';
  }catch(_){
    allowed = await isFounder(u.email||'');
    who.textContent = allowed ? `Ciao ${u.email} — hai pieni poteri Founder.` : 'Accesso negato (solo Founder).';
  }
  if(!allowed){ setTimeout(()=>location.href='./account-2.html', 1200); return; }

  await runStats();
  await loadLatest();

  btnReload.addEventListener('click', loadLatest);
  btnSearch.addEventListener('click', ()=>searchUsers(qInput.value.trim()));
  qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnSearch.click(); });
});
</script>
</body>
</html>
