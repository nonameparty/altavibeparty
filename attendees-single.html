<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conferma dati — 1 biglietto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#000;--text:#fff;--muted:rgba(255,255,255,.78);--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--accent:#8b5cf6;--ok:#22c55e}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:900px;margin:0 auto;padding:24px}
h1{font-size:28px;font-weight:900;letter-spacing:-.2px;margin-bottom:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin:12px 0}
.row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.total{font-size:22px;font-weight:900}
label{display:block;margin:8px 0 4px;font-weight:700}
input{width:100%;background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.small{font-size:13px;color:var(--muted)}
.badge{display:inline-block;background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:13px;margin-right:6px}
.save{color:var(--ok);font-weight:800}
.err{border-color:#ef4444 !important;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
</style>
</head>
<body>
<main class="wrap">
  <h1>Conferma dati — <strong>1 biglietto</strong></h1>

  <!-- DATI PARTECIPANTE -->
  <section class="card">
    <div style="font-weight:900;margin-bottom:6px">Dati del partecipante</div>
    <div class="grid">
      <div>
        <label>Nome</label>
        <input id="fn" placeholder="Es. Mario">
      </div>
      <div>
        <label>Cognome</label>
        <input id="ln" placeholder="Es. Rossi">
      </div>
    </div>
    <label style="margin-top:8px">Email (per invio biglietto)</label>
    <input id="em" type="email" placeholder="mario.rossi@email.it">
    <div class="small" style="margin-top:8px">
      I dati devono coincidere col documento mostrato all’ingresso.
    </div>
  </section>

  <!-- RIEPILOGO -->
  <aside class="card" id="summary">
    <div class="badge">Sab 21 Mar 2026</div>
    <div class="badge">22:30 → 04:30</div>
    <div class="badge">Via Italia 38, Biella</div>

    <div id="lines" style="margin-top:8px"></div>
    <div class="hr"></div>
    <div class="row total"><div>Totale (IVA inclusa)</div><div id="grand">0€</div></div>

    <div class="small" style="margin-top:10px">
      Se la persona indicata non è ancora registrata, potrà farlo dopo l’acquisto:
      invieremo un link per completare la registrazione e i biglietti saranno già visibili nella sua area personale.
    </div>

    <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
      <button class="btn ghost" id="back">Indietro</button>
      <button class="btn" id="pay">Paga ora</button>
    </div>
  </aside>
</main>

<script type="module">
import { onUser } from './auth.v2.js?v=6';

const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90 };
const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '€';
const $ = s => document.querySelector(s);

/* ====== leggi carrello e sconto applicato ====== */
function readCart(){
  try{ return JSON.parse(localStorage.getItem('trapperreo_cart')||'null')||{}; }catch{ return {}; }
}
function readApplied(){ try{ return JSON.parse(localStorage.getItem('trapperreo_discount_applied')||'null'); }catch{ return null; } }

const qs = new URLSearchParams(location.search);
const qty = {
  EB: +(qs.get('eb')||0)   || (readCart().eb|0),
  STD:+(qs.get('std')||0)  || (readCart().std|0),
  FAST:+(qs.get('fast')||0)|| (readCart().fast|0),
  VIP: +(qs.get('vip')||0) || (readCart().vip|0),
};
const nameProt = (+(qs.get('nc')||0) || (readCart().nc|0)) === 1;
const order = ['EB','STD','FAST','VIP'];
let sku = order.find(k=>(qty[k]||0)>0) || 'STD';
const base = PRICE[sku];

/* ====== prefill dati acquirente ====== */
onUser(u=>{
  if(!u) return;
  const parts=(u.displayName||'').trim().split(' ');
  document.getElementById('fn').value = parts[0]||'';
  document.getElementById('ln').value = parts.slice(1).join(' ')||'';
  document.getElementById('em').value = (u.email||'');
});

/* ====== calcolo con sconto ====== */
function allowedSet(snap){
  return (Array.isArray(snap?.allowedSkus) && snap.allowedSkus.length>0) ? snap.allowedSkus : ['EB','STD','FAST','VIP'];
}
function compute(){
  const snap = readApplied(); // {code,type,value,allowedSkus}
  let disc = 0, tag=null;
  if(snap && allowedSet(snap).includes(sku)){
    if(snap.type==='percent') disc = Math.max(0, base*(snap.value/100));
    else if(snap.type==='fixed') disc = Math.max(0, Math.min(base, snap.value));
    tag = `${snap.code} — ${snap.type==='percent' ? '%'+snap.value : '−'+money(snap.value)}`;
  }
  const prot = nameProt ? PRICE.NAMECHANGE : 0;
  const net  = Math.max(0, base - disc) + prot;
  return {disc, prot, net, tag};
}
function label(k){ return {EB:'Early Bird',STD:'Standard',FAST:'Fast Entry',VIP:'VIP Entry'}[k]||'Biglietto'; }

function render(){
  const {disc,prot,net,tag} = compute();
  const L = document.getElementById('lines');
  const rows=[];
  rows.push(`<div class="row"><div id="ticketLine">${label(sku)} × 1</div><div>${money(base)}</div></div>`);
  if(tag) rows.push(`<div class="row save"><div>Sconto (${tag})</div><div>- ${money(disc)}</div></div>`);
  if(nameProt) rows.push(`<div class="row"><div>Protezione cambio nome</div><div>${money(prot)}</div></div>`);
  L.innerHTML = rows.join('');
  document.getElementById('grand').textContent = money(net);
}

/* ====== validazione ====== */
function isEmail(v){ return /^\S+@\S+\.\S+$/.test((v||'').trim()); }
function validate(){
  const fn=$('#fn'), ln=$('#ln'), em=$('#em'); let ok=true;
  [fn,ln,em].forEach(i=>i.classList.remove('err'));
  if(!fn.value.trim()){ fn.classList.add('err'); ok=false; }
  if(!ln.value.trim()){ ln.classList.add('err'); ok=false; }
  if(!isEmail(em.value)){ em.classList.add('err'); ok=false; }
  return ok;
}

/* ====== bind ====== */
document.getElementById('back').addEventListener('click', ()=>history.back());
document.getElementById('pay').addEventListener('click', ()=>{ if(!validate()) return; alert('Pagamento avviato (simulazione).'); });

render();
</script>
</body>
</html>
