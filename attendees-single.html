<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conferma dati — 1 biglietto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#000;--text:#fff;--muted:rgba(255,255,255,.78);--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--accent:#8b5cf6;--ok:#22c55e}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:900px;margin:0 auto;padding:24px}
h1{font-size:28px;font-weight:900;letter-spacing:-.2px;margin-bottom:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin:12px 0}
.row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.total{font-size:22px;font-weight:900}
label{display:block;margin:8px 0 4px;font-weight:700}
input{width:100%;background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.small{font-size:13px;color:var(--muted)}
.badge{display:inline-block;background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:13px;margin-right:6px}
.save{color:var(--ok);font-weight:800}
.err{border-color:#ef4444 !important;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
</style>
</head>
<body>
<main class="wrap">
  <h1>Conferma dati — <strong>1 biglietto</strong></h1>

  <!-- DATI PARTECIPANTE -->
  <section class="card">
    <div style="font-weight:900;margin-bottom:6px">Dati del partecipante</div>
    <div class="grid">
      <div>
        <label>Nome</label>
        <input id="fn" placeholder="Es. Mario">
      </div>
      <div>
        <label>Cognome</label>
        <input id="ln" placeholder="Es. Rossi">
      </div>
    </div>
    <label style="margin-top:8px">Email (per invio biglietto)</label>
    <input id="em" type="email" placeholder="mario.rossi@email.it">
    <div class="small" style="margin-top:8px">
      I dati devono coincidere col documento mostrato all’ingresso.
    </div>
  </section>

  <!-- RIEPILOGO -->
  <aside class="card" id="summary">
    <div class="badge">Sab 21 Mar 2026</div>
    <div class="badge">22:30 → 04:30</div>
    <div class="badge">Via Italia 38, Biella</div>

    <div id="lines" style="margin-top:8px"></div>
    <div class="hr"></div>
    <div class="row total"><div>Totale (IVA inclusa)</div><div id="grand">0€</div></div>

    <div style="display:flex;gap:10px;margin-top:14px;justify-content:flex-end">
      <button class="btn ghost" id="back">Indietro</button>
      <button class="btn" id="pay">Paga ora</button>
    </div>
  </aside>
</main>

<script type="module">
/* ======= Config prezzi (come checkout) ======= */
const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90 };

/* ======= helpers UI ======= */
const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '€';
const $ = s => document.querySelector(s);

/* ======= Lettura carrello + sconto “fotografato” dal checkout ======= */
function readCart(){
  try{ return JSON.parse(localStorage.getItem('trapperreo_cart')||'null')||{}; }catch{ return {}; }
}
function readDiscountSnapshot(){
  // priorità: applied → discount → snapshot
  const raw = localStorage.getItem('trapperreo_discount_applied')
        || localStorage.getItem('trapperreo_discount')
        || localStorage.getItem('trapperreo_discount_snapshot');
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}

/* Normalizzo struttura sconto attesa:
  {
    code:"OPENING10",
    type:"percent"|"fixed",
    value:10,
    active:true,
    allowedSkus:["EB","STD","FAST","VIP"], // opzionale (assente = tutte)
    scope:"all"|"user",
    userEmail:"..." // se scope=user
  }
*/
function normalizeDiscount(d){
  if(!d) return null;
  const out = {
    code: (d.code||d.Code||d.name||'').toString().trim(),
    type: (d.type||d.kind||'').toString().toLowerCase(),  // 'percent' | 'fixed'
    value: Number(d.value ?? d.amount ?? 0),
    active: (d.active ?? d.enabled ?? true) === true,
    scope: (d.scope||'all'),
    userEmail: (d.userEmail||d.email||'')?.toLowerCase?.() || '',
    allowedSkus: Array.isArray(d.allowedSkus)? d.allowedSkus
                 : Array.isArray(d.skus)? d.skus
                 : null
  };
  if(!out.code || !out.active || !out.type || !(out.value>0)) return null;
  return out;
}

/* Carico quantità da query o da localStorage */
const qs = new URLSearchParams(location.search);
const qty = {
  EB: +(qs.get('eb')||0) || (readCart().eb|0),
  STD:+(qs.get('std')||0) || (readCart().std|0),
  FAST:+(qs.get('fast')||0) || (readCart().fast|0),
  VIP: +(qs.get('vip')||0) || (readCart().vip|0),
};
const nameProt = (+(qs.get('nc')||0) || (readCart().nc|0)) === 1;

/* Individuo SKU singolo (fallback STD) */
const order = ['EB','STD','FAST','VIP'];
let sku = order.find(k => (qty[k]||0)>0) || 'STD';
const base = PRICE[sku];

/* ======= Applicazione sconto ======= */
function discountEligible(dis, emailLower){
  if(!dis) return false;
  if(dis.scope === 'user' && dis.userEmail && dis.userEmail !== (emailLower||'')) return false;
  return true;
}
function computeTotals(){
  const dSnap = normalizeDiscount(readDiscountSnapshot());
  const allowed = dSnap?.allowedSkus || ['EB','STD','FAST','VIP'];

  // prezzo lordo 1 pezzo
  const gross = base;

  // sconto (se cod valido e sku permesso)
  let disc = 0;
  if(dSnap && allowed.includes(sku)){
    if(dSnap.type === 'percent') disc = Math.max(0, Math.min(gross, gross * (dSnap.value/100)));
    else if(dSnap.type === 'fixed') disc = Math.max(0, Math.min(gross, dSnap.value));
  }
  const prot = nameProt ? PRICE.NAMECHANGE : 0;
  const net = Math.max(0, gross - disc) + prot;

  return { dSnap, gross, disc, prot, net };
}

/* ======= Rendering ======= */
function render(){
  const L = $('#lines'); const {dSnap,gross,disc,prot,net} = computeTotals();
  const rows = [
    `<div class="row"><div>${skuLabel(sku)} × 1</div><div>${money(gross)}</div></div>`
  ];
  if(dSnap && disc>0){
    rows.push(`<div class="row save"><div>Sconto (${dSnap.code})</div><div>-${money(disc)}</div></div>`);
  }
  if(nameProt){
    rows.push(`<div class="row"><div>Protezione cambio nome</div><div>${money(prot)}</div></div>`);
  }
  L.innerHTML = rows.join('');
  $('#grand').textContent = money(net);
}
function skuLabel(k){
  return {EB:'Early Bird', STD:'Standard', FAST:'Fast Entry', VIP:'VIP Entry'}[k] || 'Biglietto';
}

/* ======= Validazione nominativo ======= */
function isEmail(v){ return /^\S+@\S+\.\S+$/.test((v||'').trim()); }
function validateForm(){
  const fn=$('#fn'), ln=$('#ln'), em=$('#em'); let ok=true;
  [fn,ln,em].forEach(i=>i.classList.remove('err'));
  if(!fn.value.trim()){ fn.classList.add('err'); ok=false; }
  if(!ln.value.trim()){ ln.classList.add('err'); ok=false; }
  if(!isEmail(em.value)){ em.classList.add('err'); ok=false; }
  return ok;
}

/* ======= Bind ======= */
$('#back').addEventListener('click', ()=>history.back());
$('#pay').addEventListener('click', ()=>{
  if(!validateForm()) return;
  alert('Pagamento avviato (simulazione).');
});

/* init */
render();
</script>
</body>
</html>
