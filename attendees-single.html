<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Assegna nominativo — 1 biglietto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12);--card:rgba(255,255,255,.06);--muted:rgba(255,255,255,.78)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:900px;margin:auto;padding:20px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:14px}
.line{display:flex;justify-content:space-between;margin:6px 0}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.total{font-size:20px;font-weight:900}
.badge{border:1px solid var(--border);border-radius:8px;padding:2px 6px;font-size:12px}
.small{font-size:12px;color:var(--muted)}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
</style>
</head>
<body>
<main class="wrap">
  <h1>Conferma dati — 1 biglietto</h1>

  <section class="card">
    <div id="summary"></div>
    <div class="hr"></div>
    <div class="line total"><span>Totale</span><strong id="tot">0€</strong></div>
    <div class="small" id="discInfo"></div>
    <div style="margin-top:12px"><button class="btn" id="pay">Paga ora</button></div>
  </section>
</main>

<script type="module">
import { app } from './auth.v2.js?v=6';
import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';
const db=getFirestore(app);

const PRICE={EB:12,STD:15,FAST:20,VIP:25,NAMECHANGE:1.90,STD3:40};
const qs = new URLSearchParams(location.search);
const cart = JSON.parse(localStorage.getItem('trapperreo_cart')||'{}');
const codeSaved = (localStorage.getItem('trapperreo_discount_code')||'').toUpperCase();

const qty = {EB:+(qs.get('eb')||0), STD:+(qs.get('std')||0), FAST:+(qs.get('fast')||0), VIP:+(qs.get('vip')||0)};
const nameProt = Number(qs.get('nc')||0)===1;

function money(n){ const v=Math.max(0,Math.round(n*100)/100); return (v.toFixed(2).replace('.00',''))+'€'; }

function eligibleSubtotal(q, allowed){
  let sub=0;
  if(allowed.includes('EB'))   sub += q.EB   * PRICE.EB;
  if(allowed.includes('STD')){ const bundles=Math.floor(q.STD/3); const rem=q.STD%3; sub += bundles*PRICE.STD3 + rem*PRICE.STD; }
  if(allowed.includes('FAST')) sub += q.FAST * PRICE.FAST;
  if(allowed.includes('VIP'))  sub += q.VIP  * PRICE.VIP;
  return sub;
}

let discounts=[];
async function loadDiscounts(){
  const snap = await getDocs(collection(db,'discountCodes'));
  snap.forEach(d=>{
    const v=d.data()||{};
    if(v.active===true && v.code){
      discounts.push({code:String(v.code).toUpperCase(), type:v.type, amount:Number(v.amount||0), appliesTo:v.appliesTo||'all', userEmail:(v.userEmail||'').toLowerCase(), allowedSkus:(v.allowedSkus&&v.allowedSkus.length)?v.allowedSkus:['EB','STD','FAST','VIP']});
    }
  });
}
function findCode(name, email){
  const C=(name||'').toUpperCase().trim(); if(!C) return null;
  const mine = discounts.find(x=>x.code===C && x.appliesTo==='user' && (email||'').toLowerCase()===x.userEmail);
  if(mine) return mine;
  return discounts.find(x=>x.code===C && x.appliesTo==='all')||null;
}

async function render(){
  await loadDiscounts();
  const email = (cart?.meEmail||localStorage.getItem('trapperreo_me_email')||'').toLowerCase(); // facoltativo
  const d = findCode(codeSaved, email);

  let subtotal=0; const rows=[];
  const add=(l,v)=>{ rows.push(`<div class="line"><span>${l}</span><span>${money(v)}</span></div>`); subtotal+=v; };

  if(qty.EB>0)   add(`Early Bird × ${qty.EB}`, qty.EB*PRICE.EB);
  if(qty.STD>0){ const b=Math.floor(qty.STD/3), r=qty.STD%3; add(`Standard × ${qty.STD}`, b*PRICE.STD3 + r*PRICE.STD); }
  if(qty.FAST>0) add(`Fast Entry × ${qty.FAST}`, qty.FAST*PRICE.FAST);
  if(qty.VIP>0)  add(`VIP Entry × ${qty.VIP}`,  qty.VIP*PRICE.VIP);

  const tickets = qty.EB+qty.STD+qty.FAST+qty.VIP;
  if(nameProt && tickets>0) add(`Protezione cambio nome × ${tickets}`, tickets*PRICE.NAMECHANGE);

  if(d){
    const elig = eligibleSubtotal(qty, d.allowedSkus);
    let discount = elig>0 ? (d.type==='percent' ? elig*(d.amount/100) : d.amount) : 0;
    discount = Math.min(discount, subtotal);
    if(discount>0){ add(`Sconto (${d.code})`, -discount); document.getElementById('discInfo').innerHTML=`Codice <strong>${d.code}</strong> applicato su ${d.allowedSkus.map(s=>`<span class="badge">${s}</span>`).join(' ')}`; }
  }

  document.getElementById('summary').innerHTML = rows.join('');
  document.getElementById('tot').textContent = money(subtotal);
}

render();
document.getElementById('pay').addEventListener('click', ()=> alert('Pagamento placeholder — totale: '+document.getElementById('tot').textContent));
</script>
</body>
</html>
