<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conferma dati — 1 biglietto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
  :root{--bg:#000;--text:#fff;--card:#0c0c0f;--border:rgba(255,255,255,.12);--accent:#8b5cf6;--ok:#22c55e}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,sans-serif}
  .wrap{max-width:900px;margin:auto;padding:22px}
  h1{font-size:28px;font-weight:900;letter-spacing:-.2px;margin:8px 0 14px}
  .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .field{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .field input{width:100%;background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:12px}
  .line{display:flex;justify-content:space-between;margin:6px 0;font-size:14px}
  .total{font-size:22px;font-weight:900;margin-top:8px}
  .btn{background:var(--accent);color:#000;border:none;border-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer}
  .ghost{background:transparent;border:1px solid var(--border);color:#fff}
  .muted{opacity:.8;font-size:13px}
  .save{color:var(--ok);font-weight:800}
  .hr{height:1px;background:var(--border);margin:12px 0}
</style>
</head>
<body>
  <main class="wrap">
    <h1>Conferma dati — 1 biglietto</h1>
    <div class="grid">
      <section class="card">
        <h3 style="margin:0 0 8px 0;font-size:14px;opacity:.9" id="ticketLabel">Early Bird × 1</h3>
        <div class="field">
          <div><input id="first" placeholder="Nome"></div>
          <div><input id="last" placeholder="Cognome"></div>
        </div>
        <div class="field" style="grid-template-columns:1fr">
          <div><input id="email" placeholder="email@email.it" inputmode="email"></div>
        </div>
      </section>

      <aside class="card">
        <div class="muted" id="eventMeta">Sab 21 Mar 2026 · 22:30 → 04:30 · Via Italia 38, Biella</div>
        <div class="hr"></div>
        <div id="summaryLines"></div>
        <div class="total">Totale (IVA inclusa) <span id="grand">0€</span></div>
        <div class="hr"></div>
        <div class="muted" style="margin-bottom:10px">
          Se non hai un account, potrai registrarti dopo l’acquisto: ti invieremo un link e il biglietto
          sarà già visibile nella tua area personale.
        </div>
        <div style="display:flex;gap:8px">
          <button id="backBtn" class="btn ghost">Indietro</button>
          <button id="payBtn" class="btn">Paga ora</button>
        </div>
      </aside>
    </div>
  </main>

<script type="module">
import { onUser } from './auth.v2.js?v=6';

const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90, STD3:40 };
const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '€';

/* === capisco quale biglietto è stato scelto dal QS === */
const Q = new URLSearchParams(location.search);
const qty = {
  eb: +(Q.get('eb')||0),
  std:+(Q.get('std')||0),
  fast:+(Q.get('fast')||0),
  vip:+(Q.get('vip')||0),
  nc: +(Q.get('nc')||0)
};
const kind = qty.eb? 'EB' : qty.std? 'STD' : qty.fast? 'FAST' : 'VIP';
document.getElementById('ticketLabel').textContent =
  (kind==='EB'?'Early Bird':kind==='STD'?'Standard':kind==='FAST'?'Fast Entry':'VIP Entry') + ' × 1';

/* === sconto da localStorage === */
function readDiscount(){
  try{ return JSON.parse(localStorage.getItem('trapperreo_discount_applied')||'null'); }catch{ return null; }
}
const discountSnap = readDiscount();

/* === precompila con i dati dell'utente loggato === */
onUser(u=>{
  if(!u) return;
  const [f,l] = (u.displayName||'').split(' ');
  document.getElementById('first').value = f || '';
  document.getElementById('last').value  = l || '';
  document.getElementById('email').value = u.email || '';
});

/* === calcolo totale + sconto === */
function parts(){
  return {
    EB: qty.eb ? PRICE.EB : 0,
    STD: qty.std ? PRICE.STD : 0,
    FAST: qty.fast? PRICE.FAST: 0,
    VIP: qty.vip ? PRICE.VIP : 0
  };
}
function computeDiscount(d, p){
  if(!d) return 0;
  const allow = (d.allowedSkus && d.allowedSkus.length? d.allowedSkus : ['EB','STD','FAST','VIP']);
  const base = (allow.includes('EB')?p.EB:0)+(allow.includes('STD')?p.STD:0)+(allow.includes('FAST')?p.FAST:0)+(allow.includes('VIP')?p.VIP:0);
  if(d.type==='percent') return Math.max(0, +(base*(d.value/100)).toFixed(2));
  if(d.type==='fixed')   return Math.max(0, Math.min(base, d.value));
  return 0;
}

const summaryLines = document.getElementById('summaryLines');
const grand = document.getElementById('grand');

function render(){
  const p = parts();
  const gross = p.EB+p.STD+p.FAST+p.VIP;
  const disc = computeDiscount(discountSnap, p);
  const prot = qty.nc ? PRICE.NAMECHANGE : 0;
  const tot  = Math.max(0, gross - disc) + prot;

  const L=[];
  if(qty.eb)   L.push(`<div class="line"><span>Early Bird × 1</span><span>${money(p.EB)}</span></div>`);
  if(qty.std)  L.push(`<div class="line"><span>Standard × 1</span><span>${money(p.STD)}</span></div>`);
  if(qty.fast) L.push(`<div class="line"><span>Fast Entry × 1</span><span>${money(p.FAST)}</span></div>`);
  if(qty.vip)  L.push(`<div class="line"><span>VIP Entry × 1</span><span>${money(p.VIP)}</span></div>`);
  if(discountSnap){
    const tag = `${discountSnap.code} — ${discountSnap.type==='percent' ? '%'+discountSnap.value : '−'+money(discountSnap.value)}`;
    L.push(`<div class="line" style="color:#22c55e;font-weight:800"><span>Sconto (${tag})</span><span>- ${money(disc)}</span></div>`);
  }
  if(prot>0){
    L.push(`<div class="line"><span>Protezione cambio nome × 1</span><span>${money(prot)}</span></div>`);
  }
  summaryLines.innerHTML = L.join('');
  grand.textContent = money(tot);
}
render();

/* === Bottoni === */
document.getElementById('backBtn').addEventListener('click', ()=>history.back());
document.getElementById('payBtn').addEventListener('click', ()=>{
  // TODO: integrare pagamento
  alert('Pagamento: placeholder');
});
</script>
</body>
</html>
