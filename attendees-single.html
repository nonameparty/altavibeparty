<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ultimo passaggio — TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000; --text:#fff; --accent:#8b5cf6; --border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.06); --muted:rgba(255,255,255,.78); --ok:#22c55e;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1100px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}

.wrap{max-width:800px;margin:auto;padding:24px}
h1{font-size:28px;font-weight:900;letter-spacing:-.2px}
.sub{color:var(--muted);margin-top:6px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:16px}
.badge{display:inline-block;background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:13px;margin-right:8px}
.row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.total{font-size:22px;font-weight:900}
.muted{color:var(--muted)}
.pay{display:inline-block;padding:12px 16px;border-radius:10px;text-decoration:none;font-weight:900;background:var(--accent);color:#000;border:none;cursor:pointer}
.btn-outline{background:transparent;border:1px solid var(--border);color:#fff}
.actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
.info{font-size:13px;line-height:1.4;background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.3);border-radius:12px;padding:12px;margin-top:12px}
.link{color:#b49afc;cursor:pointer;text-decoration:underline}
.checkbox{display:flex;align-items:center;gap:8px;cursor:pointer}
.checkbox input{width:18px;height:18px}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav><a href="./index.html">Home</a></nav>
  </div>
</header>

<main class="wrap">
  <h1>Ultimo passaggio</h1>
  <div class="sub" id="hello">Ciao <strong>ospite</strong>, conferma e paga.</div>

  <div class="card">
    <div class="row">
      <div id="summaryTitle" style="font-weight:900">Stai acquistando:</div>
      <div class="badge" id="ticketBadge">—</div>
    </div>
    <div class="row">
      <div class="muted">Totale attuale</div>
      <div class="total" id="totalNow">0€</div>
    </div>

    <div class="hr"></div>

    <label class="checkbox">
      <input type="checkbox" id="nameProt">
      <span><strong>Aggiungi Protezione cambio nome</strong> (+<span id="feeLbl">1,90€</span>)</span>
    </label>
    <div class="muted" style="margin-top:6px">
      1,90€ / biglietto ti consente di cambiare il nominativo <strong>1 volta</strong> fino a <strong>48h</strong> dall’evento.
      <span id="ctaReenable" class="link" style="display:none">Torna ad attivarla</span>
    </div>

    <div class="info" id="idNote">
      Ricorda: nome e cognome devono coincidere con il <strong>documento d’identità</strong> che verrà richiesto all’ingresso.
      Se l’ospite deve ancora registrarsi, usa lo stesso nome/cognome in registrazione.
    </div>

    <div class="hr"></div>
    <div class="row total">
      <div>Totale (IVA inclusa)</div>
      <div id="grandTot">0€</div>
    </div>

    <div class="actions">
      <a class="pay btn-outline" id="backBtn">Indietro</a>
      <button class="pay" id="payBtn">Paga ora</button>
    </div>
  </div>
</main>

<script type="module">
import { onUser } from './auth.v2.js?v=3';

const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90 };

const hello = document.getElementById('hello');
onUser(u=>{
  if(u){
    const name=(u.displayName||u.email||'ospite').split(' ')[0];
    hello.innerHTML = `Ciao <strong>${name}</strong>, conferma e paga.`;
  }
});

function money(n){ return n.toFixed(2).replace('.00','')+'€'; }

function readCart(){
  try { return JSON.parse(localStorage.getItem('trapperreo_cart')||'null') || {}; }
  catch { return {}; }
}
function writeCart(c){ localStorage.setItem('trapperreo_cart', JSON.stringify(c)); }

const cart = readCart();
// individua quale biglietto è stato scelto (totale 1)
const map = [
  ['eb','Early Bird','EB'],
  ['std','Standard','STD'],
  ['fast','Fast Entry','FAST'],
  ['vip','VIP Entry','VIP'],
];
let skuKey = null, label = '', price = 0;
for(const [k,lab,code] of map){
  if((cart[k]||0) > 0){ skuKey=k; label=lab; price=PRICE[code]; break; }
}
if(!skuKey){ // fallback
  skuKey='std'; label='Standard'; price=PRICE.STD;
}

const summaryTitle = document.getElementById('summaryTitle');
const ticketBadge = document.getElementById('ticketBadge');
const totalNow    = document.getElementById('totalNow');
const grandTot    = document.getElementById('grandTot');
const nameProt    = document.getElementById('nameProt');
const feeLbl      = document.getElementById('feeLbl');
const backBtn     = document.getElementById('backBtn');
const payBtn      = document.getElementById('payBtn');
const ctaReenable = document.getElementById('ctaReenable');

feeLbl.textContent = money(PRICE.NAMECHANGE);

// stato iniziale: se nel checkout avevi già attivato la protezione, rispettiamo
nameProt.checked = cart.nc === 1;

// UI iniziale
ticketBadge.textContent = label;
summaryTitle.innerHTML = `Stai acquistando: <strong>${label}</strong>`;
totalNow.textContent = money(price);

// mostra link “Torna ad attivarla” solo se non è spuntata
function toggleReenable(){
  ctaReenable.style.display = nameProt.checked ? 'none' : 'inline';
}
toggleReenable();

function renderTotals(){
  const extra = nameProt.checked ? PRICE.NAMECHANGE : 0;
  grandTot.textContent = money(price + extra);
}
renderTotals();

// handler checkbox
nameProt.addEventListener('change', ()=>{
  // scrive subito nel carrello per mantenerlo coerente se torni indietro
  cart.nc = nameProt.checked ? 1 : 0;
  writeCart(cart);
  toggleReenable();
  renderTotals();
});

// click "Torna ad attivarla"
ctaReenable.addEventListener('click', ()=>{
  nameProt.checked = true;
  cart.nc = 1; writeCart(cart);
  toggleReenable();
  renderTotals();
});

// Indietro → torna al checkout (stato preservato)
backBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  // Manteniamo quantità e nc nello storage (già aggiornato dagli handler)
  location.href = './checkout.html';
});

// Paga ora (simulazione)
payBtn.addEventListener('click', ()=>{
  // qui integrerai il provider di pagamento; per ora simulazione
  alert('Pagamento avviato (simulazione).');
});
</script>
</body>
</html>
