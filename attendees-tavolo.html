<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prenota Tavolo â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#0a0a0a; --text:#fff; --accent:#8b5cf6; --border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.06); --muted:rgba(255,255,255,.78);
  --gold:#f5c542; --silver:#9fb7ff; --classic:#d1a56d;
  --danger:#ef4444; --ok:#22c55e;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
header{position:sticky;top:0;z-index:30;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}

.wrap{max-width:1200px;margin:auto;padding:20px}
h1{font-size:28px;font-weight:900;letter-spacing:-.2px}
h2{font-size:20px;font-weight:900;margin:14px 0 8px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:14px}
.grid{display:grid;gap:16px}
@media(min-width:1020px){.grid-2{grid-template-columns:1.1fr 1fr}}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.btn{display:inline-block;padding:12px 16px;border-radius:12px;font-weight:900;border:1px solid var(--border);background:#161616;color:#fff;cursor:pointer}
.btn.primary{background:var(--accent);color:#000;border:none}
.btn.ghost{background:transparent}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:12px;border:1px solid var(--border);font-size:12px}

/* tabs tavoli */
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer}
.tab.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,.25)}

/* legenda compatta */
.legend{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 4px}
.legend .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:10px;border:1px solid var(--border)}
.legend .dot{width:10px;height:10px;border-radius:999px}

/* contatore persone grande */
.counter{display:inline-flex;border:1px solid var(--border);border-radius:14px;overflow:hidden}
.counter button{width:52px;height:52px;background:#161616;border:none;color:#fff;font-weight:900;font-size:20px;cursor:pointer}
.counter input{width:86px;height:52px;background:#0e0e0e;border:none;border-left:1px solid var(--border);border-right:1px solid var(--border);color:#fff;text-align:center;font-weight:900;font-size:20px}

/* mappa pulita */
.map{position:relative;aspect-ratio: 5/3;background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:14px;overflow:hidden;padding:16px}
.deck{position:absolute;top:12px;left:50%;transform:translateX(-50%);padding:6px 10px;border-radius:8px;border:1px dashed rgba(255,255,255,.25);font-size:12px}
.floor{position:absolute;inset:0;display:grid;place-items:center}
.floor .dance{width:56%;height:52%;border:1px dashed rgba(255,255,255,.18);border-radius:12px;display:grid;place-items:center;color:#bdbdbd;font-size:12px}

/* tavoli */
.zone{position:absolute;min-width:140px;max-width:170px;display:grid;place-items:center;border-radius:14px;border:2px solid rgba(255,255,255,.15);padding:10px 12px;background:#111;cursor:pointer;transition:transform .1s, outline .1s, box-shadow .1s}
.zone .pp{font-weight:900;letter-spacing:.3px}
.zone .lbl{font-size:12px;opacity:.9;margin-top:2px}
.zone[data-area="gold"]{border-color:var(--gold)}
.zone[data-area="silver"]{border-color:var(--silver)}
.zone[data-area="classic"]{border-color:var(--classic)}
.zone.active{outline:3px solid rgba(34,197,94,.9); box-shadow:0 0 0 6px rgba(34,197,94,.22)}
.zone.busy{background:#2a0c0c;border-color:#ff9a9a}
.zone.busy .pp{color:#ffd1d1}
.zone .tag{position:absolute;top:-10px;right:-10px;background:var(--ok);color:#001b07;font-weight:900;font-size:10px;border-radius:14px;padding:2px 6px;border:1px solid #0a0}

/* posizioni ordinate (no overlap) */
.zone.gold-left{top:76px;left:14%}
.zone.gold-center{top:76px;left:50%;transform:translate(-50%,0)}
.zone.gold-right{top:76px;right:14%}

.zone.silver-left1{top:44%;left:8%}
.zone.silver-left2{top:72%;left:10%}
.zone.silver-right1{top:44%;right:8%}
.zone.silver-right2{top:72%;right:10%}

.zone.classic-left1{bottom:28px;left:26%}
.zone.classic-right1{bottom:28px;right:26%}

/* colonna destra */
.table-panel{display:grid;gap:12px}
.table-row{display:grid;gap:10px;background:#0e0e0e;border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px}
.table-row .ttl{font-weight:900}
.kv{display:flex;gap:10px;flex-wrap:wrap}
.kv .pill{padding:6px 10px;border:1px solid var(--border);border-radius:10px;font-size:12px}

/* stepper */
.stepper{display:flex;gap:8px;margin:8px 0}
.step{padding:6px 10px;border:1px solid var(--border);border-radius:8px;font-size:12px}
.step.active{border-color:var(--accent);background:rgba(139,92,246,.1)}

/* listino */
.listino{display:grid;gap:12px}
.cat{font-size:14px;font-weight:900;margin-top:6px}
.item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;border:1px solid rgba(255,255,255,.1);background:#0e0e0e;border-radius:12px;padding:10px}
.item h4{font-size:15px}
.item .inc{font-size:12px;opacity:.85;margin-top:4px}
.price{font-weight:900}
.line{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
.total{font-size:20px;font-weight:900}
.small{font-size:12px;opacity:.8}

/* overlay 18+ e legale */
.gate{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:60}
.gate .box{max-width:640px;border:1px solid rgba(255,0,0,.35);background:#1a0b0b;border-radius:16px;padding:20px}
.gate h3{color:#ff9c9c;font-size:22px;font-weight:900;margin-bottom:8px}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><a href="#" class="muted">Caricamentoâ€¦</a></nav>
  </div>
</header>

<main class="wrap">
  <h1>Prenota il tuo Tavolo</h1>

  <!-- LEGENDA -->
  <div class="legend">
    <div class="chip"><span class="dot" style="background:var(--gold)"></span><b>Gold</b> da 45â‚¬/pax â€¢ min 180â‚¬</div>
    <div class="chip"><span class="dot" style="background:var(--silver)"></span><b>Silver</b> da 35â‚¬/pax â€¢ min 140â‚¬</div>
    <div class="chip"><span class="dot" style="background:var(--classic)"></span><b>Classic</b> da 30â‚¬/pax â€¢ min 120â‚¬</div>
  </div>

  <div class="stepper">
    <div class="step active" id="s1">1) Tavoli</div>
    <div class="step" id="s2">2) Bottiglie</div>
  </div>

  <!-- STEP 1 -->
  <section class="card" id="step1">
    <h2>Quante persone sarete?</h2>
    <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
      <div class="counter">
        <button id="paxMinus">âˆ’</button>
        <input id="paxInput" type="number" value="4" min="1" max="21" inputmode="numeric">
        <button id="paxPlus">+</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="tabs" id="tableTabs"></div>

    <div class="grid grid-2" style="margin-top:10px">
      <div>
        <div class="map" id="clubMap">
          <div class="deck">DJ â€¢ Consolle</div>
          <div class="floor"><div class="dance">PISTA</div></div>

          <!-- GOLD -->
          <div class="zone gold-left"   data-area="gold"   data-zone="gold-left"><div><div class="pp">GOLD</div><div class="lbl">da 45â‚¬/pax</div></div></div>
          <div class="zone gold-center" data-area="gold"   data-zone="gold-center"><div><div class="pp">GOLD</div><div class="lbl">da 45â‚¬/pax</div></div></div>
          <div class="zone gold-right"  data-area="gold"   data-zone="gold-right"><div><div class="pp">GOLD</div><div class="lbl">da 45â‚¬/pax</div></div></div>

          <!-- SILVER -->
          <div class="zone silver-left1"  data-area="silver" data-zone="silver-left1"><div><div class="pp">SILVER</div><div class="lbl">da 35â‚¬/pax</div></div></div>
          <div class="zone silver-left2"  data-area="silver" data-zone="silver-left2"><div><div class="pp">SILVER</div><div class="lbl">da 35â‚¬/pax</div></div></div>
          <div class="zone silver-right1" data-area="silver" data-zone="silver-right1"><div><div class="pp">SILVER</div><div class="lbl">da 35â‚¬/pax</div></div></div>
          <div class="zone silver-right2" data-area="silver" data-zone="silver-right2"><div><div class="pp">SILVER</div><div class="lbl">da 35â‚¬/pax</div></div></div>

          <!-- CLASSIC -->
          <div class="zone classic-left1"  data-area="classic" data-zone="classic-left1"><div><div class="pp">CLASSIC</div><div class="lbl">da 30â‚¬/pax</div></div></div>
          <div class="zone classic-right1" data-area="classic" data-zone="classic-right1"><div><div class="pp">CLASSIC</div><div class="lbl">da 30â‚¬/pax</div></div></div>
        </div>
      </div>

      <div class="table-panel">
        <div id="tableDetail" class="table-row"></div>
        <div>
          <button id="goStep2" class="btn primary">Vai al listino bottiglie</button>
        </div>
      </div>
    </div>
  </section>

  <!-- STEP 2 -->
  <section class="card" id="step2" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <h2>Scegli le bottiglie</h2>
      <div class="tabs" id="tableTabs2"></div>
    </div>

    <div class="grid grid-2" style="margin-top:8px">
      <div>
        <div class="listino" id="listino"></div>
      </div>

      <div>
        <div id="summaryBox"></div>
        <div class="hr"></div>

        <div class="badge"><label><input type="radio" name="payMode" value="deposito" checked> Caparra</label></div>
        <div class="badge"><label><input type="radio" name="payMode" value="full"> Paga tutto ora</label></div>

        <div class="hr"></div>
        <div class="line total">
          <span id="totalLabel">Caparra (ora)</span>
          <strong id="totalValue">0â‚¬</strong>
        </div>
        <div class="small" id="saldoInfo" style="margin-top:4px">Saldo in serata</div>

        <div class="hr"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="backStep1" class="btn ghost">Indietro</button>
          <button id="confirmBtn" class="btn primary" disabled>Procedi</button>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- POPUP LEGALE -->
<div class="gate" id="legalGate">
  <div class="box">
    <h3>Conferma regole tavoli</h3>
    <div class="small" style="margin-bottom:10px">
      <ul style="margin-left:18px">
        <li>Minimo per area: Classic 120â‚¬ â€¢ Silver 140â‚¬ â€¢ Gold 180â‚¬.</li>
        <li>Oltre 4 pax: +25â‚¬/persona.</li>
        <li>I nominativi devono corrispondere ai documenti.</li>
      </ul>
    </div>
    <label style="display:flex;gap:8px;align-items:center"><input id="legalChk" type="checkbox"> Ho letto e accetto</label>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn ghost" id="legalCancel">Annulla</button>
      <button class="btn primary" id="legalOk" disabled>Procedi</button>
    </div>
  </div>
</div>

<script type="module">
/* ================= Firebase & Auth (stub compatibile) ================= */
import { onUser, doSignOut, app } from './auth.v2.js?v=7';
import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';
const db = getFirestore(app);

/* ================== UI Refs ================== */
const nav = document.getElementById('navArea');
const s1 = document.getElementById('step1');
const s2 = document.getElementById('step2');
const stepBadge1 = document.getElementById('s1');
const stepBadge2 = document.getElementById('s2');

const paxMinus = document.getElementById('paxMinus');
const paxPlus  = document.getElementById('paxPlus');
const paxInput = document.getElementById('paxInput');

const tabs1 = document.getElementById('tableTabs');
const tabs2 = document.getElementById('tableTabs2');
const tableDetail = document.getElementById('tableDetail');

const clubMap = document.getElementById('clubMap');
const zones = [...clubMap.querySelectorAll('.zone')];

const goStep2 = document.getElementById('goStep2');
const backStep1 = document.getElementById('backStep1');
const confirmBtn = document.getElementById('confirmBtn');

const listinoBox = document.getElementById('listino');
const summaryBox = document.getElementById('summaryBox');
const totalLabel = document.getElementById('totalLabel');
const totalValue = document.getElementById('totalValue');
const saldoInfo = document.getElementById('saldoInfo');

const legalGate = document.getElementById('legalGate');
const legalChk = document.getElementById('legalChk');
const legalOk = document.getElementById('legalOk');
const legalCancel = document.getElementById('legalCancel');

/* ================== Stato ================== */
const STATE = {
  user:null,
  activeTable:0,
  totalPax:4,
  pricesPerPax:{ classic:30, silver:35, gold:45 },
  areaMin:{ classic:120, silver:140, gold:180 },
  tables:[],      // {index, area, zone, pax, real, bottles:[{id,qty}]}
  bottleList:[],  // {id,name,category,price,cost,visible,includes?}
  locks:{}        // zone -> {heldBy, tableIndex, heldAt, status}
};

/* ========== Data ========== */
async function loadBottleConfig(){
  try{
    const snap = await getDoc(doc(db,'config','bottles'));
    const items = snap.exists() ? (snap.data()?.items||{}) : {};
    STATE.bottleList = Object.entries(items).map(([id,v])=>({
      id, name:v.name||'â€”',
      category:String(v.category||'').toLowerCase(),
      price:Number(v.price||0),
      cost:Number(v.cost||0),
      visible:v.visible!==false,
      includes:(v.includes||'')+''
    })).filter(x=>x.visible);
  }catch{
    // fallback demo
    STATE.bottleList = [
      {id:'cava',name:'CuvÃ©e Brut',category:'champagne',price:60,cost:35,visible:true},
      {id:'belvedere',name:'Belvedere 0.7',category:'distillati',price:180,cost:100,visible:true},
    ];
  }
}

/* ========== Locks soft 3m (best-effort) ========== */
async function fetchLocks(){
  try{
    const ref = doc(db,'locks','tables');
    const snap = await getDoc(ref);
    STATE.locks = snap.exists()? (snap.data()||{}) : {};
  }catch{ STATE.locks = {}; }
}
async function tryHoldZone(zoneId, tableIndex){
  try{
    const now = Date.now();
    const curr = STATE.locks[zoneId];
    if (curr && (now - (curr.heldAt||0) < 180000) && curr.heldBy !== STATE.user?.uid) return false;
    STATE.locks[zoneId] = { heldBy: STATE.user?.uid||'local', tableIndex, heldAt: now, status:'pending' };
    await setDoc(doc(db,'locks','tables'), { [zoneId]: STATE.locks[zoneId] }, { merge:true });
    return true;
  }catch{ return true; } // best-effort
}
function isZoneBusy(zoneId){
  const l = STATE.locks[zoneId];
  return !!(l && (Date.now() - (l.heldAt||0) < 180000) && l.status!=='released');
}
function releaseZone(zoneId){
  try{
    if(!STATE.locks[zoneId]) return;
    STATE.locks[zoneId].status='released';
    STATE.locks[zoneId].heldAt=Date.now();
    setDoc(doc(db,'locks','tables'), { [zoneId]: STATE.locks[zoneId] }, { merge:true });
  }catch{}
}

/* ========== Tavoli ========== */
function splitTables(total){
  const res=[];
  if (total<=7){ res.push({pax:Math.max(4,total), real:total}); return res; }
  let r=total; while(r>7){ res.push({pax:7,real:7}); r-=7; }
  res.push({pax:Math.max(4,r), real:r});
  return res;
}
function ensureTables(){
  const parts = splitTables(STATE.totalPax);
  const old = STATE.tables;
  STATE.tables = parts.map((p,i)=>({
    index:i,
    area: old[i]?.area || (i===0?'silver':'classic'),
    zone: old[i]?.zone || null,
    pax:  p.pax,
    real: p.real,
    bottles: old[i]?.bottles || []
  }));
}

/* ========== Render ========== */
function renderTabs(container,isStep2=false){
  container.innerHTML='';
  STATE.tables.forEach((t,i)=>{
    const el=document.createElement('div');
    el.className='tab'+(STATE.activeTable===i?' active':'');
    el.textContent='Tavolo '+(i+1);
    el.onclick=()=>{ STATE.activeTable=i; renderStep1(); if(isStep2) renderStep2(); };
    container.appendChild(el);
  });
}
function renderTableDetail(){
  const t = STATE.tables[STATE.activeTable];
  const areaColor = t.area==='gold'?'var(--gold)':t.area==='silver'?'var(--silver)':'var(--classic)';
  const min = STATE.areaMin[t.area]||0;
  tableDetail.innerHTML = `
    <div class="ttl" style="font-size:16px">Tavolo ${t.index+1}</div>
    <div class="kv">
      <span class="pill">Zona: <b style="color:${areaColor}">${t.zone||'â€”'}</b></span>
      <span class="pill">Area: <b style="color:${areaColor}">${t.area.toUpperCase()}</b></span>
      <span class="pill">min ${min}â‚¬</span>
    </div>`;
}
function markTagsOnMap(){
  zones.forEach(z=>z.querySelector('.tag')?.remove());
  STATE.tables.forEach(t=>{
    if(!t.zone) return;
    const el = zones.find(n=>n.getAttribute('data-zone')===t.zone);
    if(el){ const tag=document.createElement('div'); tag.className='tag'; tag.textContent='T'+(t.index+1); el.appendChild(tag); }
  });
}
async function handleZoneClick(el){
  const area = el.getAttribute('data-area');
  const zone = el.getAttribute('data-zone');

  // toggle: se clicchi la stessa zona del tavolo attivo â†’ deseleziona e rilascia
  const cur = STATE.tables[STATE.activeTable].zone;
  if (cur === zone){
    STATE.tables[STATE.activeTable].zone = null;
    releaseZone(zone);
    renderMap(); renderTableDetail();
    return;
  }

  if (isZoneBusy(zone)) return;
  const ok = await tryHoldZone(zone, STATE.activeTable);
  if (!ok) return;

  if (cur && cur!==zone) releaseZone(cur);

  STATE.tables[STATE.activeTable].area = area;
  STATE.tables[STATE.activeTable].zone = zone;

  // auto-pass a Tavolo 2
  if (STATE.activeTable===0 && STATE.tables.length>=2){
    STATE.activeTable = 1;
  }

  renderMap(); renderTableDetail();
}
function renderMap(){
  zones.forEach(z=>{
    z.classList.remove('active','busy');
    const id=z.getAttribute('data-zone');
    if (isZoneBusy(id)) z.classList.add('busy');
  });
  const act = STATE.tables[STATE.activeTable].zone;
  if (act){
    const el = zones.find(z=>z.getAttribute('data-zone')===act);
    el?.classList.add('active');
  }
  zones.forEach(z=> z.onclick=()=>handleZoneClick(z));
  markTagsOnMap();
}
function renderStep1(){
  renderTabs(tabs1,false);
  renderTableDetail();
  renderMap();
}

/* ===== Bottiglie & calcoli ===== */
function ensureBottleSlot(table,id){
  const i = table.bottles.findIndex(b=>b.id===id);
  if (i<0) table.bottles.push({id,qty:0});
  return table.bottles.find(b=>b.id===id);
}
function computeTable(t){
  let sum=0, cost=0;
  t.bottles.forEach(sel=>{
    const meta=STATE.bottleList.find(b=>b.id===sel.id); if(!meta) return;
    const q=Number(sel.qty||0); if(q<=0) return;
    sum += meta.price*q; cost += meta.cost*q;
  });
  const extra = Math.max(0,(t.real||0)-4)*25; // sempre e solo oltre la 4Âª
  const total = sum + extra;
  const caparra = Math.max(25 * t.pax, cost);
  return {sum, extra, total, caparra, perHead: t.real? total/t.real : 0};
}
function computeAll(){
  const items = STATE.tables.map(t=>({t, b:computeTable(t)}));
  const totalAll = items.reduce((s,x)=>s+x.b.total,0);
  const depositAll = items.reduce((s,x)=>s+x.b.caparra,0);
  return {items, totalAll, depositAll};
}
function renderListino(){
  const t = STATE.tables[STATE.activeTable];
  const champagne = STATE.bottleList.filter(b=>b.category==='champagne');
  const dist = STATE.bottleList.filter(b=>b.category==='distillati');

  const sec=(title,arr)=>`
    <div class="cat">${title}</div>
    ${arr.map(b=>{
      const slot = t.bottles.find(x=>x.id===b.id)||{qty:0};
      return `<div class="item">
        <div><h4>${b.name}</h4><div class="small">Listino: ${(Number(b.price||0)).toFixed(2)}â‚¬</div>${b.includes?`<div class="inc">${(b.includes+'').replace(/\n/g,'<br>')}</div>`:''}</div>
        <div class="price">${slot.qty>0?'Ã— '+slot.qty:''}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" data-minus="${b.id}">âˆ’</button>
          <div class="small" style="min-width:24px;text-align:center" data-qty="${b.id}">${slot.qty||0}</div>
          <button class="btn" data-plus="${b.id}">+</button>
        </div>
      </div>`;
    }).join('')}`;
  listinoBox.innerHTML = sec('Champagne',champagne)+sec('Distillati',dist);

  listinoBox.querySelectorAll('[data-plus]').forEach(btn=>{
    btn.onclick=()=>{ const id=btn.getAttribute('data-plus'); const slot=ensureBottleSlot(t,id); slot.qty=Number(slot.qty||0)+1; listinoBox.querySelector(`[data-qty="${id}"]`).textContent=slot.qty; renderSummary(); };
  });
  listinoBox.querySelectorAll('[data-minus]').forEach(btn=>{
    btn.onclick=()=>{ const id=btn.getAttribute('data-minus'); const slot=ensureBottleSlot(t,id); slot.qty=Math.max(0,Number(slot.qty||0)-1); listinoBox.querySelector(`[data-qty="${id}"]`).textContent=slot.qty; renderSummary(); };
  });
}
function renderSummary(){
  const {items,totalAll,depositAll}=computeAll();
  summaryBox.innerHTML = items.map(({t,b})=>{
    const color = t.area==='gold'?'var(--gold)':t.area==='silver'?'var(--silver)':'var(--classic)';
    const min = STATE.areaMin[t.area]||0;
    return `
      <div class="line" style="font-weight:800;color:${color}">Tavolo ${t.index+1} â€” ${t.area.toUpperCase()} (${t.real} pax) <span class="small" style="opacity:.85"> (min ${min}â‚¬)</span></div>
      <div class="line"><span>Bottiglie (listino)</span><span>${b.sum.toFixed(2)}â‚¬</span></div>
      ${b.extra>0?`<div class="line"><span>Persone extra (${Math.max(0,t.real-4)})</span><span>${b.extra.toFixed(2)}â‚¬</span></div>`:''}
      <div class="line"><span>Totale tavolo</span><strong>${b.total.toFixed(2)}â‚¬</strong></div>
      <div class="line small"><span>Totale a persona</span><span>${b.perHead.toFixed(2)}â‚¬</span></div>
      <div class="hr"></div>`;
  }).join('');
  const mode = document.querySelector('input[name="payMode"]:checked')?.value||'deposito';
  if (mode==='full'){ totalLabel.textContent='Totale (paga ora)'; totalValue.textContent=totalAll.toFixed(2)+'â‚¬'; saldoInfo.textContent=''; }
  else { totalLabel.textContent='Caparra (ora)'; totalValue.textContent=depositAll.toFixed(2)+'â‚¬'; saldoInfo.textContent='Saldo in serata'; }

  const hasAny = STATE.tables.some(t=> t.bottles.some(b=>Number(b.qty||0)>0));
  confirmBtn.disabled = !hasAny || !legalChk.checked;
}
function renderTabs2(){ renderTabs(tabs2,true); }
function renderStep2(){ renderTabs2(); renderListino(); renderSummary(); }

/* ========== Navigazione & bind ========== */
function goToStep2Gate(){
  const bad = STATE.tables.find(t=>!t.zone);
  if (bad){ alert(`Seleziona una zona sulla mappa (manca Tavolo ${bad.index+1}).`); return; }
  legalGate.style.display='flex';
}
function backToStep1View(){
  s2.style.display='none'; s1.style.display='block';
  stepBadge2.classList.remove('active'); stepBadge1.classList.add('active');
  renderStep1();
}

paxMinus.onclick = ()=>{ paxInput.value = Math.max(1, Number(paxInput.value||1)-1); onPaxChange(); };
paxPlus.onclick  = ()=>{ paxInput.value = Math.min(21, Number(paxInput.value||1)+1); onPaxChange(); };
paxInput.oninput = ()=>{ const v=Math.max(1,Math.min(21,parseInt(paxInput.value||'1',10)||1)); paxInput.value=v; onPaxChange(); };

function onPaxChange(){
  STATE.totalPax = Number(paxInput.value||1);
  ensureTables(); STATE.activeTable=0; renderStep1();
}

goStep2.onclick = goToStep2Gate;
backStep1.onclick = backToStep1View;
document.querySelectorAll('input[name="payMode"]').forEach(r=> r.addEventListener('change', renderSummary));

legalCancel.onclick=()=>{ legalGate.style.display='none'; };
legalChk.onchange = ()=>{ legalOk.disabled = !legalChk.checked; renderSummary(); };
legalOk.onclick = ()=>{
  legalGate.style.display='none';
  s1.style.display='none'; s2.style.display='block';
  stepBadge1.classList.remove('active'); stepBadge2.classList.add('active');
  renderStep2();
};

/* ========== Boot ========== */
const OUT = `<a href="./login.html?from=./attendees-tavolo.html">Acquista</a> <a href="./login.html">Accedi</a>`;
const IN  = u => `<span>ðŸ‘‹ Ciao, <b>${(u.displayName||u.email||'Utente').split(' ')[0]}</b></span> <a href="./checkout.html">Vai al checkout</a> <a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>`;

onUser(async (u)=>{
  if(!u){ nav.innerHTML=OUT; location.href='./login.html?from=./attendees-tavolo.html'; return; }
  STATE.user=u; nav.innerHTML=IN(u);
  document.getElementById('logoutLink')?.addEventListener('click', async (e)=>{ e.preventDefault(); await doSignOut(); location.href='./login.html?from=./attendees-tavolo.html'; });

  await loadBottleConfig();
  await fetchLocks();

  ensureTables();
  renderStep1();
});
</script>
</body>
</html>
