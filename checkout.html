<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Checkout ‚Äî TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000; --text:#fff; --accent:#8b5cf6; --border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.06); --ok:#22c55e; --muted:rgba(255,255,255,.78);
  --c-eb:#8b5cf6; --c-std:#60a5fa; --c-fast:#34d399; --c-vip:#f59e0b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}
.wrap{max-width:1100px;margin:auto;padding:20px}
h1{font-size:26px;font-weight:900;letter-spacing:-.2px}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.badge{background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;font-size:13px}

/* settimane */
.weeks{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
.weeks button{background:#0f0f10;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.weeks button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(139,92,246,.15)}

/* biglietti */
.tickets{display:grid;gap:12px;margin-top:8px}
.row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;transition:box-shadow .2s}
.title{font-weight:900;display:flex;align-items:center;gap:8px}
.flag{display:inline-block;padding:3px 8px;border-radius:8px;border:1px solid currentColor;font-size:12px;font-weight:800}
.note{font-size:13px;opacity:.95;margin-top:6px}
.controls{display:flex;align-items:center;gap:8px}
.price{font-weight:900}
.qty{display:flex;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:10px;overflow:hidden}
.qty button{width:36px;height:36px;background:#111;border:none;color:#fff;font-weight:900;cursor:pointer}
.qty input{width:48px;height:36px;text-align:center;background:#0a0a0a;border:none;color:#fff;font-weight:800}
.sold{opacity:.5;filter:grayscale(1)}
/* colori */
.row[data-type="eb"]  {border-color:color-mix(in srgb, var(--c-eb) 45%, #fff 0%)}
.row[data-type="std"] {border-color:color-mix(in srgb, var(--c-std)45%, #fff 0%)}
.row[data-type="fast"]{border-color:color-mix(in srgb, var(--c-fast)45%, #fff 0%)}
.row[data-type="vip"] {border-color:color-mix(in srgb, var(--c-vip)45%, #fff 0%)}
.flag.eb{color:var(--c-eb)} .flag.std{color:var(--c-std)} .flag.fast{color:var(--c-fast)} .flag.vip{color:var(--c-vip)}

/* tavolo vip */
.viptable{margin-top:12px;display:flex;justify-content:space-between;align-items:center;background:#0b0b0b;border:1px dashed rgba(245,158,11,.6);border-radius:12px;padding:14px}
.viptable .title{font-weight:900}
.viptable .cta{background:transparent;border:1px solid var(--c-vip);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}

/* riepilogo */
.small{font-size:13px;opacity:.75}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.line{display:flex;justify-content:space-between;font-size:14px;margin:6px 0}
.save{color:#22c55e;font-weight:800}
.total{font-size:22px;font-weight:900}

/* tooltip */
.info{display:inline-flex;align-items:center;gap:6px}
.icon{width:18px;height:18px;border-radius:50%;border:1px solid var(--border);display:inline-grid;place-items:center;font-size:12px;cursor:pointer}
.tooltip{position:relative;display:inline-block}
.tooltip:hover .tip, .tooltip:focus-within .tip{opacity:1;transform:translateY(0);pointer-events:auto}
.tip{position:absolute;right:0;bottom:125%;opacity:0;transform:translateY(6px);transition:.2s;pointer-events:none;background:#111;border:1px solid var(--border);border-radius:10px;padding:10px;min-width:230px;z-index:30}

/* sticky */
.sticky{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.4) 20%, #000 40%);padding-top:16px;margin-top:16px}
.pay{display:inline-block;padding:12px 16px;border-radius:10px;text-decoration:none;font-weight:900;background:var(--accent);color:#000;cursor:pointer;border:none}
.pay[disabled]{opacity:.5;cursor:not-allowed}

/* promo box */
.promo{display:none;margin-top:10px;background:#0f0f10;border:1px solid var(--border);border-radius:12px;padding:12px}
.promo .row{display:flex;gap:8px;align-items:center}
.promo input{flex:1;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.promo .msg{font-size:13px;margin-top:6px}
.promo .ok{color:#22c55e}
.promo .err{color:#ef4444}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span class="muted">Caricamento‚Ä¶</span></nav>
  </div>
</header>

<main class="wrap">
  <h1>Blocca la tua notte</h1>
  <div class="muted" id="hello">Ciao, <strong>ospite</strong></div>

  <!-- simulazione settimane -->
  <div class="weeks" aria-label="Simulazione settimane">
    <button data-week="4" class="active">Settimana 4</button>
    <button data-week="3">Settimana 3</button>
    <button data-week="2">Settimana 2</button>
    <button data-week="1">Settimana 1</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="badges">
        <span class="badge">Sab 21 Mar 2026</span>
        <span class="badge">22:30 ‚Üí 04:30</span>
        <span class="badge">Via Italia 38, Biella</span>
      </div>

      <h2 style="font-size:20px;font-weight:900;margin:14px 0 8px">Scegli i biglietti</h2>
      <div class="tickets">

        <!-- EARLY -->
        <div class="row" data-type="eb" id="rowEB">
          <div>
            <div class="title">Early Bird <span class="flag eb">solo 72h</span></div>
            <div class="note">Ingresso + <span class="drink-label">1 drink</span>. <span id="ebLeft" class="muted"></span></div>
          </div>
          <div class="controls">
            <div class="price">12‚Ç¨</div>
            <div class="qty"><button data-minus="#qEB">‚àí</button><input id="qEB" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qEB">+</button></div>
          </div>
        </div>

        <!-- STANDARD (+ promo 3x40) -->
        <div class="row" data-type="std" id="rowSTD">
          <div>
            <div class="title">Standard <span class="flag std">consigliato</span></div>
            <div class="note">Ingresso + <span class="drink-label">1 drink</span>.</div>
            <div class="note" id="crewPromo" style="margin-top:6px;opacity:.95"><strong>üéüÔ∏è Acquista 3 prevendite</strong> e ricevi uno <strong>sconto speciale</strong> (3√ó40‚Ç¨)</div>
          </div>
          <div class="controls">
            <div class="price">15‚Ç¨</div>
            <div class="qty"><button data-minus="#qSTD">‚àí</button><input id="qSTD" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qSTD">+</button></div>
          </div>
        </div>

        <!-- FAST -->
        <div class="row" data-type="fast" id="rowFAST">
          <div>
            <div class="title">Fast Entry <span class="flag fast">salti la fila</span></div>
            <div class="note">Accesso prioritario + <span class="drink-label">1 drink</span>.</div>
          </div>
          <div class="controls">
            <div class="price">20‚Ç¨</div>
            <div class="qty"><button data-minus="#qFAST">‚àí</button><input id="qFAST" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qFAST">+</button></div>
          </div>
        </div>

        <!-- VIP -->
        <div class="row" data-type="vip" id="rowVIP">
          <div>
            <div class="title">VIP Entry <span class="flag vip">area VIP</span></div>
            <div class="note" id="vipNote"></div>
          </div>
          <div class="controls">
            <div class="price">25‚Ç¨</div>
            <div class="qty"><button data-minus="#qVIP">‚àí</button><input id="qVIP" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qVIP">+</button></div>
          </div>
        </div>

        <!-- Tavolo VIP (solo 18+) -->
        <div class="viptable" id="vipTableBlock" style="display:none">
          <div>
            <div class="title">Tavolo VIP (18+)</div>
            <div class="muted">Posto riservato di gruppo + servizio al tavolo.</div>
          </div>
          <button class="cta" id="vipMore">Scopri di pi√π</button>
        </div>

      </div>
    </div>

    <!-- RIEPILOGO -->
    <aside class="card">
      <h2 style="font-size:18px;font-weight:900;margin-bottom:8px">Riepilogo</h2>
      <div id="lines"></div>

      <!-- Protezione cambio nome (sopra ai totali) -->
      <div class="hr"></div>
      <div class="line">
        <label class="info tooltip" style="cursor:pointer">
          <input id="optNameChange" type="checkbox" style="margin-right:8px">
          Protezione cambio nome <span class="muted">(1,90‚Ç¨ / biglietto)</span>
          <span class="icon" tabindex="0">i</span>
          <span class="tip">Permette di cambiare il nominativo <strong>1 sola volta</strong> fino a <strong>48h</strong> dall‚Äôevento. Si applica a tutti i biglietti selezionati in questo ordine.</span>
        </label>
        <span id="nameChangeLine">0‚Ç¨</span>
      </div>

      <!-- BOX CODICE SCONTO (compare solo se ci sono sconti attivi per tutti o personali) -->
      <div id="promoBox" class="promo">
        <div class="row">
          <input id="promoInput" placeholder="Hai un codice sconto?">
          <button id="promoApply" class="pay" style="padding:10px 14px">Applica</button>
          <button id="promoRemove" class="pay" style="padding:10px 14px;background:transparent;border:1px solid var(--border);color:#fff">Rimuovi</button>
        </div>
        <div id="promoMsg" class="msg"></div>
      </div>

      <div class="hr"></div>
      <div class="line total"><span>Totale (IVA inclusa)</span><strong id="grandTot">0‚Ç¨</strong></div>

      <div class="sticky" style="margin-top:10px">
        <button id="payBtn" class="pay" disabled>Procedi</button>
      </div>
      <div class="small" style="margin-top:10px">Se acquisti pi√π biglietti, assegnerai i nomi nel passaggio successivo.</div>
    </aside>
  </div>
</main>

<script type="module">
/* ==== Auth & Firestore ==== */
import { app, onUser, doSignOut } from './auth.v2.js?v=6';
import {
  getFirestore, doc, getDoc, getDocs, collection, query, where, limit
} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = getFirestore(app);

/* ==== SHA-256 locale (niente import esterni) ==== */
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* ==== Nav/Login ==== */
const nav = document.getElementById('navArea');
const hello = document.getElementById('hello');
const OUT = `<a href="./login.html?from=./checkout.html">Acquista il tuo biglietto</a><a href="./login.html">Accedi</a><a href="./signup.html">Registrati</a>`;
const IN = (u)=>`<span>üëã Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong></span><a href="./checkout.html">Vai al checkout</a><a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>`;

/* ==== Profilo (per testi adulti/minori) ==== */
function getProfile(uid){ try { return JSON.parse(localStorage.getItem('trapperreo_profile_'+uid)||'null'); } catch { return null; } }
function calcAge(dobISO){ if(!dobISO) return 0; const d=new Date(dobISO), t=new Date(); let a=t.getFullYear()-d.getFullYear(); const m=t.getMonth()-d.getMonth(); if(m<0||(m===0&&t.getDate()<d.getDate())) a--; return a; }
let isAdult = false;
let currentUser = null;

/* ==== Promo state ==== */
let appliedDiscount = null;   // { label,type,amount,hash }
const promoBox = document.getElementById('promoBox');
const promoInput = document.getElementById('promoInput');
const promoApply = document.getElementById('promoApply');
const promoRemove= document.getElementById('promoRemove');
const promoMsg   = document.getElementById('promoMsg');

/* ==== Settimane & stock ==== */
const weekBtns = document.querySelectorAll('.weeks button');
let week = 4;
const STOCK = {
  4:{ EB:150, STD:300, FAST:200, VIP:100 },
  3:{ EB:0,   STD:350, FAST:200, VIP:100 },
  2:{ EB:0,   STD:300, FAST:180, VIP:100 },
  1:{ EB:0,   STD:250, FAST:120, VIP:80  },
};
function setWeek(w){
  week = w;
  weekBtns.forEach(b=>b.classList.toggle('active', Number(b.dataset.week)===w));
  highlightByWeek(); applyStock(); render();
}
weekBtns.forEach(b=>b.addEventListener('click', ()=>setWeek(Number(b.dataset.week))));
function highlightByWeek(){
  const map=[['rowEB',4],['rowSTD',3],['rowFAST',2],['rowVIP',1]];
  map.forEach(([id,w])=>{
    const el=document.getElementById(id);
    el.style.boxShadow = (week===w) ? '0 0 0 2px rgba(139,92,246,.18)' : 'none';
  });
}
function leftText(left){ if(left<=0) return 'Esaurito'; if(left<=50) return `Mancano ${left} prevendite`; return `Disponibili ${left}`; }

/* ==== Quantit√† & stock ==== */
const qEB = document.getElementById('qEB'), qSTD = document.getElementById('qSTD'), qFAST = document.getElementById('qFAST'), qVIP = document.getElementById('qVIP');
function currentStock(){ return {...STOCK[week]}; }
function applyStock(){
  const st=currentStock();
  const ebLeft = st.EB - parseInt(qEB.value||0);
  document.getElementById('ebLeft').textContent = st.EB>0 ? leftText(ebLeft) : 'Esaurito';
  [['EB',qEB,'rowEB'],['STD',qSTD,'rowSTD'],['FAST',qFAST,'rowFAST'],['VIP',qVIP,'rowVIP']].forEach(([sku,input,rowId])=>{
    const has=(st[sku]??0)>0; input.disabled=!has; document.getElementById(rowId).classList.toggle('sold',!has);
  });
}

/* ==== Prezzi & promo ==== */
const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90, STD3:40 };
const lines = document.getElementById('lines');
const nameLine = document.getElementById('nameChangeLine');
const optName  = document.getElementById('optNameChange');
const grand = document.getElementById('grandTot');
const payBtn = document.getElementById('payBtn'); /* <-- UNA sola dichiarazione */

function money(n){ return n.toFixed(2).replace('.00','')+'‚Ç¨'; }
function qty(){ return { EB:+(qEB.value||0), STD:+(qSTD.value||0), FAST:+(qFAST.value||0), VIP:+(qVIP.value||0) }; }

/* ==== Persistenza carrello ==== */
function saveCartFromUI(){
  const q = qty();
  const cart = { eb:q.EB, std:q.STD, fast:q.FAST, vip:q.VIP, nc: optName.checked?1:0, promo: appliedDiscount?.hash || '' };
  localStorage.setItem('trapperreo_cart', JSON.stringify(cart));
}
function restoreCartToUI(){
  const saved = JSON.parse(localStorage.getItem('trapperreo_cart') || 'null');
  if(!saved) return;
  qEB.value   = saved.eb   ?? 0;
  qSTD.value  = saved.std  ?? 0;
  qFAST.value = saved.fast ?? 0;
  qVIP.value  = saved.vip  ?? 0;
  optName.checked = (saved.nc === 1);
}

/* ==== Rendering totale (con sconto) ==== */
function render(){
  applyStock();
  const q = qty();

  let subtotal=0;
  let ticketSubtotal=0; // solo biglietti

  const arr=[];
  const add  = (label, val)=>{ arr.push(`<div class="line"><span>${label}</span><span>${money(val)}</span></div>`); subtotal+=val; };
  const info = (label)=>{ arr.push(`<div class="line save"><span>${label}</span><span></span></div>`); };

  // EB
  if(q.EB>0){ add(`Early Bird √ó ${q.EB}`, q.EB*PRICE.EB); ticketSubtotal += q.EB*PRICE.EB; info(`${isAdult?'Drink (alc./analc.)':'Drink analcolico'} incluso √ó ${q.EB}`); }
  // STD (3x40)
  if(q.STD>0){
    const bundles = Math.floor(q.STD/3);
    const remainder = q.STD % 3;
    const stdTotal = bundles*PRICE.STD3 + remainder*PRICE.STD;
    add(`Standard √ó ${q.STD}`, stdTotal); ticketSubtotal += stdTotal;
    if(bundles>0){
      const saved = bundles*(3*PRICE.STD - PRICE.STD3);
      info(`Promo 3 prevendite ${bundles}√ó (3‚Üí40‚Ç¨) ‚Äî Risparmi ${money(saved)}`);
    }
    info(`${isAdult?'Drink (alc./analc.)':'Drink analcolico'} incluso √ó ${q.STD}`);
  }
  // FAST
  if(q.FAST>0){ add(`Fast Entry √ó ${q.FAST}`, q.FAST*PRICE.FAST); ticketSubtotal += q.FAST*PRICE.FAST; info(`${isAdult?'Drink (alc./analc.)':'Drink analcolico'} incluso √ó ${q.FAST}`); }
  // VIP
  if(q.VIP>0){
    add(`VIP Entry √ó ${q.VIP}`, q.VIP*PRICE.VIP); ticketSubtotal += q.VIP*PRICE.VIP;
    if(isAdult){ info(`Drink (alc./analc.) incluso √ó ${q.VIP}`); }
    else{ info(`2 drink analcolici inclusi √ó ${q.VIP}`); }
    info(`Guardaroba incluso √ó ${q.VIP}`);
  }

  // === SCONTO (se applicato) ‚Äî si applica SOLO ai biglietti ===
  if(appliedDiscount){
    let disc = 0;
    if(appliedDiscount.type === 'percent') disc = (ticketSubtotal * Number(appliedDiscount.amount||0)) / 100;
    else disc = Math.min(Number(appliedDiscount.amount||0), ticketSubtotal);
    disc = Math.max(0, Math.round(disc*100)/100);
    if(disc > 0){
      add(`Sconto (${appliedDiscount.label||'promo'})`, -disc);
    }
  }

  // Protezione (NON scontata)
  const ticketsCount = q.EB + q.STD + q.FAST + q.VIP;
  const extra = (optName.checked ? ticketsCount * PRICE.NAMECHANGE : 0);
  nameLine.textContent = money(extra);
  if(optName.checked && ticketsCount>0){
    add(`Protezione cambio nome √ó ${ticketsCount}`, extra);
  }

  lines.innerHTML = arr.join('');
  grand.textContent = money(subtotal);
  payBtn.disabled = ticketsCount<=0;

  saveCartFromUI();
}

/* ==== Bind qty ==== */
function bindQty(){
  document.querySelectorAll('[data-plus]').forEach(b=>{
    b.addEventListener('click',()=>{ const t=document.querySelector(b.getAttribute('data-plus')); t.value=(parseInt(t.value||0)+1); render(); });
  });
  document.querySelectorAll('[data-minus]').forEach(b=>{
    b.addEventListener('click',()=>{ const t=document.querySelector(b.getAttribute('data-minus')); t.value=Math.max(0,parseInt(t.value||0)-1); render(); });
  });
  [qEB,qSTD,qFAST,qVIP,optName].forEach(el=>el.addEventListener(el.type==='checkbox'?'change':'input', render));
}

/* ==== Promo helpers ==== */
async function hasAnyDiscount(uid){
  // attivi per tutti
  const qAll = query(collection(db,'discountCodes'),
    where('active','==',true), where('appliesTo','==','all'), limit(1));
  const snapAll = await getDocs(qAll);
  if(!snapAll.empty) return true;

  // attivi personali
  const qMe = query(collection(db,'discountCodes'),
    where('active','==',true), where('appliesTo','==','user'), where('userId','==',uid), limit(1));
  const snapMe = await getDocs(qMe);
  return !snapMe.empty;
}

async function validateAndApplyCode(plain){
  promoMsg.textContent=''; promoMsg.className='msg';
  if(!plain || !currentUser){ promoMsg.textContent='Codice sconto non valido'; promoMsg.classList.add('err'); return false; }

  const hash = await sha256Hex(plain.trim());
  const ref = doc(db,'discountCodes',hash);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    promoMsg.textContent='Codice sconto non valido';
    promoMsg.classList.add('err');
    appliedDiscount = null; render();
    return false;
  }
  const v = snap.data() || {};
  const allowed = (v.active === true) && (v.appliesTo === 'all' || (v.appliesTo === 'user' && v.userId === currentUser.uid));
  if(!allowed){
    promoMsg.textContent='Codice sconto non valido';
    promoMsg.classList.add('err');
    appliedDiscount = null; render();
    return false;
  }
  appliedDiscount = { label: v.label||'promo', type: v.type||'percent', amount: Number(v.amount||0), hash };
  promoMsg.textContent = `Codice applicato: ${appliedDiscount.label}`;
  promoMsg.classList.add('ok');
  render();
  return true;
}

/* ==== Boot ==== */
onUser(async (u)=>{
  if(!u){ nav.innerHTML=OUT; location.href='./login.html?from=./checkout.html'; return; }
  currentUser = u;
  nav.innerHTML = IN(u);
  document.getElementById('logoutLink')?.addEventListener('click', async (e)=>{e.preventDefault();await doSignOut();nav.innerHTML=OUT;location.href='./login.html?from=./checkout.html';});
  hello.innerHTML = `Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong>`;

  // adult/minore UI
  const prof = getProfile(u.uid);
  isAdult = prof?.dob ? (calcAge(prof.dob) >= 18) : false;
  document.querySelectorAll('.drink-label').forEach(el=>{
    el.textContent = isAdult ? '1 drink (alcolico/analcolico)' : '1 drink analcolico';
  });
  const vipNote = document.getElementById('vipNote');
  vipNote.innerHTML = isAdult
    ? 'Accesso area VIP ‚Ä¢ <span class="drink-label">1 drink (alcolico/analcolico)</span> + <strong>guardaroba incluso</strong>.'
    : 'Accesso area VIP ‚Ä¢ <strong>2 drink analcolici</strong> + <strong>guardaroba incluso</strong>.';
  document.getElementById('vipTableBlock').style.display = isAdult ? 'flex' : 'none';

  // promo: mostra box solo se esistono sconti attivi (globali o personali)
  try{
    const ok = await hasAnyDiscount(u.uid);
    promoBox.style.display = ok ? 'block' : 'none';
  }catch{ promoBox.style.display='none'; }

  // ripristina carrello e set listeners
  restoreCartToUI();
  bindQty();
  setWeek(4);
  render();
});

/* CTA tavolo vip */
document.getElementById('vipMore').addEventListener('click', (e)=>{ e.preventDefault(); alert('Tavolo VIP (18+): ti contattiamo per i dettagli ‚Äî placeholder'); });

/* Promo handlers */
promoApply.addEventListener('click', async ()=>{
  const code = (promoInput.value||'').trim();
  await validateAndApplyCode(code);
});
promoInput.addEventListener('keydown', async (e)=>{
  if(e.key==='Enter'){
    e.preventDefault();
    await validateAndApplyCode((promoInput.value||'').trim());
  }
});
promoRemove.addEventListener('click', ()=>{
  appliedDiscount = null;
  promoMsg.textContent='Codice rimosso';
  promoMsg.className='msg ok';
  promoInput.value='';
  render();
});

/* Procedi */
payBtn.addEventListener('click', ()=>{
  const q = qty();
  const tickets = q.EB + q.STD + q.FAST + q.VIP;
  const qs = new URLSearchParams({
    std:q.STD||0, fast:q.FAST||0, vip:q.VIP||0, eb:q.EB||0, nc: optName.checked?1:0
  }).toString();

  if(tickets > 1){
    location.href = `./attendees.html?${qs}`;
  }else{
    location.href = `./attendees-single.html?${qs}`;
  }
});
</script>
</body>
</html>
