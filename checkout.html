<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Checkout ‚Äî TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000; --text:#fff; --accent:#8b5cf6; --border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.06); --ok:#22c55e; --err:#ef4444; --muted:rgba(255,255,255,.78);
  --c-eb:#8b5cf6; --c-std:#60a5fa; --c-fast:#34d399; --c-vip:#f59e0b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}
.wrap{max-width:1100px;margin:auto;padding:20px}
h1{font-size:26px;font-weight:900;letter-spacing:-.2px}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.badge{background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;font-size:13px}

.adult-only[hidden]{display:none!important}

/* settimane */
.weeks{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
.weeks button{background:#0f0f10;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.weeks button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(139,92,246,.15)}

/* biglietti */
.tickets{display:grid;gap:12px;margin-top:8px}
.row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;transition:box-shadow .2s}
.title{font-weight:900;display:flex;align-items:center;gap:8px}
.flag{display:inline-block;padding:3px 8px;border-radius:8px;border:1px solid currentColor;font-size:12px;font-weight:800}
.note{font-size:13px;opacity:.95;margin-top:6px}
.controls{display:flex;align-items:center;gap:8px}
.price{font-weight:900}
.qty{display:flex;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:10px;overflow:hidden}
.qty button{width:36px;height:36px;background:#111;border:none;color:#fff;font-weight:900;cursor:pointer}
.qty input{width:48px;height:36px;text-align:center;background:#0a0a0a;border:none;color:#fff;font-weight:800}
.sold{opacity:.5;filter:grayscale(1)}
.row[data-type="eb"]  {border-color:color-mix(in srgb, var(--c-eb) 45%, #fff 0%)}
.row[data-type="std"] {border-color:color-mix(in srgb, var(--c-std)45%, #fff 0%)}
.row[data-type="fast"]{border-color:color-mix(in srgb, var(--c-fast)45%, #fff 0%)}
.row[data-type="vip"] {border-color:color-mix(in srgb, var(--c-vip)45%, #fff 0%)}
.flag.eb{color:var(--c-eb)} .flag.std{color:var(--c-std)} .flag.fast{color:var(--c-fast)} .flag.vip{color:var(--c-vip)}

/* Tavolo VIP CTA */
.viptable{margin-top:12px;display:flex;justify-content:space-between;align-items:center;background:#0b0b0b;border:1px dashed rgba(245,158,11,.6);border-radius:12px;padding:14px}
.viptable .title{font-weight:900}
.viptable .cta{background:transparent;border:1px solid var(--c-vip);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none}

/* riepilogo */
.small{font-size:13px;opacity:.75}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.line{display:flex;justify-content:space-between;font-size:14px;margin:6px 0}
.total{font-size:22px;font-weight:900}

/* sticky */
.sticky{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.4) 20%, #000 40%);padding-top:16px;margin-top:16px}
.pay{display:inline-block;padding:12px 16px;border-radius:10px;text-decoration:none;font-weight:900;background:var(--accent);color:#000;cursor:pointer;border:none}
.pay[disabled]{opacity:.5;cursor:not-allowed}

/* hint sconto */
.hint-ok{color:#86efac}
.hint-err{color:var(--err)}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span class="muted">Caricamento‚Ä¶</span></nav>
  </div>
</header>

<main class="wrap">
  <h1>Blocca la tua notte</h1>
  <div class="muted" id="hello">Ciao, <strong>ospite</strong></div>

  <div class="weeks" aria-label="Simulazione settimane">
    <button data-week="4" class="active">Settimana 4</button>
    <button data-week="3">Settimana 3</button>
    <button data-week="2">Settimana 2</button>
    <button data-week="1">Settimana 1</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="badges">
        <span class="badge">Sab 21 Mar 2026</span>
        <span class="badge">22:30 ‚Üí 04:30</span>
        <span class="badge">Via Italia 38, Biella</span>
      </div>

      <h2 style="font-size:20px;font-weight:900;margin:14px 0 8px">Scegli i biglietti</h2>
      <div class="tickets">

        <!-- EARLY -->
        <div class="row" data-type="eb" id="rowEB">
          <div>
            <div class="title">Early Bird <span class="flag eb">solo 72h</span></div>
            <div class="note">Ingresso + <span class="drink-label">1 drink</span>. <span id="ebLeft" class="muted"></span></div>
          </div>
          <div class="controls">
            <div class="price">12‚Ç¨</div>
            <div class="qty"><button data-minus="#qEB">‚àí</button><input id="qEB" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qEB">+</button></div>
          </div>
        </div>

        <!-- STANDARD -->
        <div class="row" data-type="std" id="rowSTD">
          <div>
            <div class="title">Standard <span class="flag std">consigliato</span></div>
            <div class="note">Ingresso + <span class="drink-label">1 drink</span>.</div>
            <div class="note" id="crewPromo" style="margin-top:6px;opacity:.95"><strong>üéüÔ∏è Acquista 3 prevendite</strong> e ricevi uno <strong>sconto speciale</strong> (3√ó40‚Ç¨)</div>
          </div>
          <div class="controls">
            <div class="price">15‚Ç¨</div>
            <div class="qty"><button data-minus="#qSTD">‚àí</button><input id="qSTD" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qSTD">+</button></div>
          </div>
        </div>

        <!-- FAST -->
        <div class="row" data-type="fast" id="rowFAST">
          <div>
            <div class="title">Fast Entry <span class="flag fast">salti la fila</span></div>
            <div class="note">Accesso prioritario + <span class="drink-label">1 drink</span>.</div>
          </div>
          <div class="controls">
            <div class="price">20‚Ç¨</div>
            <div class="qty"><button data-minus="#qFAST">‚àí</button><input id="qFAST" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qFAST">+</button></div>
          </div>
        </div>

        <!-- VIP -->
        <div class="row" data-type="vip" id="rowVIP">
          <div>
            <div class="title">VIP Entry <span class="flag vip">area VIP</span></div>
            <div class="note" id="vipNote"></div>
          </div>
          <div class="controls">
            <div class="price">25‚Ç¨</div>
            <div class="qty"><button data-minus="#qVIP">‚àí</button><input id="qVIP" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qVIP">+</button></div>
          </div>
        </div>

        <!-- Tavolo VIP (18+) ‚Äî solo CTA -->
        <div class="viptable" id="vipTableBlock" hidden>
          <div>
            <div class="title">Tavolo VIP (18+)</div>
            <div class="muted">Posto riservato di gruppo + servizio al tavolo.</div>
          </div>
          <a class="cta" id="vipReserve" href="./attendees-tavolo.html">Prenota ora il tuo tavolo</a>
        </div>

      </div>
    </div>

    <!-- RIEPILOGO -->
    <aside class="card">
      <h2 style="font-size:18px;font-weight:900;margin-bottom:8px">Riepilogo</h2>
      <div id="lines"></div>

      <div class="hr"></div>
      <div class="line">
        <label class="small" style="cursor:pointer">
          <input id="optNameChange" type="checkbox" style="margin-right:8px">
          Protezione cambio nome <span class="muted">(1,90‚Ç¨ / biglietto)</span>
        </label>
        <span id="nameChangeLine">0‚Ç¨</span>
      </div>

      <div class="hr"></div>
      <div id="discBlock">
        <div class="line" style="align-items:center;gap:8px">
          <label class="small" style="opacity:.95">Codice sconto</label>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input id="discInput" placeholder="Es. OPENING10" style="flex:1;background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#fff;padding:10px">
          <button id="discApply" class="pay" type="button" style="min-width:92px" disabled>Applica</button>
          <button id="discRemove" class="pay" type="button" style="min-width:92px;background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff">Rimuovi</button>
        </div>
        <div id="discHint" class="small" style="margin-top:6px;opacity:.95"></div>
      </div>

      <div class="hr"></div>
      <div class="line total"><span>Totale (IVA inclusa)</span><strong id="grandTot">0‚Ç¨</strong></div>

      <div class="sticky" style="margin-top:10px">
        <button id="payBtn" class="pay" disabled>Procedi</button>
      </div>
      <div class="small" style="margin-top:10px">Se acquisti pi√π biglietti, assegnerai i nomi nel passaggio successivo.</div>
    </aside>
  </div>
</main>
<script type="module">
/** ================= Auth & Firebase ================= */
import { onUser, doSignOut, app } from './auth.v2.js?v=6';
import {
  getFirestore, doc, getDoc, collection, getDocs, query, where, limit
} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = getFirestore(app);

/** ================= UI base ================= */
const nav   = document.getElementById('navArea');
const hello = document.getElementById('hello');

const qEB   = document.getElementById('qEB');
const qSTD  = document.getElementById('qSTD');
const qFAST = document.getElementById('qFAST');
const qVIP  = document.getElementById('qVIP');

const lines   = document.getElementById('lines');
const grandEl = document.getElementById('grandTot');
const payBtn  = document.getElementById('payBtn');

const optName = document.getElementById('optNameChange');
const nameLine= document.getElementById('nameChangeLine');

/** ====== Box Codice Sconto (gi√† presente nell‚ÄôHTML) ====== */
const discBlock  = document.getElementById('discBlock');
const discInput  = document.getElementById('discInput');
const discApply  = document.getElementById('discApply');
const discRemove = document.getElementById('discRemove');
const discHint   = document.getElementById('discHint');

/** ====== VIP/tavolo (NON CAMBIO LA LOGICA 18+) ====== */
const adultBlocks = Array.from(document.querySelectorAll('.adult-only, #vipTableBlock'));
adultBlocks.forEach(el => { if(!el) return; el.hidden = true; el.style.display = 'none'; });

const vipNote  = document.getElementById('vipNote');
const vipBtn   = document.getElementById('vipReserve');

/** ================= Helpers comuni ================= */
const OUT = `
  <a href="./login.html?from=./checkout.html">Acquista il tuo biglietto</a>
  <a href="./login.html">Accedi</a>
  <a href="./signup.html">Registrati</a>`;
const IN  = (u)=>`
  <span>üëã Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong></span>
  <a href="./checkout.html">Vai al checkout</a>
  <a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>`;

const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90, STD3:40 };
const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '‚Ç¨';

function qty(){ return {
  EB:+(qEB?.value||0), STD:+(qSTD?.value||0), FAST:+(qFAST?.value||0), VIP:+(qVIP?.value||0)
};}
function stdTotal(q){ const b=Math.floor(q/3), r=q%3; return b*PRICE.STD3 + r*PRICE.STD; }
function subtotalBySku(){
  const q = qty();
  return { EB:q.EB*PRICE.EB, STD:stdTotal(q.STD), FAST:q.FAST*PRICE.FAST, VIP:q.VIP*PRICE.VIP };
}
function ticketsCount(){ const q=qty(); return q.EB+q.STD+q.FAST+q.VIP; }
function drinkLabels(){ return document.querySelectorAll('.drink-label'); }

const lc=s=>(s||'').toString().trim().toLowerCase();
const uc=s=>(s||'').toString().trim().toUpperCase();

/** ================= Et√† (mantengo la tua logica) ================= */
function parseDob(any){
  if (!any) return null;
  if (typeof any === 'object' && any.seconds != null) return new Date(any.seconds*1000);
  if (any instanceof Date) return isNaN(any.getTime()) ? null : any;
  if (typeof any === 'number') { const d=new Date(any); return isNaN(d)?null:d; }
  const s=String(any).trim(); if(!s) return null;
  if (/^\d{4}$/.test(s)) { const d=new Date(Number(s),0,1); return isNaN(d)?null:d; }
  if (/^\d{4}-\d{2}-\d{2}/.test(s) || /^\d{4}-\d{2}-\d{2}T/.test(s)) { const d=new Date(s); return isNaN(d)?null:d; }
  if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) { const [dd,mm,yy]=s.split('/').map(n=>parseInt(n,10)); const d=new Date(yy,mm-1,dd); return isNaN(d)?null:d; }
  const d=new Date(s); return isNaN(d)?null:d;
}
function ageFrom(d){
  if(!d) return 0;
  const t=new Date();
  let a=t.getFullYear()-d.getFullYear();
  const m=t.getMonth()-d.getMonth();
  if (m<0 || (m===0 && t.getDate()<d.getDate())) a--;
  return a;
}
function profLSKey(uid){ return `trapperreo_profile_${uid}`; }
function readProfileLS(uid){
  try{ return JSON.parse(localStorage.getItem(profLSKey(uid))||'null'); }catch{ return null; }
}
function writeProfileLS(uid, profile){
  try{ localStorage.setItem(profLSKey(uid), JSON.stringify(profile)); }catch{}
}
async function readDobFreshFirst(uid){
  let rawDB=null, rawLS=null, dobDate=null, source='none';
  try{
    const snap = await getDoc(doc(db,'users',uid));
    if (snap.exists()){
      const data = snap.data() || {};
      rawDB = (data.dob ?? data.profile?.dob ?? null);
      const parsed = parseDob(rawDB);
      if (parsed){ dobDate=parsed; source='db'; }
    }
  }catch{}
  if (dobDate){
    const currLS = readProfileLS(uid) || {};
    if (currLS.dob !== rawDB) writeProfileLS(uid, { ...currLS, dob: rawDB });
    return { dobDate, source, rawLS: (currLS?.dob ?? null), rawDB };
  }
  const profLS = readProfileLS(uid);
  rawLS = profLS?.dob ?? null;
  const parsedLS = parseDob(rawLS);
  if (parsedLS){ dobDate = parsedLS; source='ls'; }
  return { dobDate, source, rawLS, rawDB };
}

function setAdultUI(isAdult){
  drinkLabels().forEach(el=>{
    el.textContent = isAdult ? '1 drink (alcolico/analcolico)' : '1 drink analcolico';
  });
  if (vipNote){
    vipNote.innerHTML = isAdult
      ? 'Accesso area VIP ‚Ä¢ <span class="drink-label">1 drink (alcolico/analcolico)</span> + <strong>guardaroba incluso</strong>.'
      : 'Accesso area VIP ‚Ä¢ <strong>2 drink analcolici</strong> + <strong>guardaroba incluso</strong>.';
  }
  adultBlocks.forEach(el=>{
    if (!el) return;
    if (isAdult){ el.hidden = false; el.style.display = ''; }
    else        { el.hidden = true;  el.style.display = 'none'; }
  });
  if (vipBtn){
    vipBtn.onclick = (e)=>{
      if (!isAdult){ e.preventDefault(); return; }
      location.href = './attendees-tavolo.html';
    };
  }
}

/** ================= SCONTI ================= */
/* Cache sconti */
let ALL_DISCOUNTS = [];
let CURRENT_USER = null;

/* snapshot applicato condiviso tra pagine */
const readApplied  = () => { try{ return JSON.parse(localStorage.getItem('trapperreo_discount_applied')||'null'); }catch{ return null; } };
const writeApplied = (s) => { if(!s) localStorage.removeItem('trapperreo_discount_applied'); else localStorage.setItem('trapperreo_discount_applied', JSON.stringify(s)); };

/* normalizzazione compatibile con entrambe le collezioni */
function normalize(raw){
  const code   = uc(raw.code || raw.name || '');
  const type   = (raw.type || 'percent').toString().toLowerCase(); // 'percent' | 'fixed'
  const value  = Number(raw.value ?? raw.amount ?? 0);
  const active = (raw.active ?? raw.enabled ?? true) === true;

  const applies = (raw.appliesTo || raw.scope || (raw.userEmail ? 'user' : 'all')).toString().toLowerCase();
  let allowedEmails = Array.isArray(raw.allowedEmails) ? raw.allowedEmails.map(lc) : [];
  if (applies === 'user' && raw.userEmail) {
    const ue = lc(raw.userEmail);
    if (!allowedEmails.includes(ue)) allowedEmails.push(ue);
  }
  const allowedSkus = Array.isArray(raw.allowedSkus) ? raw.allowedSkus
                     : (Array.isArray(raw.skus) ? raw.skus : []);
  const label = raw.label || raw.title || '';

  if (!code || !(value>0) || !['percent','fixed'].includes(type)) return null;
  return { code, type, value, active, applies, allowedEmails, allowedSkus, label };
}

async function fetchCol(col){
  try{
    const snap = await getDocs(collection(db,col));
    const arr=[]; snap.forEach(d=>{ const n=normalize(d.data()||{}); if(n && n.active) arr.push(n); });
    return arr;
  }catch{ return []; }
}
async function loadDiscounts(){
  const a = await fetchCol('discounts');
  const b = await fetchCol('discountCodes');
  const map = new Map(); // preferisce 'discounts'
  [...b, ...a].forEach(d=> map.set(d.code, d));
  ALL_DISCOUNTS = Array.from(map.values());
}

function eligibleForUser(d, user){
  if (!d) return false;
  if (d.applies === 'all') return true;
  const email = lc(user?.email || '');
  if (!email) return false;
  if (Array.isArray(d.allowedEmails) && d.allowedEmails.length > 0) {
    return d.allowedEmails.includes(email);
  }
  return false;
}
function allowedSet(d){
  return (d.allowedSkus && d.allowedSkus.length>0) ? d.allowedSkus : ['EB','STD','FAST','VIP'];
}
function computeDiscountAmount(d, parts){
  const allow = allowedSet(d);
  const base = (allow.includes('EB')?parts.EB:0)
             + (allow.includes('STD')?parts.STD:0)
             + (allow.includes('FAST')?parts.FAST:0)
             + (allow.includes('VIP')?parts.VIP:0);
  if (d.type === 'percent') return Math.max(0, +(base * (d.value/100)).toFixed(2));
  if (d.type === 'fixed')   return Math.max(0, Math.min(base, d.value));
  return 0;
}
function findInCacheForUser(code, user){
  const C = uc(code);
  return ALL_DISCOUNTS.find(d => d.code===C && eligibleForUser(d, user)) || null;
}
async function fetchSingleFrom(colName, code){
  try{
    const qy = query(collection(db,colName), where('code','==',uc(code)), limit(1));
    const snap = await getDocs(qy);
    if (snap.empty) return null;
    const d = normalize(snap.docs[0].data()||{});
    if (!d || !d.active) return null;
    return eligibleForUser(d, CURRENT_USER) ? d : { __reason:'not-eligible' };
  }catch{ return null; }
}
async function fetchSingle(code){
  const a = await fetchSingleFrom('discounts', code);
  if (a) return a;
  return await fetchSingleFrom('discountCodes', code);
}

/* mostra/nascondi box in base alla presenza di sconti rilevanti */
function shouldShowDiscountBox(user){
  if (!Array.isArray(ALL_DISCOUNTS) || ALL_DISCOUNTS.length===0) return false;
  return ALL_DISCOUNTS.some(d => eligibleForUser(d, user));
}
function showDiscountUI(yes){
  if (!discBlock) return;
  discBlock.style.display = yes ? '' : 'none';
  discBlock.hidden = !yes;
}

/** ================== Render riepilogo con sconto ================== */
function render(){
  if (!qEB || !qSTD || !qFAST || !qVIP) return;
  const parts = subtotalBySku();
  const gross = parts.EB + parts.STD + parts.FAST + parts.VIP;

  const snap = readApplied(); // {code,type,value,allowedSkus}
  let discAmt = 0, tag=null;
  if (snap){
    const d = {
      code: snap.code,
      type: snap.type,
      value: snap.value,
      allowedSkus: (snap.allowedSkus && snap.allowedSkus.length ? snap.allowedSkus : ['EB','STD','FAST','VIP'])
    };
    discAmt = computeDiscountAmount(d, parts);
    tag = `${snap.code} ‚Äî ${snap.type==='percent' ? '%'+snap.value : '‚àí'+money(snap.value)}`;
  }

  const tCount = ticketsCount();
  const prot   = optName?.checked ? tCount * PRICE.NAMECHANGE : 0;
  if (nameLine) nameLine.textContent = prot ? money(prot) : '0‚Ç¨';

  const total  = Math.max(0, gross - discAmt) + prot;

  const L=[]; const label = k=>({EB:'Early Bird',STD:'Standard',FAST:'Fast Entry',VIP:'VIP Entry'})[k];
  const q = qty();
  if(q.EB>0)   L.push(`<div class="line"><span>${label('EB')} √ó ${q.EB}</span><span>${money(parts.EB)}</span></div>`);
  if(q.STD>0)  L.push(`<div class="line"><span>${label('STD')} √ó ${q.STD}</span><span>${money(parts.STD)}</span></div>`);
  if(q.FAST>0) L.push(`<div class="line"><span>${label('FAST')} √ó ${q.FAST}</span><span>${money(parts.FAST)}</span></div>`);
  if(q.VIP>0)  L.push(`<div class="line"><span>${label('VIP')} √ó ${q.VIP}</span><span>${money(parts.VIP)}</span></div>`);
  if(tag)      L.push(`<div class="line" style="color:#22c55e;font-weight:800"><span>Sconto (${tag})</span><span>- ${money(discAmt)}</span></div>`);
  if(optName?.checked && tCount>0){
    L.push(`<div class="line"><span>Protezione cambio nome √ó ${tCount}</span><span>${money(prot)}</span></div>`);
  }

  if (lines)   lines.innerHTML   = L.join('');
  if (grandEl) grandEl.textContent = money(total);
  if (payBtn)  payBtn.disabled = tCount<=0;

  if (discHint){
    if (snap){
      discHint.textContent = `Applicato: ${tag}.`;
      discHint.classList.remove('hint-err'); discHint.classList.add('hint-ok');
    }else{
      discHint.textContent = `Inserisci un codice valido`;
      discHint.classList.remove('hint-ok'); discHint.classList.add('hint-err');
    }
  }
}

function bindQty(){
  document.querySelectorAll('[data-plus]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const sel=b.getAttribute('data-plus'); if(!sel) return;
      const t=document.querySelector(sel); if(!t) return;
      t.value=(parseInt(t.value||0)+1); render();
    });
  });
  document.querySelectorAll('[data-minus]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const sel=b.getAttribute('data-minus'); if(!sel) return;
      const t=document.querySelector(sel); if(!t) return;
      t.value=Math.max(0,parseInt(t.value||0)-1); render();
    });
  });
  [qEB,qSTD,qFAST,qVIP,optName].forEach(el=>{
    if(!el) return;
    el.addEventListener(el.type==='checkbox'?'change':'input', render);
  });
}

/** ======= Applica / rimuovi sconto (inline, NO popup) ======= */
async function handleApply(){
  const code = uc(discInput?.value||'');
  if(!code){
    if (discHint){ discHint.textContent='Inserisci un codice'; discHint.classList.add('hint-err'); }
    return;
  }

  // 1) cache
  let found = findInCacheForUser(code, CURRENT_USER);
  // 2) query singola
  if(!found){
    const one = await fetchSingle(code);
    if (one && !one.__reason) found = one;
    else if (one && one.__reason === 'not-eligible'){
      writeApplied(null); render();
      if (discHint){ discHint.textContent='Codice valido ma non assegnato al tuo account.'; discHint.classList.add('hint-err'); }
      return;
    }
  }
  if(!found){
    writeApplied(null); render();
    if (discHint){ discHint.textContent='Codice sconto non valido'; discHint.classList.add('hint-err'); }
    return;
  }

  writeApplied({
    code: found.code,
    type: found.type,
    value: found.value,
    allowedSkus: allowedSet(found)
  });
  if (discHint){ discHint.textContent='Codice applicato ‚úîÔ∏é'; discHint.classList.remove('hint-err'); discHint.classList.add('hint-ok'); }
  render();
}
function handleRemove(){
  writeApplied(null);
  if (discHint){ discHint.textContent='Codice rimosso'; discHint.classList.remove('hint-err'); discHint.classList.add('hint-ok'); }
  render();
}

/** ================= Auth Boot ================= */
hello.textContent = 'Caricamento‚Ä¶';
bindQty();            // subito: +/‚àí funzionano a prescindere
render();             // primo render "vuoto"

onUser(async (u)=>{
  try{
    if(!u){
      nav.innerHTML=OUT;
      location.href='./login.html?from=./checkout.html';
      return;
    }
    CURRENT_USER = u;

    // Nav
    nav.innerHTML = IN(u);
    document.getElementById('logoutLink')?.addEventListener('click', async (e)=>{
      e.preventDefault(); await doSignOut(); nav.innerHTML=OUT; location.href='./login.html?from=./checkout.html';
    });
    hello.innerHTML = `Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong>`;

    // Et√† (DB -> LS), NON CAMBIO LA TUA LOGICA
    const { dobDate, source, rawLS, rawDB } = await readDobFreshFirst(u.uid);
    const age = ageFrom(dobDate);
    const isAdult = age >= 18;
    setAdultUI(isAdult);

    // Sconti: carico lista, decido visibilit√† box
    await loadDiscounts();
    showDiscountUI( shouldShowDiscountBox(CURRENT_USER) );
    if (discApply) discApply.disabled = false;

    // Bind bottoni sconto
    discApply?.addEventListener('click', handleApply);
    discRemove?.addEventListener('click', handleRemove);

    // Se c'√® gi√† uno sconto salvato, prova a riapplicarlo (solo se esiste e sei idoneo)
    const snap = readApplied();
    if (snap){
      const exists = findInCacheForUser(snap.code, CURRENT_USER) || await fetchSingle(snap.code);
      if (!exists || exists.__reason === 'not-eligible'){ writeApplied(null); }
    }

    render();
  }catch(err){
    console.error('onUser fatal:', err);
    // fallback: niente tavoli e nascondi box sconto
    adultBlocks.forEach(el => { if(!el) return; el.hidden = true; el.style.display = 'none'; });
    showDiscountUI(false);
  }
});

/** ================= Procedi ================= */
payBtn?.addEventListener('click', ()=>{
  const q = qty();
  const tickets = q.EB + q.STD + q.FAST + q.VIP;
  const qs = new URLSearchParams({
    std:q.STD||0, fast:q.FAST||0, vip:q.VIP||0, eb:q.EB||0, nc: optName?.checked?1:0
  }).toString();
  if(tickets > 1) location.href = `./attendees.html?${qs}`;
  else            location.href = `./attendees-single.html?${qs}`;
});
</script>

</body>
</html>
