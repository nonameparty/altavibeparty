<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Checkout â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--accent:#8b5cf6;--accent-weak:rgba(139,92,246,.12);--bg:#000;--text:#fff;--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}
.wrap{max-width:1100px;margin:auto;padding:20px}
h1{font-size:26px;font-weight:900;letter-spacing:-.2px}
.subtitle{opacity:.85;margin-top:6px}
.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.badge{background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;font-size:13px}
.badge.warn{border-color:rgba(245,158,11,.5);color:#fcd34d}
.badge.ok{border-color:rgba(34,197,94,.45);color:#bbf7d0}
.tickets{display:grid;gap:12px;margin-top:8px}
.row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px}
.title{font-weight:900;display:flex;align-items:center;gap:6px}
.flag{display:inline-block;margin-left:8px;padding:3px 8px;border-radius:8px;border:1px solid var(--accent);color:var(--accent);font-size:12px;font-weight:800}
.note{font-size:13px;opacity:.85;margin-top:6px}
.controls{display:flex;align-items:center;gap:8px}
.price{font-weight:900}
.qty{display:flex;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:10px;overflow:hidden}
.qty button{width:36px;height:36px;background:#111;border:none;color:#fff;font-weight:900;cursor:pointer}
.qty input{width:48px;height:36px;text-align:center;background:#0a0a0a;border:none;color:#fff;font-weight:800}
.sold{opacity:.5;filter:grayscale(1)}
.small{font-size:13px;opacity:.75}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.line{display:flex;justify-content:space-between;font-size:14px;margin:6px 0}
.save{color:#22c55e;font-weight:800}
.sticky{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.4) 20%, #000 40%);padding-top:16px;margin-top:16px}
.totalbar{display:flex;justify-content:space-between;align-items:center;background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:14px 16px}
.totalbar strong{font-size:22px}
.pay{display:inline-block;padding:12px 16px;border-radius:10px;text-decoration:none;font-weight:900;background:var(--accent);color:#000;cursor:pointer;border:none}
.pay[disabled]{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span>Caricamentoâ€¦</span></nav>
  </div>
</header>

<main class="wrap">
  <h1>Checkout</h1>
  <div class="subtitle" id="hello">Accesso comeâ€¦</div>
  <div class="badges">
    <span class="badge" id="phaseBadge">Fase vendite</span>
    <span class="badge warn" id="deadlineBadge">Cambio nome</span>
    <span class="badge ok">Evento privato 16+</span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="badges">
        <span class="badge">Sab 21 Mar 2026</span>
        <span class="badge">22:30 â†’ 04:30</span>
        <span class="badge">Via Italia 38, Biella</span>
      </div>

      <h2 style="font-size:20px;font-weight:900;margin:14px 0 8px">Scegli i biglietti</h2>
      <div class="tickets">
        <!-- EARLY -->
        <div class="row" id="rowEB">
          <div>
            <div class="title">Early Bird <span class="flag">solo 72h</span></div>
            <div class="note">Ingresso + 1 drink (soft/energy). Stock limitato.</div>
            <div class="small" id="ebInfo"></div>
          </div>
          <div class="controls">
            <div class="price">12â‚¬</div>
            <div class="qty">
              <button data-minus="#qEB">âˆ’</button>
              <input id="qEB" type="number" min="0" value="0" inputmode="numeric">
              <button data-plus="#qEB">+</button>
            </div>
          </div>
        </div>
        <!-- STANDARD -->
        <div class="row" id="rowSTD">
          <div>
            <div class="title">Standard</div>
            <div class="note">Ingresso + 1 drink (soft/energy).</div>
          </div>
          <div class="controls">
            <div class="price">15â‚¬</div>
            <div class="qty">
              <button data-minus="#qSTD">âˆ’</button>
              <input id="qSTD" type="number" min="0" value="0" inputmode="numeric">
              <button data-plus="#qSTD">+</button>
            </div>
          </div>
        </div>
        <!-- FAST -->
        <div class="row" id="rowFAST">
          <div>
            <div class="title">Fast Entry <span class="flag">salti la fila</span></div>
            <div class="note">Accesso prioritario + 1 drink. Nessun guardaroba incluso.</div>
          </div>
          <div class="controls">
            <div class="price">20â‚¬</div>
            <div class="qty">
              <button data-minus="#qFAST">âˆ’</button>
              <input id="qFAST" type="number" min="0" value="0" inputmode="numeric">
              <button data-plus="#qFAST">+</button>
            </div>
          </div>
        </div>
        <!-- VIP -->
        <div class="row" id="rowVIP">
          <div>
            <div class="title">VIP Entry</div>
            <div class="note">Accesso area palco + 1 drink + guardaroba incluso.</div>
          </div>
          <div class="controls">
            <div class="price">25â‚¬</div>
            <div class="qty">
              <button data-minus="#qVIP">âˆ’</button>
              <input id="qVIP" type="number" min="0" value="0" inputmode="numeric">
              <button data-plus="#qVIP">+</button>
            </div>
          </div>
        </div>
        <!-- CREW -->
        <div class="row" id="rowCREW">
          <div>
            <div class="title">Crew Pack (3Ã—)</div>
            <div class="note">3 ingressi Standard insieme. Miglior prezzo di gruppo.</div>
          </div>
          <div class="controls">
            <div class="price">39â‚¬</div>
            <div class="qty">
              <button data-minus="#qCREW">âˆ’</button>
              <input id="qCREW" type="number" min="0" value="0" inputmode="numeric">
              <button data-plus="#qCREW">+</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIEPILOGO -->
    <aside class="card">
      <h2 style="font-size:18px;font-weight:900;margin-bottom:8px">Riepilogo</h2>
      <div id="lines"></div>
      <div class="hr"></div>
      <div class="line"><span>Totale (IVA inclusa)</span><strong id="grandTot">0â‚¬</strong></div>
      <div class="small" id="policyMsg" style="margin-top:6px"></div>
      <div class="sticky" style="margin-top:10px">
        <button id="payBtn" class="pay" disabled>Procedi</button>
      </div>
      <div class="small" style="margin-top:10px">Se acquisti piÃ¹ biglietti, assegnerai i nomi nel passaggio successivo.</div>
    </aside>
  </div>
</main>

<script type="module">
/* ===== Navbar + auth obbligatoria (SOLO auth.v2.js) ===== */
import { onUser, doSignOut } from './auth.v2.js?v=3';

const nav = document.getElementById('navArea');
const hello = document.getElementById('hello');

const OUT = `
  <a href="./login.html?from=./checkout.html">Acquista il tuo biglietto</a>
  <a href="./login.html">Accedi</a>
  <a href="./signup.html">Registrati</a>
`;
const IN = (u) => {
  const name = (u.displayName || (u.email ? u.email.split('@')[0] : 'Utente')).split(' ')[0];
  return `
    <span>ðŸ‘‹ Ciao, ${name}</span>
    <a href="./checkout.html">Vai al checkout</a>
    <a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>
  `;
};

onUser((u)=>{
  if(!u){
    nav.innerHTML = OUT;
    // redirect duro: qui vuoi obbligo login per comprare
    window.location.href = './login.html?from=./checkout.html';
  }else{
    nav.innerHTML = IN(u);
    hello.textContent = `Accesso come: ${(u.displayName || u.email || 'Utente').split(' ')[0]}`;
    document.getElementById('logoutLink')?.addEventListener('click', async (e)=>{
      e.preventDefault(); await doSignOut(); nav.innerHTML = OUT;
      window.location.href = './login.html?from=./checkout.html';
    });
  }
});

/* ===== Fasi settimanali & scadenze ===== */
const EVENT_DATE = new Date('2026-03-21T22:30:00+01:00');
const NOW = new Date();
const msPerDay = 86400000;
const daysToEvent = Math.ceil((EVENT_DATE - NOW)/msPerDay);

function setPhase(){
  let phase='Pre-campagna';
  if (daysToEvent <= 28 && daysToEvent > 21) phase='Settimana 4 â€” Early Bird';
  else if (daysToEvent <= 21 && daysToEvent > 14) phase='Settimana 3 â€” Standard & Crew';
  else if (daysToEvent <= 14 && daysToEvent > 7)  phase='Settimana 2 â€” Spinta Fast';
  else if (daysToEvent <= 7 && daysToEvent >= 0)  phase='Settimana 1 â€” VIP & ultimi pezzi';
  else if (daysToEvent < 0) phase='Evento concluso';
  document.getElementById('phaseBadge').textContent = phase;

  const nameChangeDeadline = new Date(EVENT_DATE.getTime() - 48*60*60*1000);
  const dBadge = document.getElementById('deadlineBadge');
  if (NOW > nameChangeDeadline){
    dBadge.textContent = 'Cambio nome disattivo (sotto 48h)';
  } else {
    const diff = Math.ceil((nameChangeDeadline - NOW)/msPerDay);
    dBadge.textContent = `Cambio nome attivo (${diff}g rimasti)`;
  }
}
setPhase();

/* ===== Listino & Stock ===== */
const PRICE = { EB:12, STD:15, FAST:20, VIP:25, CREW:39 };
let STOCK = { EB:150, STD:350, FAST:200, VIP:100, CREW:50 };
if (daysToEvent<=21) STOCK.EB=0;
if (daysToEvent<=14){ STOCK.FAST=180; }
if (daysToEvent<=7){ STOCK.FAST=120; STOCK.VIP=80; }

const qEB = document.getElementById('qEB');
const qSTD= document.getElementById('qSTD');
const qFAST=document.getElementById('qFAST');
const qVIP =document.getElementById('qVIP');
const qCREW=document.getElementById('qCREW');

function money(n){ return n.toFixed(2).replace('.00','')+'â‚¬'; }
const lines = document.getElementById('lines');
const grand = document.getElementById('grandTot');
const payBtn= document.getElementById('payBtn');
const ebInfo= document.getElementById('ebInfo');

const NOW72 = new Date(NOW.getTime()+72*60*60*1000);
const ebEnd  = new Date(Math.min(EVENT_DATE.getTime(), NOW72.getTime()));
if (STOCK.EB>0) ebInfo.textContent = `Fino al ${ebEnd.toLocaleDateString('it-IT',{day:'2-digit',month:'short'})} o esaurimento (${STOCK.EB} pz).`;

function applyStock(){
  const map=[['EB',qEB,'rowEB'],['STD',qSTD,'rowSTD'],['FAST',qFAST,'rowFAST'],['VIP',qVIP,'rowVIP'],['CREW',qCREW,'rowCREW']];
  map.forEach(([sku,input,rowId])=>{
    const has=(STOCK[sku]||0)>0;
    const row=document.getElementById(rowId);
    input.disabled=!has;
    row.classList.toggle('sold',!has);
    if(!has && !row.dataset.msg){ row.dataset.msg='1'; row.querySelector('.note').innerHTML += ' <span class="small" style="color:#f59e0b">Esaurito</span>'; }
  });
}

function getQty(){
  const g = id => Math.max(0, parseInt(document.getElementById(id).value||0));
  return { EB:g('qEB'), STD:g('qSTD'), FAST:g('qFAST'), VIP:g('qVIP'), CREW:g('qCREW') };
}

function render(){
  applyStock();
  const q = getQty();
  let subtotal=0; const arr=[];
  const add = (label, val)=>{ arr.push(`<div class="line"><span>${label}</span><span>${money(val)}</span></div>`); subtotal+=val; };
  const info= (label)=>{ arr.push(`<div class="line save"><span>${label}</span><span></span></div>`); };

  if(q.EB>0){ add(`Early Bird Ã— ${q.EB}`, q.EB*PRICE.EB); info(`Drink incluso Ã— ${q.EB}`); }
  if(q.STD>0){ add(`Standard Ã— ${q.STD}`, q.STD*PRICE.STD); info(`Drink incluso Ã— ${q.STD}`); }
  if(q.FAST>0){ add(`Fast Entry Ã— ${q.FAST}`, q.FAST*PRICE.FAST); info(`Drink incluso Ã— ${q.FAST}`); }
  if(q.VIP>0){ add(`VIP Entry Ã— ${q.VIP}`, q.VIP*PRICE.VIP); info(`Drink + guardaroba inclusi Ã— ${q.VIP}`); }
  if(q.CREW>0){ add(`Crew Pack (3Ã—) Ã— ${q.CREW}`, q.CREW*PRICE.CREW); info(`Drink inclusi Ã— ${q.CREW*3}`); }

  lines.innerHTML = arr.join('');
  grand.textContent = money(subtotal);

  const totalTickets = q.EB + q.STD + q.FAST + q.VIP + (q.CREW*3);
  document.getElementById('policyMsg').textContent = 'Minorenni: drink = soft/energy. Documento 16+ obbligatorio.';
  payBtn.disabled = totalTickets<=0;
}

function bindQty(){
  document.querySelectorAll('[data-plus]').forEach(b=>{
    b.addEventListener('click',()=>{ const t=document.querySelector(b.getAttribute('data-plus')); t.value=(parseInt(t.value||0)+1); render(); });
  });
  document.querySelectorAll('[data-minus]').forEach(b=>{
    b.addEventListener('click',()=>{ const t=document.querySelector(b.getAttribute('data-minus')); t.value=Math.max(0,parseInt(t.value||0)-1); render(); });
  });
  ['qEB','qSTD','qFAST','qVIP','qCREW'].forEach(id=>{
    document.getElementById(id).addEventListener('input', ()=>render());
  });
}
bindQty(); render();

/* ===== Procedi â†’ attendees.html ===== */
payBtn.addEventListener('click', ()=>{
  const q = getQty();
  const qs = new URLSearchParams({ std:q.STD||0, fast:q.FAST||0, vip:q.VIP||0, eb:q.EB||0, crew:q.CREW||0 }).toString();
  const totalTickets = q.EB + q.STD + q.FAST + q.VIP + (q.CREW*3);
  if(totalTickets>1) location.href = `./attendees.html?${qs}`;
  else alert('Simulazione pagamento: ordine creato!');
});
</script>
</body>
</html>
