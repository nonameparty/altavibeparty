<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Checkout ‚Äî TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000; --text:#fff; --accent:#8b5cf6; --border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.06); --ok:#22c55e; --muted:rgba(255,255,255,.78);
  --c-eb:#8b5cf6; --c-std:#60a5fa; --c-fast:#34d399; --c-vip:#f59e0b;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}
.wrap{max-width:1100px;margin:auto;padding:20px}
h1{font-size:26px;font-weight:900;letter-spacing:-.2px}
.muted{color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.badge{background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;font-size:13px}

/* settimane / biglietti */
.weeks{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
.weeks button{background:#0f0f10;border:1px solid var(--border);color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700}
.weeks button.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(139,92,246,.15)}
.tickets{display:grid;gap:12px;margin-top:8px}
.row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;transition:box-shadow .2s}
.title{font-weight:900;display:flex;align-items:center;gap:8px}
.flag{display:inline-block;padding:3px 8px;border-radius:8px;border:1px solid currentColor;font-size:12px;font-weight:800}
.note{font-size:13px;opacity:.95;margin-top:6px}
.controls{display:flex;align-items:center;gap:8px}
.price{font-weight:900}
.qty{display:flex;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:10px;overflow:hidden}
.qty button{width:36px;height:36px;background:#111;border:none;color:#fff;font-weight:900;cursor:pointer}
.qty input{width:48px;height:36px;text-align:center;background:#0a0a0a;border:none;color:#fff;font-weight:800}
.sold{opacity:.5;filter:grayscale(1)}
/* colori */
.row[data-type="eb"]  {border-color:color-mix(in srgb, var(--c-eb) 45%, #fff 0%)}
.row[data-type="std"] {border-color:color-mix(in srgb, var(--c-std)45%, #fff 0%)}
.row[data-type="fast"]{border-color:color-mix(in srgb, var(--c-fast)45%, #fff 0%)}
.row[data-type="vip"] {border-color:color-mix(in srgb, var(--c-vip)45%, #fff 0%)}
.flag.eb{color:var(--c-eb)} .flag.std{color:var(--c-std)} .flag.fast{color:var(--c-fast)} .flag.vip{color:var(--c-vip)}
/* vip table */
.viptable{margin-top:12px;display:flex;justify-content:space-between;align-items:center;background:#0b0b0b;border:1px dashed rgba(245,158,11,.6);border-radius:12px;padding:14px}
.viptable .title{font-weight:900}
.viptable .cta{background:transparent;border:1px solid var(--c-vip);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}

/* riepilogo */
.small{font-size:13px;opacity:.75}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.line{display:flex;justify-content:space-between;font-size:14px;margin:6px 0}
.save{color:#22c55e;font-weight:800}
.total{font-size:22px;font-weight:900}
.sticky{position:sticky;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.4) 20%, #000 40%);padding-top:16px;margin-top:16px}
.pay{display:inline-block;padding:12px 16px;border-radius:10px;text-decoration:none;font-weight:900;background:var(--accent);color:#000;cursor:pointer;border:none}
.pay[disabled]{opacity:.5;cursor:not-allowed}

/* sconto */
.pill{display:flex;gap:8px;align-items:center;background:#0f0f10;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
.pill input{flex:1;background:transparent;border:none;color:#fff;outline:none}
.pill .apply{background:var(--accent);color:#000;border:none;border-radius:8px;padding:6px 10px;font-weight:900;cursor:pointer}
.pill .ghost{background:transparent;border:1px solid var(--border);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
.badge.sku{border:1px solid var(--border);border-radius:8px;padding:2px 6px;font-size:12px}
.msg{font-size:12px;margin-top:6px}
.msg.ok{color:#a7f3d0}
.msg.err{color:#ffb3b3}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span class="muted">Caricamento‚Ä¶</span></nav>
  </div>
</header>

<main class="wrap">
  <h1>Blocca la tua notte</h1>
  <div class="muted" id="hello">Ciao, <strong>ospite</strong></div>

  <div class="weeks" aria-label="Simulazione settimane">
    <button data-week="4" class="active">Settimana 4</button>
    <button data-week="3">Settimana 3</button>
    <button data-week="2">Settimana 2</button>
    <button data-week="1">Settimana 1</button>
  </div>

  <div class="grid">
    <div class="card">
      <div class="badges">
        <span class="badge">Sab 21 Mar 2026</span>
        <span class="badge">22:30 ‚Üí 04:30</span>
        <span class="badge">Via Italia 38, Biella</span>
      </div>

      <h2 style="font-size:20px;font-weight:900;margin:14px 0 8px">Scegli i biglietti</h2>
      <div class="tickets">
        <div class="row" data-type="eb" id="rowEB">
          <div>
            <div class="title">Early Bird <span class="flag eb">solo 72h</span></div>
            <div class="note">Ingresso + <span class="drink-label">1 drink</span>. <span id="ebLeft" class="muted"></span></div>
          </div>
          <div class="controls"><div class="price">12‚Ç¨</div><div class="qty"><button data-minus="#qEB">‚àí</button><input id="qEB" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qEB">+</button></div></div>
        </div>

        <div class="row" data-type="std" id="rowSTD">
          <div>
            <div class="title">Standard <span class="flag std">consigliato</span></div>
            <div class="note">Ingresso + <span class="drink-label">1 drink</span>.</div>
            <div class="note" id="crewPromo" style="margin-top:6px;opacity:.95"><strong>üéüÔ∏è Acquista 3 prevendite</strong> e ricevi uno <strong>sconto speciale</strong> (3√ó40‚Ç¨)</div>
          </div>
          <div class="controls"><div class="price">15‚Ç¨</div><div class="qty"><button data-minus="#qSTD">‚àí</button><input id="qSTD" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qSTD">+</button></div></div>
        </div>

        <div class="row" data-type="fast" id="rowFAST">
          <div><div class="title">Fast Entry <span class="flag fast">salti la fila</span></div><div class="note">Accesso prioritario + <span class="drink-label">1 drink</span>.</div></div>
          <div class="controls"><div class="price">20‚Ç¨</div><div class="qty"><button data-minus="#qFAST">‚àí</button><input id="qFAST" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qFAST">+</button></div></div>
        </div>

        <div class="row" data-type="vip" id="rowVIP">
          <div><div class="title">VIP Entry <span class="flag vip">area VIP</span></div><div class="note" id="vipNote"></div></div>
          <div class="controls"><div class="price">25‚Ç¨</div><div class="qty"><button data-minus="#qVIP">‚àí</button><input id="qVIP" type="number" min="0" value="0" inputmode="numeric"><button data-plus="#qVIP">+</button></div></div>
        </div>

        <div class="viptable" id="vipTableBlock" style="display:none">
          <div><div class="title">Tavolo VIP (18+)</div><div class="muted">Posto riservato di gruppo + servizio al tavolo.</div></div>
          <button class="cta" id="vipMore">Scopri di pi√π</button>
        </div>
      </div>
    </div>

    <aside class="card">
      <h2 style="font-size:18px;font-weight:900;margin-bottom:8px">Riepilogo</h2>
      <div id="lines"></div>

      <div class="hr"></div>
      <div class="line">
        <label class="info" style="cursor:pointer;display:flex;align-items:center;gap:8px">
          <input id="optNameChange" type="checkbox">
          <span>Protezione cambio nome <span class="muted">(1,90‚Ç¨ / biglietto)</span></span>
        </label>
        <span id="nameChangeLine">0‚Ç¨</span>
      </div>

      <!-- SCONTO -->
      <div id="discountWrap" style="display:none">
        <div class="hr"></div>
        <div class="line"><span>Codice sconto</span><span></span></div>
        <div class="pill">
          <input id="discountInput" placeholder="Es. OPENING10">
          <button id="applyDiscount" class="apply" type="button">Applica</button>
          <button id="removeDiscount" class="ghost" type="button">Rimuovi</button>
        </div>
        <div id="discountInfo" class="msg"></div>
      </div>

      <div class="hr"></div>
      <div class="line total"><span>Totale (IVA inclusa)</span><strong id="grandTot">0‚Ç¨</strong></div>

      <div class="sticky" style="margin-top:10px">
        <button id="payBtn" class="pay" disabled>Procedi</button>
      </div>
      <div class="small" style="margin-top:10px">Se acquisti pi√π biglietti, assegnerai i nomi nel passaggio successivo.</div>
    </aside>
  </div>
</main>

<script type="module">
/* ====== Auth & Firebase ====== */
import { onUser, doSignOut, db as dbFromAuth } from './auth.v2.js?v=6';
import {
  collection, getDocs, query, where, limit
} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = dbFromAuth;

/* ====== UI refs ====== */
const nav = document.getElementById('navArea');
const hello = document.getElementById('hello');
const OUT = `<a href="./login.html?from=./checkout.html">Acquista il tuo biglietto</a><a href="./login.html">Accedi</a><a href="./signup.html">Registrati</a>`;
const IN  = (u)=>`<span>üëã Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong></span><a href="./checkout.html">Vai al checkout</a><a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>`;

const qEB   = document.getElementById('qEB');
const qSTD  = document.getElementById('qSTD');
const qFAST = document.getElementById('qFAST');
const qVIP  = document.getElementById('qVIP');

const lines   = document.getElementById('lines');
const grandEl = document.getElementById('grandTot');
const payBtn  = document.getElementById('payBtn');

const optName  = document.getElementById('optNameChange');
const nameLine = document.getElementById('nameChangeLine');

/* ====== Box Codice Sconto (garantito) ====== */
(function ensureDiscountUI(){
  const wrap = document.querySelector('aside.card');
  if(!wrap) return;
  if(document.getElementById('discBlock')) return;
  const blk = document.createElement('div');
  blk.innerHTML = `
    <div class="hr"></div>
    <div id="discBlock">
      <div class="line" style="align-items:center;gap:8px">
        <label class="small" style="opacity:.95">Codice sconto</label>
      </div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <input id="discInput" placeholder="Es. OPENING10" style="flex:1;background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;color:#fff;padding:10px">
        <button id="discApply" class="pay" type="button" style="min-width:92px">Applica</button>
        <button id="discRemove" class="pay" type="button" style="min-width:92px;background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff">Rimuovi</button>
      </div>
      <div id="discHint" class="small" style="margin-top:6px;opacity:.85"></div>
    </div>
  `;
  wrap.insertBefore(blk, wrap.querySelector('.sticky'));
})();
const discInput  = document.getElementById('discInput');
const discApply  = document.getElementById('discApply');
const discRemove = document.getElementById('discRemove');
const discHint   = document.getElementById('discHint');

/* ====== Prezzi & stato ====== */
const PRICE = { EB:12, STD:15, FAST:20, VIP:25, NAMECHANGE:1.90, STD3:40 };
let currentUser = null;

onUser((u)=>{
  if(!u){ nav.innerHTML=OUT; location.href='./login.html?from=./checkout.html'; return; }
  // se cambia utente, resetta stato sconto legato all'altro utente
  const prevUid = currentUser?.uid;
  currentUser = u;
  if(prevUid && prevUid !== currentUser.uid){
    writeApplied(null); // svuota sconto dell'altro utente
  }

  nav.innerHTML = IN(u);
  document.getElementById('logoutLink')?.addEventListener('click', async (e)=>{
    e.preventDefault(); await doSignOut(); nav.innerHTML=OUT; location.href='./login.html?from=./checkout.html';
  });
  hello.innerHTML = `Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong>`;
  render(); // ricalcola subito con l'utente giusto
});

/* ====== Helpers ====== */
const norm = s => (s||'').toString().trim().normalize('NFKC').replace(/\s+/g,' ');
const up   = s => norm(s).toUpperCase();
const lo   = s => norm(s).toLowerCase();

const money = n => (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.00','') + '‚Ç¨';
const qty = ()=>({ EB:+(qEB.value||0), STD:+(qSTD.value||0), FAST:+(qFAST.value||0), VIP:+(qVIP.value||0) });
function stdTotal(q){ const b=Math.floor(q/3), r=q%3; return b*PRICE.STD3 + r*PRICE.STD; }
function subtotalBySku(){
  const q = qty();
  return { EB:q.EB*PRICE.EB, STD:stdTotal(q.STD), FAST:q.FAST*PRICE.FAST, VIP:q.VIP*PRICE.VIP };
}
function ticketsCount(){ const q=qty(); return q.EB+q.STD+q.FAST+q.VIP; }

/* ====== Cart & Discount storage per-utente ====== */
function cartKey(){ return currentUser ? `trapperreo_cart_${currentUser.uid}` : 'trapperreo_cart_anon'; }
function discKey(){ return currentUser ? `trapperreo_discount_${currentUser.uid}` : 'trapperreo_discount_anon'; }

function saveCart(){
  const q=qty(); localStorage.setItem(cartKey(), JSON.stringify({ eb:q.EB,std:q.STD,fast:q.FAST,vip:q.VIP, nc: optName.checked?1:0 }));
}
function restoreCart(){
  try{
    const saved = JSON.parse(localStorage.getItem(cartKey())||'null');
    if(!saved) return;
    qEB.value   = saved.eb   ?? 0;
    qSTD.value  = saved.std  ?? 0;
    qFAST.value = saved.fast ?? 0;
    qVIP.value  = saved.vip  ?? 0;
    optName.checked = (saved.nc===1);
  }catch{}
}
const readApplied = () => { try{ return JSON.parse(localStorage.getItem(discKey())||'null'); }catch{ return null; } };
const writeApplied = (s) => {
  const k = discKey();
  if(!s) localStorage.removeItem(k);
  else localStorage.setItem(k, JSON.stringify(s));
};

/* ====== Sconti: LISTA unificata ====== */
let allDiscounts = [];

function asArray(v){ if(v==null) return []; return Array.isArray(v)?v:[v]; }
function normalize(doc){
  const codeRaw = doc.code ?? doc.name ?? '';
  const labelRaw= doc.label ?? doc.title ?? codeRaw;

  const emailFields = ['allowedEmails','emails','forEmails'];
  const singleEmail = ['email','forEmail'];
  let allowedEmails = emailFields.flatMap(f=>asArray(doc[f])).concat(singleEmail.map(f=>doc[f]).filter(Boolean));
  allowedEmails = allowedEmails.map(e=>lo(e)).filter(Boolean);

  const uidFields = ['allowedUids','allowedUserIds','userIds','uids'];
  const singleUid = ['userId','uid'];
  let allowedUids = uidFields.flatMap(f=>asArray(doc[f])).concat(singleUid.map(f=>doc[f]).filter(Boolean));
  allowedUids = allowedUids.map(u=>String(u)).filter(Boolean);

  const o = {
    code: up(codeRaw),
    label: up(labelRaw),
    type: (doc.type||'').toString().toLowerCase(), // 'percent' | 'fixed'
    value: Number(doc.value ?? doc.amount ?? 0),
    active: (doc.active ?? doc.enabled ?? true) === true,
    allowedSkus: Array.isArray(doc.allowedSkus) ? doc.allowedSkus
                 : (Array.isArray(doc.skus) ? doc.skus : []),
    allowedEmails,
    allowedUids,
    appliesTo: (doc.appliesTo||'').toString().toLowerCase() // 'all' | 'user' | ''
  };
  if(!o.code || !o.type || !(o.value>0)) return null;
  return o;
}

async function fetchCollectionInto(col, arr){
  try{
    const snap = await getDocs(collection(db,col));
    snap.forEach(d=>{
      const n = normalize(d.data()||{});
      if(n && n.active) arr.push(n);
    });
  }catch(e){ console.warn('Read failed on', col, e); }
}
async function fetchDiscountsList(){
  const arr=[];
  await fetchCollectionInto('discounts', arr);
  await fetchCollectionInto('discountCodes', arr);
  const seen=new Set();
  allDiscounts = arr.filter(d=>{ const k=d.code; if(seen.has(k)) return false; seen.add(k); return true; });
  console.table(allDiscounts);
  if(allDiscounts.length===0) discHint.textContent = 'Nessuno sconto disponibile al momento.';
}

function allowedSet(d){
  return (d?.allowedSkus && d.allowedSkus.length>0) ? d.allowedSkus : ['EB','STD','FAST','VIP'];
}
function eligibleForUser(d){
  if(!currentUser) return true;
  const meEmail = lo(currentUser.email || '');
  const meUid   = String(currentUser.uid || '');

  // Se personale esplicito
  if(d.appliesTo === 'user'){
    const hasEmails = d.allowedEmails?.length>0;
    const hasUids   = d.allowedUids?.length>0;
    if(!hasEmails && !hasUids) return false;
    const okEmail = hasEmails ? d.allowedEmails.includes(meEmail) : false;
    const okUid   = hasUids   ? d.allowedUids.includes(meUid)   : false;
    return okEmail || okUid;
  }
  // Se ha target specifici ma non marcato user, richiede match
  if(d.allowedEmails?.length>0) return !!meEmail && d.allowedEmails.includes(meEmail);
  if(d.allowedUids?.length>0)   return !!meUid   && d.allowedUids.includes(meUid);
  // nessun target: vale per tutti
  return true;
}

function computeDiscountAmount(d, parts){
  if(!d) return 0;
  const allow = allowedSet(d);
  const base = (allow.includes('EB')?parts.EB:0) + (allow.includes('STD')?parts.STD:0) +
               (allow.includes('FAST')?parts.FAST:0) + (allow.includes('VIP')?parts.VIP:0);
  if(d.type==='percent') return Math.max(0, base*(d.value/100));
  if(d.type==='fixed')   return Math.max(0, Math.min(base, d.value));
  return 0;
}

function findInCacheByCode(code){
  const C_UP = up(code), C_LO = lo(code);
  return allDiscounts.find(d=>{
    const dc = up(d.code||'');
    const dl = up(d.label||'');
    return (dc===C_UP || dc===C_LO || dl===C_UP || dl===C_LO);
  }) || null;
}
async function fetchSingleByCode(code){
  const C_UP = up(code), C_LO = lo(code);
  async function tryIn(col, field, value){
    try{
      const qy = query(collection(db,col), where(field,'==', value), limit(1));
      const snap = await getDocs(qy);
      if(snap.empty) return null;
      const n = normalize(snap.docs[0].data()||{});
      return (n && n.active) ? n : null;
    }catch(e){ console.warn('query failed', col, field, value, e); return null; }
  }
  let d = await tryIn('discounts','code',C_UP) || await tryIn('discounts','code',C_LO)
        || await tryIn('discounts','name',C_UP) || await tryIn('discounts','name',C_LO);
  if(d) return d;
  d = await tryIn('discountCodes','code',C_UP) || await tryIn('discountCodes','code',C_LO)
    || await tryIn('discountCodes','name',C_UP) || await tryIn('discountCodes','name',C_LO);
  return d;
}

/* ====== Totali + sconto ====== */
function render(){
  const parts = subtotalBySku();
  const gross = parts.EB + parts.STD + parts.FAST + parts.VIP;

  // 1) recupera snapshot del codice salvato per QUESTO utente
  const snap = readApplied(); // { code }
  let applied = null; // discount doc normalizzato idoneo

  if(snap?.code){
    // 2) prova a risolvere il doc reale dalla cache/lista
    let cand = findInCacheByCode(snap.code);
    // se non lo trovo in cache (es. appena aggiunto), niente async qui per non bloccare: verr√† trovato al prossimo fetch
    if(cand && eligibleForUser(cand)) applied = cand;
    else {
      // se non idoneo o non trovato, rimuovi lo snapshot
      writeApplied(null);
    }
  }

  // 3) calcola sconto SOLO se il doc √® idoneo per l'utente
  let disc = 0; let tag=null;
  if(applied){
    disc = computeDiscountAmount(applied, parts);
    tag  = `${applied.code} ‚Äî ${applied.type==='percent' ? (applied.value+'%') : ('‚àí'+money(applied.value))}`;
  }

  const tCount = ticketsCount();
  const prot   = optName.checked ? tCount * PRICE.NAMECHANGE : 0;
  const total  = Math.max(0, gross - disc) + prot;

  const L=[]; const label = k=>({EB:'Early Bird',STD:'Standard',FAST:'Fast Entry',VIP:'VIP Entry'})[k];
  const q = qty();
  if(q.EB>0)   L.push(`<div class="line"><span>${label('EB')} √ó ${q.EB}</span><span>${money(parts.EB)}</span></div>`);
  if(q.STD>0)  L.push(`<div class="line"><span>${label('STD')} √ó ${q.STD}</span><span>${money(parts.STD)}</span></div>`);
  if(q.FAST>0) L.push(`<div class="line"><span>${label('FAST')} √ó ${q.FAST}</span><span>${money(parts.FAST)}</span></div>`);
  if(q.VIP>0)  L.push(`<div class="line"><span>${label('VIP')} √ó ${q.VIP}</span><span>${money(parts.VIP)}</span></div>`);
  if(tag)      L.push(`<div class="line" style="color:#22c55e;font-weight:800"><span>Sconto (${tag})</span><span>- ${money(disc)}</span></div>`);
  if(optName.checked && tCount>0){
    L.push(`<div class="line"><span>Protezione cambio nome √ó ${tCount}</span><span>${money(prot)}</span></div>`);
  }
  lines.innerHTML = L.join('');
  grandEl.textContent = money(total);
  payBtn.disabled = tCount<=0;

  discHint.textContent = applied
    ? (disc>0 ? `Applicato: ${tag}.` : `Codice valido ma non applica sconti ai biglietti scelti.`)
    : `Inserisci un codice valido`;
}

/* ====== Bind ====== */
function bindQty(){
  document.querySelectorAll('[data-plus]').forEach(b=>{
    b.addEventListener('click',()=>{ const t=document.querySelector(b.getAttribute('data-plus')); t.value=(parseInt(t.value||0)+1); saveCart(); render(); });
  });
  document.querySelectorAll('[data-minus]').forEach(b=>{
    b.addEventListener('click',()=>{ const t=document.querySelector(b.getAttribute('data-minus')); t.value=Math.max(0,parseInt(t.value||0)-1); saveCart(); render(); });
  });
  [qEB,qSTD,qFAST,qVIP,optName].forEach(el=>{
    el.addEventListener(el.type==='checkbox'?'change':'input', ()=>{ saveCart(); render(); });
  });
}

/* ====== Applica / rimuovi ====== */
discApply?.addEventListener('click', async ()=>{
  const code = up(discInput?.value||'');
  if(!code){ alert('Inserisci un codice'); return; }

  // risolvo il codice sulla lista (o lo aggiunger√† il prossimo fetch)
  let cand = findInCacheByCode(code);
  if(!cand){
    // opzionale: tentativo singolo (async) ‚Äì non blocca il render successivo
    cand = await fetchSingleByCode(code);
    if(cand) allDiscounts = [cand, ...allDiscounts]; // cache veloce
  }

  if(!cand || !eligibleForUser(cand)){
    alert('Codice sconto non valido');
    writeApplied(null);
    render();
    return;
  }

  // Salvo SOLO il codice (non i dettagli) per costringere sempre il controllo idoneit√† utente
  writeApplied({ code: cand.code });
  discInput.value = cand.code;
  render();
});

discRemove?.addEventListener('click', ()=>{
  writeApplied(null);
  if(discInput) discInput.value = '';
  discHint.textContent = 'Inserisci un codice valido';
  render();
});

/* ====== Init ====== */
restoreCart();
await fetchDiscountsList();
bindQty();
render();

/* CTA tavolo VIP placeholder */
document.getElementById('vipMore')?.addEventListener('click', (e)=>{ e.preventDefault(); alert('Tavolo VIP (18+): ti contattiamo per i dettagli ‚Äî placeholder'); });

/* Procedi */
payBtn.addEventListener('click', ()=>{
  const q = qty();
  const tickets = q.EB + q.STD + q.FAST + q.VIP;
  const qs = new URLSearchParams({ std:q.STD||0, fast:q.FAST||0, vip:q.VIP||0, eb:q.EB||0, nc: optName.checked?1:0 }).toString();
  saveCart();
  if(tickets > 1) location.href = `./attendees.html?${qs}`;
  else            location.href = `./attendees-single.html?${qs}`;
});
</script>


</body>
</html>
