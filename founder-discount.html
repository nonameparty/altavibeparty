<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Founder — Codici sconto</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12);--muted:rgba(255,255,255,.78)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
.wrap{max-width:1100px;margin:auto;padding:22px}
h1{font-size:32px;font-weight:900;margin-bottom:8px}
h2{font-size:20px;font-weight:900}
.muted{color:var(--muted)}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:14px}
input{background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.btn{display:inline-block;padding:10px 14px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.btn.small{font-size:12px;padding:6px 10px}
.btn:disabled{opacity:.6;cursor:not-allowed}
.table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
.small{font-size:12px}
.badge{display:inline-block;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:3px 8px;margin-right:6px}
.right{display:flex;gap:10px;align-items:center}
.notice{display:none;margin:10px 0;padding:12px;border-radius:10px;background:#2a0e0e;border:1px solid #ff6b6b;color:#ffdede}
.ok{display:none;margin:10px 0;padding:12px;border-radius:10px;background:#0e2a14;border:1px solid #34d399;color:#c6f6d5}
.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:sp 1s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:2px 6px}
.copy{background:#0f0f10;border:1px solid var(--border);color:#fff;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}
.copy:hover{border-color:#8b5cf6}
.danger{border-color:#ff6b6b;color:#ffb3b3}
.inline{display:inline-flex;gap:6px;align-items:center;flex-wrap:wrap}
.row-actions{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<main class="wrap">
  <h1>Codici sconto</h1>
  <div id="who" class="muted">Verifica permessi…</div>

  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
    <a class="btn ghost" href="./founder.html">← Torna al pannello</a>
    <a class="btn" href="./create-discount-all.html">+ Crea codice (per tutti)</a>
    <a class="btn" href="./create-discount-user.html">+ Crea codice (per persona)</a>
  </div>

  <div id="errBanner" class="notice"></div>
  <div id="okBanner" class="ok"></div>

  <section class="card">
    <div class="right" style="justify-content:space-between;">
      <h2>Tutti i codici</h2>
      <div class="right">
        <input id="q" placeholder="Cerca per codice / email / nome…" style="min-width:260px" />
        <button id="btnSearch" class="btn" type="button">Cerca</button>
        <button id="btnReload" class="btn ghost" type="button">Ricarica</button>
        <div id="listLoad" class="spinner" aria-hidden="true" style="display:none"></div>
      </div>
    </div>

    <table class="table" id="tbl">
      <thead>
        <tr>
          <th>Codice</th>
          <th>Tipo/Valore</th>
          <th>Ambito</th>
          <th>Tipologie</th>
          <th>Stato</th>
          <th>Ultimo aggiornamento</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="empty" class="muted small" style="display:none;margin-top:8px">Nessun risultato.</div>
  </section>
</main>

<script type="module">
import { app, onUser } from './auth.v2.js?v=6';
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc,
  collection, getDocs
} from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = getFirestore(app);
const who = document.getElementById('who');
const errBanner = document.getElementById('errBanner');
const okBanner  = document.getElementById('okBanner');
const qInput = document.getElementById('q');
const btnSearch = document.getElementById('btnSearch');
const btnReload = document.getElementById('btnReload');
const tbody = document.querySelector('#tbl tbody');
const emptyMsg = document.getElementById('empty');
const listLoad = document.getElementById('listLoad');
function showError(msg){ errBanner.textContent = msg; errBanner.style.display = 'block'; }
function hideError(){ errBanner.style.display='none'; }
function showOk(msg){ okBanner.textContent = msg; okBanner.style.display='block'; setTimeout(()=>okBanner.style.display='none', 1400); }
const lc = s => (s||'').toString().trim().toLowerCase();
function ts(v){ const u=v?.updatedAt||v?.createdAt; if(!u) return 0; if(typeof u==='number') return u; if(u?.seconds) return u.seconds*1000+Math.floor((u.nanoseconds||0)/1e6); try{return new Date(u).getTime()||0;}catch{return 0;} }
function fmt(ms){ if(!ms) return '—'; const d=new Date(ms); const p=n=>String(n).padStart(2,'0'); return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`; }
async function isFounder(email){ try{ const s=await getDoc(doc(db,'config','admins')); const m=s.exists()?(s.data().founders||{}):{}; return !!m[(email||'').toLowerCase()]; }catch{ return false; } }

let cache=[];
async function loadAll(){
  hideError(); listLoad.style.display='inline-block';
  try{
    cache=[]; const snap=await getDocs(collection(db,'discountCodes'));
    snap.forEach(d=> cache.push({id:d.id, ...d.data()}));
    cache.sort((a,b)=> ts(b)-ts(a));
    render(cache);
  }catch(e){ console.error(e); showError('Non riesco a caricare i codici.'); render([]); }
  finally{ listLoad.style.display='none'; }
}

function render(list){
  tbody.innerHTML=''; emptyMsg.style.display = list.length? 'none':'block';
  list.forEach(v=>{
    const codeCell = v.code
      ? `<div class="inline"><span class="code">${v.code}</span><button class="copy" data-copy="${v.code}" type="button">Copia</button></div><div class="small muted">${v.id.slice(0,10)}…</div>`
      : `<div class="small muted">(manca campo "code")<br>${v.id.slice(0,10)}…</div>`;
    const tv = `${v.type==='fixed'?'€':'%'}${v.amount||0}<br><span class="small">${v.label||''}</span>`;
    const scope = v.appliesTo==='all' ? 'Tutti' : `Persona<br><span class="small">${v.userEmail||''}${v.userName?(' — '+v.userName):''}</span>`;
    const skus = (v.allowedSkus && v.allowedSkus.length && v.allowedSkus.length<4)
      ? v.allowedSkus.map(s=>`<span class="badge">${s}</span>`).join(' ')
      : '<span class="badge">Tutte</span>';
    const state = v.active===true ? 'Attivo' : 'Disattivo';
    const time = fmt(ts(v));
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${codeCell}</td>
      <td>${tv}</td>
      <td>${scope}</td>
      <td>${skus}</td>
      <td data-state="${v.id}">${state}</td>
      <td>${time}</td>
      <td class="row-actions">
        <button class="btn ghost small" data-toggle="${v.id}" type="button">${v.active===true?'Disattiva':'Attiva'}</button>
        <button class="btn ghost small danger" data-del="${v.id}" type="button">Elimina</button>
      </td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('[data-copy]').forEach(b=> b.addEventListener('click', e=>{
    const c=e.currentTarget.getAttribute('data-copy'); navigator.clipboard.writeText(c).then(()=>{e.currentTarget.textContent='Copiato ✓'; setTimeout(()=>e.currentTarget.textContent='Copia',900);});
  }));
  tbody.querySelectorAll('[data-toggle]').forEach(b=> b.addEventListener('click', onToggle));
  tbody.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', onDelete));
}
async function onToggle(e){
  const btn=e.currentTarget; const id=btn.getAttribute('data-toggle'); const item=cache.find(x=>x.id===id); if(!item) return;
  btn.disabled=true; btn.textContent='Aggiorno…';
  try{
    await setDoc(doc(db,'discountCodes',id),{active:!(item.active===true),updatedAt:Date.now()},{merge:true});
    item.active = !(item.active===true);
    btn.textContent = item.active?'Disattiva':'Attiva';
    const td=tbody.querySelector(`td[data-state="${id}"]`); if(td) td.textContent=item.active?'Attivo':'Disattivo';
    showOk('Stato aggiornato');
  }catch(err){ console.error(err); showError('Errore aggiornando lo stato.'); }
  finally{ btn.disabled=false; }
}
async function onDelete(e){
  const btn=e.currentTarget; const id=btn.getAttribute('data-del'); const item=cache.find(x=>x.id===id); if(!item) return;
  if(!confirm(`Eliminare "${item.code || id}"?`)) return;
  btn.disabled=true; btn.textContent='Elimino…';
  try{
    await deleteDoc(doc(db,'discountCodes',id));
    cache = cache.filter(x=>x.id!==id);
    btn.closest('tr')?.remove(); if(!tbody.children.length) emptyMsg.style.display='block';
    showOk('Codice eliminato');
  }catch(err){ console.error(err); showError('Errore eliminando il codice.'); btn.textContent='Elimina'; btn.disabled=false; }
}

function runSearch(){
  const t=lc(qInput.value); if(!t){ render(cache); return; }
  const out = cache.filter(v=>{
    const c=lc(v.code); const m=lc(v.userEmail); const n=lc(v.userName);
    return (c.includes(t) || (m&&m.includes(t)) || (n&&n.includes(t)));
  });
  render(out);
}

onUser(async (u)=>{
  if(!u){ location.href='./login.html?from=./founder-discount.html'; return; }
  const my=await getDoc(doc(db,'users',u.uid)).catch(()=>null);
  const me=my&&my.exists()?my.data():{};
  const allowed=(me.role==='founder')||await isFounder(u.email||'');
  who.textContent = allowed ? `Ciao ${me.name||u.email} — permessi Founder attivi.` : 'Accesso negato (solo Founder).';
  if(!allowed){ setTimeout(()=>location.href='./account-2.html',1200); return; }

  await loadAll();
  btnReload.addEventListener('click', loadAll);
  btnSearch.addEventListener('click', runSearch);
  qInput.addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });
});
</script>
</body>
</html>
