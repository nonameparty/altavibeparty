<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Founder • Crea omaggio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:700px;margin:auto;padding:22px}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:18px;margin-top:14px}
h1{font-size:28px;font-weight:900}
label{display:block;margin:8px 0}
input{width:100%;background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer;margin-top:10px}
.small{opacity:.8;font-size:12px}
</style>
</head>
<body>
<main class="wrap">
  <h1>Crea omaggio</h1>
  <div class="card">
    <label>Email utente
      <input id="email" placeholder="utente@example.com">
    </label>
    <label>Nome e cognome
      <input id="name" placeholder="Mario Rossi">
    </label>
    <label>Data di nascita
      <input id="dob" type="date">
    </label>
    <button id="go" class="btn">Crea ticket omaggio</button>
    <div id="msg" class="small" style="margin-top:10px"></div>
  </div>
</main>

<script type="module">
import { app, onUser } from './auth.v2.js?v=6';
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

const db = getFirestore(app);
const email = document.getElementById('email');
const name  = document.getElementById('name');
const dob   = document.getElementById('dob');
const go    = document.getElementById('go');
const msg   = document.getElementById('msg');

function lc(s){ return (s||'').toString().trim().toLowerCase(); }

async function ensureUserByEmail(mail){
  // trovo utente per email → non c'è una query server-side qui, quindi scansione semplice
  const users = await (await import('https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js'));
  // fallback: crea/aggiorna users doc key = email hash non disponibile: richiedi al founder di conoscere uid
  // Per semplicità: se utente non esiste, lo creo con uid=fake non possibile. Allora strategia:
  // 1) Cerca in /users snapshot (ok per piccoli numeri)
  const sn = await users.getDocs(users.collection(getFirestore(app),'users'));
  let found=null;
  sn.forEach(d=>{ const v=d.data()||{}; if(lc(v.email)===lc(mail)) found={id:d.id, ...v}; });
  if(found) return found.id;

  // se non esiste: creo user placeholder (potrà collegare quell'email in futuro)
  const docId = crypto.randomUUID();
  await setDoc(doc(db,'users',docId), {
    uid: docId, email: lc(mail), name: (name.value||'').trim(), name_lc: lc(name.value),
    dob: dob.value||'', role:'customer', status:'active',
    createdAt: serverTimestamp(), updatedAt: serverTimestamp()
  }, { merge:true });
  return docId;
}

go.onclick = async ()=>{
  const u = await new Promise(res=>onUser(res));
  if(!u){ location.href='./login.html?from=./founder-gift.html'; return; }
  const admins = await getDoc(doc(db,'config','admins'));
  const isFounder = admins.exists() && ((admins.data().founders||{})[lc(u.email||'')]===true || (admins.data().admins||{})[lc(u.email||'')]===true);
  if(!isFounder){ msg.textContent='Accesso negato.'; return; }

  const em = lc(email.value);
  const nm = name.value.trim();
  const dbirth = dob.value;
  if(!em || !nm || !/^\d{4}-\d{2}-\d{2}$/.test(dbirth)){ msg.textContent='Compila correttamente.'; return; }

  const uid = await ensureUserByEmail(em);
  const tRef = await addDoc(collection(db,'users',uid,'tickets'), {
    type:'omaggio', name:nm, dob:dbirth,
    status:'pending', locked:true, unlockCredits:0,
    createdAt: serverTimestamp(), updatedAt: serverTimestamp()
  });
  const qr = JSON.stringify({ uid, tid: tRef.id, v:1 });
  await setDoc(doc(db,'users',uid,'tickets',tRef.id), { qr }, { merge:true });
  msg.textContent = `Omaggio creato ✓ (utente UID ${uid}, ticket ${tRef.id}).`;
};
</script>
</body>
</html>
