<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Scanner QR ‚Äî TRAPPERREO</title>
<link rel="preconnect" href="https://unpkg.com">
<style>
  :root{--bg:#000;--card:#0f0f10;--b:#2a2a2a;--text:#fff;--muted:#bdbdbd;--accent:#8b5cf6;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 ui-sans-serif,system-ui,Inter,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);border-bottom:1px solid #111}
  .nav{max-width:960px;margin:auto;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .badge{width:18px;height:18px;background:var(--accent);transform:skew(-8deg);border-radius:3px}
  main{max-width:960px;margin:0 auto;padding:16px;display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--b);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid #333;background:#151515;color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--accent);color:#000;border-color:transparent}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  select,input[type=file]{background:#0b0b0b;border:1px solid #333;color:#fff;border-radius:10px;padding:8px}
  video{width:100%;max-height:58vh;background:#000;border-radius:12px;border:1px solid #111}
  canvas{display:none}
  .status{padding:10px;border-radius:10px;border:1px dashed #333;background:#0b0b0b}
  .status.ok{border-color:#14532d;background:#062c16}
  .status.err{border-color:#7f1d1d;background:#2a0e0e}
  .mono{font:600 13px ui-monospace,Menlo,Consolas,monospace; word-break:break-all}
  .hint{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="badge"></div> <div>TRAPPERREO ‚Äî Scanner QR</div></div>
    <div class="hint" id="secureHint"></div>
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <button id="btnStart" class="btn primary">üé• Avvia fotocamera</button>
      <button id="btnStop"  class="btn" disabled>‚úã Ferma</button>
      <select id="selDevice" title="Seleziona fotocamera" disabled></select>
      <label class="btn" for="fileInp">üì∑ Carica immagine</label>
      <input id="fileInp" type="file" accept="image/*" capture="environment" style="display:none">
    </div>
    <div class="hint" style="margin-top:6px">
      Se la camera non parte: assicurati che l'URL sia <b>HTTPS</b> (o localhost), consenti il permesso, chiudi altre app che usano la camera. Su iOS serve toccare ‚ÄúAvvia fotocamera‚Äù.
    </div>
  </section>

  <section class="card">
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
  </section>

  <section class="card status" id="statusBox">
    <div><b>Stato:</b> <span id="state">in attesa‚Ä¶</span></div>
    <div class="mono" id="last"></div>
  </section>
</main>

<!-- ZXing reader (browser build) -->
<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
(function(){
  const isSecure = window.isSecureContext || location.hostname==='localhost';
  document.getElementById('secureHint').textContent = isSecure ? 'HTTPS ok' : '‚ö†Ô∏è Usa HTTPS o localhost';

  const { BrowserMultiFormatReader, NotFoundException } = window.ZXingBrowser;
  const codeReader = new BrowserMultiFormatReader();

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const sel = document.getElementById('selDevice');
  const startBtn = document.getElementById('btnStart');
  const stopBtn  = document.getElementById('btnStop');
  const fileInp  = document.getElementById('fileInp');
  const stateEl  = document.getElementById('state');
  const lastEl   = document.getElementById('last');
  const statusBox= document.getElementById('statusBox');

  let currentDeviceId = null;
  let running = false;
  let lastValue = '';
  let beep;

  function setState(text, ok=false, err=false){
    stateEl.textContent = text;
    statusBox.classList.remove('ok','err');
    if(ok) statusBox.classList.add('ok');
    if(err) statusBox.classList.add('err');
  }

  async function ensureDevices(){
    try{
      const list = await navigator.mediaDevices.enumerateDevices();
      const cams = list.filter(d=>d.kind==='videoinput');
      sel.innerHTML = cams.map(d=>`<option value="${d.deviceId}">${d.label || 'Fotocamera'}</option>`).join('');
      sel.disabled = cams.length===0;
      // preferisci quella ‚Äúenvironment‚Äù se presente nel label
      const env = cams.find(d=>(d.label||'').toLowerCase().includes('back') || (d.label||'').toLowerCase().includes('environment'));
      currentDeviceId = env?.deviceId || cams[0]?.deviceId || null;
      if (currentDeviceId) sel.value = currentDeviceId;
      return cams.length>0;
    }catch(e){ return false; }
  }

  async function start(){
    if(!isSecure){ setState('Serve HTTPS o localhost', false, true); return; }
    startBtn.disabled = true; setState('Avvio fotocamera‚Ä¶');
    try{
      // prima chiamata senza deviceId per farsi sbloccare i label
      const tmp = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      tmp.getTracks().forEach(t=>t.stop());
      await ensureDevices();
      if(!currentDeviceId){ setState('Nessuna fotocamera rilevata', false, true); startBtn.disabled=false; return; }

      const stream = await navigator.mediaDevices.getUserMedia({ video:{ deviceId:{ exact: currentDeviceId } }, audio:false });
      video.srcObject = stream;
      await video.play();

      // prepara beep
      try{
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        beep = ()=>{ const o=ac.createOscillator(); const g=ac.createGain(); o.connect(g); g.connect(ac.destination); o.frequency.value=880; g.gain.value=0.1; o.start(); setTimeout(()=>{o.stop();},120); };
      }catch{ beep = ()=>{} }

      running = true; stopBtn.disabled=false; sel.disabled=false;
      loop();
      setState('Scanner attivo ‚úì', true, false);
    }catch(e){
      console.error(e);
      setState('Permesso negato o dispositivo occupato', false, true);
      startBtn.disabled=false;
    }
  }

  function stop(){
    running=false;
    stopBtn.disabled=true; sel.disabled=true;
    startBtn.disabled=false;
    const s = video.srcObject;
    if (s) s.getTracks().forEach(t=>t.stop());
    video.srcObject=null;
    setState('Fermato');
  }

  async function loop(){
    if(!running) return;
    try{
      const res = await codeReader.decodeOnceFromVideoElement(video);
      if(res && res.getText){
        const value = res.getText();
        if(value !== lastValue){
          lastValue = value;
          lastEl.textContent = value;
          setState('QR letto ‚úì', true, false);
          beep && beep();
          if('vibrate' in navigator){ navigator.vibrate(60); }
          // attendo 800ms poi ricomincio
          setTimeout(()=>{ if(running){ setState('Scanner attivo ‚úì', true); loop(); } }, 800);
          return;
        }
      }
    }catch(err){
      if(!(err instanceof NotFoundException)){
        console.debug('decode error', err);
      }
    }
    // nessun codice in questo frame ‚Üí continua
    requestAnimationFrame(loop);
  }

  // cambio camera
  sel.addEventListener('change', async ()=>{
    currentDeviceId = sel.value;
    if(running){ stop(); start(); }
  });

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);

  // fallback: immagine da file
  fileInp.addEventListener('change', async ()=>{
    const f = fileInp.files?.[0]; if(!f) return;
    const img = new Image();
    img.onload = async ()=>{
      canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
      ctx.drawImage(img, 0, 0);
      try{
        const res = await window.ZXingBrowser.BrowserMultiFormatReader.decodeFromCanvas(canvas);
        const v = res?.text || res?.getText?.();
        if(v){
          lastValue = v; lastEl.textContent = v; setState('QR letto da immagine ‚úì', true, false); beep && beep();
        }else{
          setState('Nessun QR nell\'immagine', false, true);
        }
      }catch(e){
        setState('Impossibile leggere il QR', false, true);
      }
      fileInp.value = '';
    };
    img.src = URL.createObjectURL(f);
  });

  // tenta di popolare subito la lista device (non parte la camera)
  if(navigator.mediaDevices?.enumerateDevices){ ensureDevices(); }
})();
</script>
</body>
</html>
