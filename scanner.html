<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>TRAPPERREO â€” Scanner QR (debug iOS)</title>
<style>
  :root{--bg:#000;--card:#0f0f10;--b:#2a2a2a;--text:#fff;--accent:#8b5cf6;--ok:#22c55e;--err:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 ui-sans-serif,system-ui,Inter}
  header{position:sticky;top:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);border-bottom:1px solid #111}
  .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
  h1{margin:0 0 8px;font-size:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid #333;background:#151515;color:#fff;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--accent);color:#000;border:none}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .card{background:var(--card);border:1px solid var(--b);border-radius:14px;padding:14px;margin:12px 0}
  video{width:100%;max-height:58vh;background:#000;border-radius:12px;border:1px solid #111}
  .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;line-height:1.35}
  .ok{color:var(--ok)} .err{color:var(--err)}
</style>
</head>
<body>
<header><div class="wrap"><h1>TRAPPERREO â€” Scanner QR</h1></div></header>
<main class="wrap">
  <div class="card">
    <div class="row">
      <button id="startBtn" class="btn primary">ðŸŽ¥ Avvia fotocamera</button>
      <button id="stopBtn"  class="btn" disabled>âœ‹ Ferma</button>
      <select id="deviceSel" disabled></select>
      <label class="btn" for="fileInp">ðŸ“· Carica immagine</label>
      <input id="fileInp" type="file" accept="image/*" capture="environment" style="display:none">
    </div>
    <div id="tips" style="margin-top:8px;font-size:12px;opacity:.85">
      Se non parte su iPhone: Impostazioni â†’ Safari â†’ Fotocamera = <b>Chiedi/Consenti</b>.
      Se il prompt non compare: Impostazioni â†’ Safari â†’ Avanzate â†’ Dati siti web â†’ rimuovi questo sito.
      Chiudi app che usano la camera (WhatsApp/Instagram).
    </div>
  </div>

  <div class="card">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div class="card">
    <div><b>Stato:</b> <span id="state">in attesaâ€¦</span></div>
    <div class="log" id="log"></div>
  </div>
</main>

<script>
(function(){
  const logEl   = document.getElementById('log');
  const stateEl = document.getElementById('state');
  const startBtn= document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const sel     = document.getElementById('deviceSel');
  const video   = document.getElementById('video');

  let stream = null;
  let currentId = null;

  function log(line){ logEl.textContent += line + '\n'; }
  function setState(s, cls){
    stateEl.textContent = s;
    stateEl.className = cls || '';
  }

  // INFO DIAGNOSTICHE
  log('Secure context: ' + (window.isSecureContext ? 'YES' : 'NO'));
  log('UserAgent: ' + navigator.userAgent);
  log('mediaDevices: ' + (!!(navigator.mediaDevices)));
  log('getUserMedia: ' + (!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)));
  log('webkitGetUserMedia: ' + (!!(navigator.webkitGetUserMedia)));
  log('permissions API (camera): ' + ('permissions' in navigator));

  async function enumerate() {
    try{
      const devs = await navigator.mediaDevices.enumerateDevices();
      const cams = devs.filter(d => d.kind === 'videoinput');
      log('videoinput trovate: ' + cams.length);
      sel.innerHTML = cams.map(d => `<option value="${d.deviceId}">${d.label || 'Fotocamera'}</option>`).join('');
      sel.disabled = cams.length === 0;
      if (cams.length) { currentId = cams[0].deviceId; sel.value = currentId; }
    }catch(e){ log('enumerateDevices error: ' + e.name + ' ' + e.message); }
  }

  function stopStream(){
    if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
    video.srcObject = null;
    stopBtn.disabled = true;
    startBtn.disabled = false;
    setState('fermato');
  }

  async function startStream(deviceId){
    setState('richiesta permessoâ€¦');
    log('startStream con deviceId=' + (deviceId || '(auto env)'));
    // PREFERENZE iOS: facingMode environment + fallback webkit
    const constraints = deviceId
      ? { video: { deviceId: { exact: deviceId } }, audio:false }
      : { video: { facingMode: { ideal:'environment' } }, audio:false };

    try{
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } else if (navigator.webkitGetUserMedia) {
        stream = await new Promise((res, rej)=>{
          navigator.webkitGetUserMedia(constraints, res, rej);
        });
      } else {
        throw new Error('getUserMedia non supportato');
      }
      video.srcObject = stream;

      // iOS richiede una play() esplicita DOPO che sono arrivati i metadata
      await new Promise((resolve)=> {
        let done = false;
        function ready(){
          if(done) return; done = true;
          video.play().then(resolve).catch((e)=>{
            log('video.play() error: '+ e.name +' '+ e.message);
            resolve(); // anche se fallisce, lasciamo andare: alcuni iOS non segnalano bene lo stato
          });
        }
        video.addEventListener('loadedmetadata', ready, {once:true});
        video.addEventListener('canplay', ready, {once:true});
        setTimeout(ready, 1200); // fallback
      });

      stopBtn.disabled = false;
      startBtn.disabled = true;
      setState('camera attiva âœ“', 'ok');

      // solo dopo che lo stream parte, i label delle camere si sbloccano su iOS
      await enumerate();
    }catch(e){
      const name = e && e.name;
      log('getUserMedia error: ' + name + ' ' + (e.message||''));
      let msg = 'errore avvio camera';
      if (name === 'NotAllowedError') msg = 'permesso negato â†’ attivalo in Impostazioni > Safari > Fotocamera';
      if (name === 'NotFoundError' || name === 'OverconstrainedError') msg = 'nessuna fotocamera trovata o in uso da unâ€™altra app';
      if (name === 'NotReadableError') msg = 'la camera Ã¨ occupata da unâ€™altra app';
      setState(msg, 'err');
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  startBtn.addEventListener('click', ()=> startStream(currentId));
  stopBtn.addEventListener('click', stopStream);
  sel.addEventListener('change', ()=>{
    currentId = sel.value || null;
    if(stream) { stopStream(); startStream(currentId); }
  });

  // Prova a elencare i device appena possibile (non avvia la camera)
  if (navigator.mediaDevices?.enumerateDevices) enumerate();
})();
</script>
</body>
</html>
