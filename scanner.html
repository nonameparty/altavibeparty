<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TRAPPERREO ‚Äî Scanner QR (iOS safe)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root{--bg:#000;--text:#fff;--muted:#bdbdbd;--card:#0f0f10;--b:#191919;--accent:#8b5cf6;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui}
header{position:sticky;top:0;z-index:10;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);border-bottom:1px solid #111}
.wrap{max-width:980px;margin:0 auto;padding:14px 16px}
h1{margin:0;font-size:20px}
.card{background:var(--card);border:1px solid var(--b);border-radius:16px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:1px solid #2b2b2b;background:#151515;color:#fff;border-radius:14px;padding:12px 16px;font-weight:900;cursor:pointer}
.btn.primary{background:var(--accent);color:#000;border:none}
.btn.ok{background:var(--ok);color:#000;border:none}
.btn.warn{background:var(--warn);color:#000;border:none}
.btn.stop{background:#fff;color:#000;border:none;font-size:18px;padding:14px 18px}
.btn:disabled{opacity:.55;cursor:not-allowed}
.pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #333;border-radius:999px;padding:6px 10px}
.muted{color:var(--muted)}
#video{width:100%;max-height:60vh;background:#000;border-radius:12px;border:1px solid #111}
#canvas{display:none}
.qrbox{position:relative;margin-top:8px}
.qrbox::after{content:"";position:absolute;inset:8% 20%;border:2px solid rgba(255,255,255,.35);border-radius:12px;pointer-events:none}
#log{white-space:pre-wrap;background:#0b0b0b;border:1px dashed #222;border-radius:10px;padding:10px;margin-top:8px}
.notice{padding:8px 10px;border-radius:10px;border:1px dashed rgba(255,255,255,.25);font-size:12px}
.notice.err{border-color:#ef4444;color:#ffdede;background:#2a0e0e}
.hidden{display:none}
</style>
</head>
<body>
<header><div class="wrap"><h1>TRAPPERREO ‚Äî Scanner QR</h1></div></header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <span class="pill">√à un gruppo?</span>
      <button id="gYes" class="btn">S√¨</button>
      <button id="gNo"  class="btn">No</button>
      <span class="pill">Gruppo: <b id="gMode">no</b> ‚Ä¢ Scansioni: <b id="gCount">0</b></span>
    </div>
    <div class="notice" style="margin-top:8px">
      iPhone: deve essere <b>HTTPS</b> (o <b>localhost</b>). Se hai negato il permesso:
      Impostazioni ‚Üí Safari ‚Üí Avanzate ‚Üí Dati siti web ‚Üí rimuovi il dominio ‚Üí riapri la pagina ‚Üí ‚ÄúAvvia fotocamera‚Äù.
    </div>
  </section>

  <section class="card">
    <div class="row">
      <button id="startBtn" class="btn primary">üé• Avvia fotocamera (posteriore)</button>
      <button id="stopBtn"  class="btn stop" disabled>‚úã STOP</button>
      <input id="fileInput" type="file" accept="image/*" capture="environment" class="hidden">
      <button id="photoBtn" class="btn">üì∑ Usa fotocamera iOS (fallback)</button>
      <span id="status" class="muted"></span>
    </div>
    <div id="err" class="notice err hidden"></div>
  </section>

  <section class="card">
    <video id="video" playsinline muted></video>
    <div class="qrbox"></div>
    <canvas id="canvas"></canvas>
    <div id="log" class="hidden"></div>
    <div class="row" style="margin-top:10px">
      <button id="okBtn" class="btn ok hidden">‚úÖ Conferma</button>
      <button id="flagBtn" class="btn warn hidden">üö© Segnala</button>
      <button id="againBtn" class="btn hidden">‚Üª Scansiona ancora</button>
    </div>
  </section>
</main>

<script>
/* ========= Stato base ========= */
let stream = null;
let currentDeviceId = null;
let scanning = false;
let isGroup = false, groupCount = 0;
let lastResult = null;
const statusEl = document.getElementById('status');
const errEl    = document.getElementById('err');
const video    = document.getElementById('video');
const canvas   = document.getElementById('canvas');
const ctx      = canvas.getContext('2d', { willReadFrequently:true });
const okBtn    = document.getElementById('okBtn');
const flagBtn  = document.getElementById('flagBtn');
const againBtn = document.getElementById('againBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const fileInput= document.getElementById('fileInput');
const photoBtn = document.getElementById('photoBtn');
const gModeEl  = document.getElementById('gMode');
const gCountEl = document.getElementById('gCount');
document.getElementById('gYes').onclick = ()=>{ isGroup=true;  gModeEl.textContent='s√¨'; };
document.getElementById('gNo').onclick  = ()=>{ isGroup=false; gModeEl.textContent='no'; };

function setStatus(t){ statusEl.textContent = t || ''; }
function showErr(t){ errEl.textContent=t||''; errEl.classList.toggle('hidden', !t); }
function showActions(show){
  [okBtn, flagBtn, againBtn].forEach(b=>b.classList.toggle('hidden', !show));
}

/* ========= Apertura camera posteriore in modo robusto =========
   Strategia iOS:
   1) Richiedi una volta getUserMedia({facingMode:"environment"}) per sbloccare labels e devices.
   2) Prendi devices e scegli quella col label 'back/rear/environment' se presente ‚Üí deviceId.
   3) Riavvia lo stream con deviceId specifico.                                         */
async function pickBackCamera() {
  // tentativo 1: facingMode environment
  try{
    const tmp = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio:false });
    tmp.getTracks().forEach(t=>t.stop());
  }catch(_) {
    // ignora: su alcuni iOS bisogna arrivare direttamente alla lista
  }

  const devices = await navigator.mediaDevices.enumerateDevices();
  const videos  = devices.filter(d=>d.kind === 'videoinput');

  if (!videos.length) return null;

  const pick = (kw)=>videos.find(d => (d.label||'').toLowerCase().includes(kw));
  // preferenze comuni
  const back = pick('back') || pick('rear') || pick('environment');
  return (back || videos[videos.length-1]).deviceId;
}

async function startCamera(){
  showErr('');
  setStatus('Richiesta permesso‚Ä¶');
  startBtn.disabled = true; stopBtn.disabled = false;

  try{
    currentDeviceId = await pickBackCamera();
    const constraints = currentDeviceId
      ? { video:{ deviceId:{ exact: currentDeviceId }, focusMode: "continuous" }, audio:false }
      : { video:{ facingMode: { exact: "environment" } }, audio:false };

    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    await video.play();
    scanning = true;
    setStatus('Fotocamera attiva (posteriore)');
    tick(); // avvia loop di scansione
  }catch(e){
    console.error('startCamera error', e);
    // Messaggi chiari per iOS
    if (location.protocol !== 'https:' && location.hostname !== 'localhost'){
      showErr('Safari iOS blocca la camera su HTTP. Usa HTTPS o localhost.');
    } else if (e.name === 'NotAllowedError'){
      showErr('Permesso negato. Vai in Impostazioni ‚Üí Safari ‚Üí Fotocamera ‚Üí Consenti per questo sito.');
    } else if (e.name === 'OverconstrainedError'){
      showErr('La camera posteriore non √® disponibile. Prova a chiudere altre app fotocamera e riprova.');
    } else if (e.name === 'NotReadableError' || e.name === 'AbortError'){
      showErr('La fotocamera √® in uso da un‚Äôaltra app. Chiudila e riprova.');
    } else {
      showErr('Impossibile aprire la camera: ' + (e.message||e.name));
    }
    setStatus('Errore apertura');
    startBtn.disabled = false; stopBtn.disabled = true;
  }
}

async function stopCamera(){
  scanning = false;
  try{ video.pause(); }catch(_){}
  if (stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
  startBtn.disabled = false; stopBtn.disabled = true;
  setStatus('Fermato');
}

/* ========= ‚ÄúScanner‚Äù placeholder =========
   Qui NON eseguo decoding reale per concentrarci sul problema fotocamera.
   Quando la camera √® attiva, simulo il decode: se ‚Äúvede‚Äù qualcosa (frame), dopo 1s ‚Äútrova‚Äù un QR.
   Se vuoi il decode reale, rimetto html5-qrcode dopo che confermi che la camera parte.            */
let firstFoundIssued = false;
function tick(){
  if (!scanning || video.readyState < 2){ requestAnimationFrame(tick); return; }

  const w = video.videoWidth, h = video.videoHeight;
  if (!w || !h){ requestAnimationFrame(tick); return; }

  canvas.width = w; canvas.height = h;
  ctx.drawImage(video, 0, 0, w, h);

  // simulazione: dopo il primo frame attivo emettiamo un ‚Äúfound‚Äù una volta
  if (!firstFoundIssued){
    firstFoundIssued = true;
    setStatus('Scansione‚Ä¶');
    setTimeout(()=>{
      if (!scanning) return;
      // risultato finto (sostituisci con decoder reale in seguito)
      onQrFound(JSON.stringify({
        uid: 'user_ABC123',
        name: 'Mario Rossi',
        dob: '1999-05-20',
        ticketId: 'TCKT-001',
        type: 'Ingresso',
        status: 'attivo'
      }));
    }, 1200);
  }

  requestAnimationFrame(tick);
}

function onQrFound(text){
  scanning = false;
  setStatus('QR rilevato');
  lastResult = text;
  showActions(true);
}

/* ========= Azioni risultato ========= */
okBtn.onclick = ()=>{
  showActions(false);
  if (isGroup){ groupCount++; gCountEl.textContent = String(groupCount); }
  // riprendi
  firstFoundIssued = false;
  scanning = true;
  setStatus('Scansione attiva');
  tick();
};
flagBtn.onclick = ()=>{
  showActions(false);
  // riprendi
  firstFoundIssued = false;
  scanning = true;
  setStatus('Scansione attiva');
  tick();
};
againBtn.onclick = ()=>{
  showActions(false);
  firstFoundIssued = false;
  scanning = true;
  setStatus('Scansione attiva');
  tick();
};

/* ========= Fallback: fotocamera nativa iOS (input capture) ========= */
photoBtn.onclick = ()=> fileInput.click();
fileInput.onchange = async (e)=>{
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  // qui potresti passare l'immagine a un decoder; per ora simulo ‚Äútrovato‚Äù
  setStatus('Immagine acquisita, analisi‚Ä¶');
  setTimeout(()=> onQrFound('{"from":"photo","note":"decoded"}'), 400);
  fileInput.value = '';
};

/* ========= Bind comandi ========= */
startBtn.onclick = startCamera;
stopBtn.onclick  = stopCamera;

/* ========= Precheck ambiente ========= */
if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
  showErr('Questo browser non supporta getUserMedia. Usa Safari/Chrome aggiornato su iOS/Android.');
}
</script>
</body>
</html>
