<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Il tuo account â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12);--muted:rgba(255,255,255,.78);--ok:#22c55e;--danger:#ef4444}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
a{color:inherit;text-decoration:none}
.hidden{display:none}
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{margin-left:18px;opacity:.95}
nav a:hover{color:var(--accent)}
.wrap{max-width:1100px;margin:auto;padding:22px}
h1{font-size:34px;font-weight:900;letter-spacing:-.3px;margin-bottom:6px}
.kicker{color:var(--muted);margin-bottom:16px}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin:4px 0 18px}
.badge{background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;font-size:13px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:18px}
.card h2{font-size:20px;font-weight:900;margin-bottom:10px}
.muted{color:var(--muted)}
.ticket-list{display:grid;gap:10px}
.ticket{background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px}
.ticket .line{display:flex;justify-content:space-between;align-items:center}
.ticket .row{display:flex;gap:12px;align-items:center;margin-top:8px}
.empty{display:grid;place-items:center;min-height:160px;border:1px dashed rgba(255,255,255,.25);border-radius:12px}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;border:none;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.small{font-size:12px}
.modal-bd{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
input{background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60}
.modal{background:#0f0f10;border:1px solid var(--border);border-radius:14px;padding:18px;width:min(520px,92vw)}
.modal h3{font-size:18px;font-weight:900;margin-bottom:10px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.state{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
.state.ok{border-color:var(--ok);color:var(--ok)}
.state.bad{border-color:var(--danger);color:var(--danger)}
.notice{margin-top:6px;font-size:12px;opacity:.85}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span class="muted">Caricamentoâ€¦</span></nav>
  </div>
</header>

<main class="wrap">
  <h1 id="title">Il tuo account</h1>
  <div id="hello" class="kicker">Accesso in corso...</div>

  <div class="badges">
    <span class="badge">Sab 21 Mar 2026</span>
    <span class="badge">22:30 â†’ 04:30</span>
    <span class="badge">Via Italia 38, Biella</span>
  </div>

  <div class="grid">
    <section class="card">
      <h2>I tuoi biglietti</h2>
      <div id="tickets" class="ticket-list"></div>
      <div id="ticketsEmpty" class="empty hidden">
        <div style="text-align:center">
          <div class="muted" style="margin-bottom:10px">Non risultano biglietti attivi.</div>
          <a class="btn" href="./checkout.html">Compra ora il tuo biglietto</a>
        </div>
      </div>
    </section>

    <aside class="card">
      <h2>Profilo</h2>
      <div class="row" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.12)">
        <div class="lab" style="opacity:.8">Nome e cognome</div><div class="val" id="vName">â€”</div>
      </div>
      <div class="row" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.12)">
        <div class="lab" style="opacity:.8">Data di nascita</div><div class="val" id="vDob">â€”</div>
      </div>
      <div class="row" style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.12)">
        <div class="lab" style="opacity:.8">Email</div><div class="val" id="vEmail">â€”</div>
      </div>
      <div class="modal-bd">
        <button id="btnEdit" class="btn">Modifica profilo</button>
        <a class="btn ghost" href="./scanner.html">Area scanner (staff)</a>
      </div>
      <div class="notice">Il nominativo del biglietto si blocca alla generazione del QR. Puoi sbloccarlo una sola volta (4â‚¬) da qui sotto, per rigenerare il QR.</div>
    </aside>
  </div>

  <aside id="founderBox" class="card hidden" style="margin-top:16px">
    <span class="state ok">Founder</span>
    <h2>Pannello Founder</h2>
    <div id="founderHello" class="muted" style="margin-bottom:12px"></div>
    <div style="display:grid;gap:10px;grid-template-columns:repeat(3, minmax(200px, 1fr))">
      <a class="btn" href="./founder.html" style="text-align:center">Pannello</a>
      <a class="btn" href="./founder-gift.html" style="text-align:center">Crea omaggio</a>
      <a class="btn" href="./scanner.html" style="text-align:center">Scanner</a>
    </div>
  </aside>
</main>

<!-- MODAL profilo -->
<div id="modal" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Modifica profilo</h3>
    <div class="modal-bd">
      <label style="flex:1">Nome e cognome
        <input id="inpName" placeholder="Es. Mario Rossi" />
      </label>
      <label style="flex:1">Data di nascita
        <input id="inpDob" type="date" />
      </label>
      <label style="flex:1">Email (non modificabile)
        <input id="inpEmail" disabled />
      </label>
    </div>
    <div class="modal-actions">
      <button id="mCancel" class="btn ghost">Annulla</button>
      <button id="mSave" class="btn">Salva</button>
    </div>
  </div>
</div>

<script type="module">
  import { app, onUser, doSignOut, requireActiveUser } from './auth.v2.js?v=6';
  import {
    getFirestore, doc, getDoc, setDoc, collection, getDocs, serverTimestamp, updateDoc
  } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

  await requireActiveUser('./login.html');

  // UI
  const nav  = document.getElementById('navArea');
  const OUT  = `
    <a href="./login.html?from=./account-2.html">Acquista il tuo biglietto</a>
    <a href="./login.html">Accedi</a>
    <a href="./signup.html">Registrati</a>
  `;
  const IN = (u)=>`
    <span>ðŸ‘‹ Ciao, ${(u.displayName || (u.email?.split('@')[0]) || 'Utente').split(' ')[0]}</span>
    <a href="./checkout.html">Vai al checkout</a>
    <a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>
  `;

  const hello = document.getElementById('hello');
  const vName = document.getElementById('vName');
  const vDob  = document.getElementById('vDob');
  const vEmail= document.getElementById('vEmail');
  const ticketsWrap = document.getElementById('tickets');
  const ticketsEmpty= document.getElementById('ticketsEmpty');

  const founderBox   = document.getElementById('founderBox');
  const founderHello = document.getElementById('founderHello');

  const modal   = document.getElementById('modal');
  const btnEdit = document.getElementById('btnEdit');
  const mCancel = document.getElementById('mCancel');
  const mSave   = document.getElementById('mSave');
  const inpName = document.getElementById('inpName');
  const inpDob  = document.getElementById('inpDob');
  const inpEmail= document.getElementById('inpEmail');

  const db = getFirestore(app);

  const asDateStr = (dob) => {
    try {
      if(!dob) return 'â€”';
      if (/^\d{4}-\d{2}-\d{2}$/.test(dob)) return dob;
      const d = new Date(dob);
      if (isNaN(d)) return 'â€”';
      return d.toISOString().slice(0,10);
    } catch { return 'â€”'; }
  };

  function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }

  function lc(s){ return (s||'').toString().trim().toLowerCase(); }

  async function isFounderOrAdmin(email, uid){
    try{
      const [admins, me] = await Promise.all([
        getDoc(doc(db,'config','admins')).catch(()=>null),
        getDoc(doc(db,'users',uid)).catch(()=>null)
      ]);
      const m = admins && admins.exists()? (admins.data()||{}) : {};
      const founders=m.founders||{}, adminsMap=m.admins||{};
      const role = me && me.exists()? (me.data().role||'') : '';
      return !!( founders[lc(email)] || adminsMap[lc(email)] || role==='founder' || role==='admin' );
    }catch{ return false; }
  }

  // ---- TICKETS ----
  async function loadTickets(uid){
    const qSnap = await getDocs(collection(db,'users',uid,'tickets'));
    if (qSnap.empty){ ticketsWrap.innerHTML=''; ticketsEmpty.classList.remove('hidden'); return; }
    ticketsEmpty.classList.add('hidden');

    ticketsWrap.innerHTML='';
    qSnap.forEach(d=>{
      const t = { id:d.id, ...(d.data()||{}) };
      const state = (t.status||'pending').toLowerCase();
      const color =
        state==='verified' ? '#22c55e' :
        state==='flagged'  ? '#ef4444' :
        '#ffffff22';

      const box = document.createElement('div');
      box.className = 'ticket';
      box.style.border = `1px solid ${color}`;
      box.innerHTML = `
        <div class="line">
          <strong>${t.type||'Biglietto'}</strong>
          <span class="state ${state==='verified'?'ok':state==='flagged'?'bad':''}">${state}</span>
        </div>
        <div class="row">
          <div id="qr_${t.id}" style="width:120px;height:120px;border-radius:10px;background:#fff;display:grid;place-items:center"></div>
          <div class="small muted">
            <div><b>Nome</b>: ${t.name || 'â€”'}</div>
            <div><b>Nascita</b>: ${asDateStr(t.dob)}</div>
            <div><b>ID</b>: ${t.id}</div>
            <div class="notice">${t.locked ? 'Nominativo bloccato' : 'Nominativo modificabile'}</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              ${
                t.qr
                  ? ''
                  : `<button class="btn" data-gen="${t.id}">Genera QR e blocca</button>`
              }
              <button class="btn ghost" data-requnl="${t.id}">Sblocca nominativo (4â‚¬)</button>
              <button class="btn" data-edit="${t.id}">Cambia nominativo</button>
            </div>
          </div>
        </div>
      `;
      ticketsWrap.appendChild(box);

      // QR render se presente
      const payload = t.qr ? t.qr : JSON.stringify({ uid, tid: t.id, v:1 });
      new QRCode(document.getElementById(`qr_${t.id}`), { text: payload, width:110, height:110 });
    });

    // bind: genera QR (prima volta)
    ticketsWrap.querySelectorAll('[data-gen]').forEach(btn=>{
      btn.onclick = async ()=>{
        const tid = btn.getAttribute('data-gen');
        btn.disabled = true; btn.textContent='Creoâ€¦';
        const qr = JSON.stringify({ uid, tid, v:1 });
        await setDoc(doc(db,'users',uid,'tickets',tid), {
          qr, locked:true, updatedAt: serverTimestamp()
        }, { merge:true });
        location.reload();
      };
    });

    // bind: richiesta sblocco (simulazione pagamento 4â‚¬ -> unlockCredits=1)
    ticketsWrap.querySelectorAll('[data-requnl]').forEach(btn=>{
      btn.onclick = async ()=>{
        const tid = btn.getAttribute('data-requnl');
        if(!confirm('Confermi lo sblocco del nominativo (4â‚¬)? Dopo la modifica verrÃ  rigenerato il QR e non potrai cambiare ancora senza pagare di nuovo.')) return;
        // QUI integra il tuo pagamento reale; se ok:
        await setDoc(doc(db,'users',uid,'tickets',tid), {
          unlockCredits: 1, updatedAt: serverTimestamp()
        }, { merge:true });
        alert('Sblocco effettuato. Ora premi "Cambia nominativo".');
      };
    });

    // bind: cambio nominativo (consuma 1 credito e rilocka)
    ticketsWrap.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.onclick = async ()=>{
        const tid = btn.getAttribute('data-edit');
        const ref = doc(db,'users',uid,'tickets',tid);
        const snap = await getDoc(ref);
        if(!snap.exists()){ alert('Ticket non trovato.'); return; }
        const t = snap.data()||{};
        if (t.locked && !(t.unlockCredits>0)){
          alert('Nominativo bloccato. Sbloccalo prima (4â‚¬).'); return;
        }
        const name = prompt('Inserisci nome e cognome (come da documento):', t.name||'')?.trim();
        if(!name){ alert('Nome non valido'); return; }
        const dob  = prompt('Inserisci data di nascita (YYYY-MM-DD):', (t.dob && t.dob.slice(0,10)) || '')?.trim();
        if(!dob || !/^\d{4}-\d{2}-\d{2}$/.test(dob)){ alert('Data non valida'); return; }
        if(!confirm('Confermi che i dati corrispondono al documento? Dopo questa operazione il nominativo verrÃ  bloccato.')) return;

        const qr = JSON.stringify({ uid, tid, v:1 }); // generiamo sempre QR nuovo
        // Consumo credito di sblocco (regole lo richiedono): unlockCredits -> unlockCredits-1, locked true.
        await setDoc(ref, {
          name, dob, qr, locked:true,
          unlockCredits: Math.max( (t.unlockCredits||0) - 1, 0 ),
          updatedAt: serverTimestamp()
        }, { merge:true });
        alert('Dati aggiornati e QR rigenerato.');
        location.reload();
      };
    });
  }

  // Founder/admin?
  async function mountFounder(u){
    const ok = await isFounderOrAdmin(u.email||'', u.uid);
    if(!ok){ founderBox.classList.add('hidden'); return; }
    founderBox.classList.remove('hidden');
    founderHello.textContent = `Accesso staff abilitato per ${u.email}.`;
  }

  // --- BOOT ---
  onUser(async (u)=>{
    if(!u){
      nav.innerHTML = OUT;
      location.href = './login.html?from=./account-2.html';
      return;
    }
    nav.innerHTML = IN(u);
    document.getElementById('logoutLink')?.addEventListener('click', async(e)=>{
      e.preventDefault(); await doSignOut(); nav.innerHTML = OUT; location.href = './login.html?from=./account-2.html';
    });

    const userRef = doc(db,'users',u.uid);
    let snap = await getDoc(userRef);
    if(!snap.exists()){
      await setDoc(userRef, {
        uid:u.uid, email:(u.email||'').toLowerCase(), name:(u.displayName||u.email||'').trim(),
        name_lc:(u.displayName||u.email||'').trim().toLowerCase(),
        dob:'', role:'customer', status:'active', createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      }, { merge:true });
      snap = await getDoc(userRef);
    }
    const me = snap.data()||{};
    document.getElementById('title').textContent = 'Il tuo account';
    document.getElementById('hello').innerHTML = `Ciao, <strong>${(me.name || u.displayName || u.email || 'Utente').split(' ')[0]}</strong>`;
    vName.textContent  = me.name || (u.displayName || 'â€”');
    vDob.textContent   = asDateStr(me.dob || '');
    vEmail.textContent = me.email || u.email || 'â€”';
    inpName.value  = me.name  || (u.displayName || '');
    inpDob.value   = asDateStr(me.dob || '');
    inpEmail.value = me.email || u.email || '';

    await loadTickets(u.uid);
    await mountFounder(u);
  });

  // Modale profilo (non incide sui ticket giÃ  bloccati)
  btnEdit.addEventListener('click', ()=>{ openModal(); });
  mCancel.addEventListener('click', ()=>{ closeModal(); });
  mSave.addEventListener('click', async ()=>{
    const name = inpName.value.trim();
    const dob  = inpDob.value;
    if(!name){ alert('Inserisci nome e cognome.'); return; }
    const u = await new Promise(res=>onUser(res));
    await setDoc(doc(db,'users',u.uid), {
      name, name_lc:name.toLowerCase(), dob:dob||'', updatedAt: serverTimestamp()
    }, { merge:true });
    vName.textContent = name; vDob.textContent = dob||'â€”';
    closeModal();
  });
</script>
</body>
</html>
