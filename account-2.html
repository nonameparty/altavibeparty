<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Il tuo account â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000;--text:#fff;--accent:#8b5cf6;--border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.06);--muted:rgba(255,255,255,.78);
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1100px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
.wrap{max-width:1100px;margin:0 auto;padding:24px 20px}
h1{font-size:32px;font-weight:900;letter-spacing:-.2px;margin-bottom:8px}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 16px}
.badge{background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:13px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.h2{font-weight:900;font-size:22px;margin-bottom:8px}
.muted{color:var(--muted)}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;text-decoration:none;border:none;cursor:pointer}
.btn.outline{background:transparent;color:#fff;border:1px solid var(--accent)}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.row{display:flex;justify-content:space-between;gap:14px;margin:8px 0}
.k{opacity:.75}
.v{font-weight:800}
.ticket{display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;margin:8px 0;background:#0b0b0b}
.empty{display:flex;align-items:center;justify-content:space-between;background:#0b0b0b;border:1px dashed rgba(255,255,255,.2);border-radius:12px;padding:14px}
.alert{background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.4);border-radius:12px;padding:12px;font-size:14px;margin-bottom:10px}
.err{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4);border-radius:12px;padding:12px;margin-top:12px;font-size:14px}

/* form modifica */
.form{display:grid;gap:10px;margin-top:10px}
.input{background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.hidden{display:none}
.badge2{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:10px;font-size:12px}
.notice{font-size:13px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea" class="muted">Caricamentoâ€¦</nav>
  </div>
</header>

<main class="wrap">
  <h1 id="title">Il tuo account</h1>
  <div id="greeting" class="muted">Accesso in corso...</div>

  <div class="badges">
    <span class="badge">Sab 21 Mar 2026</span>
    <span class="badge">22:30 â†’ 04:30</span>
    <span class="badge">Via Italia 38, Biella</span>
  </div>

  <div class="grid">
    <!-- Biglietti -->
    <section class="card">
      <div class="h2">I tuoi biglietti</div>
      <div id="ticketsArea"></div>
    </section>

    <!-- Profilo -->
    <aside class="card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div class="h2">Profilo</div>
        <button id="editBtn" class="btn outline" style="padding:8px 12px;font-weight:800">Modifica</button>
      </div>

      <!-- view -->
      <div id="profileView">
        <div class="row"><div class="k">Nome e cognome</div><div id="pfName" class="v">â€”</div></div>
        <div class="row"><div class="k">Data di nascita</div><div id="pfDob" class="v">â€”</div></div>
        <div class="row"><div class="k">Email</div><div id="pfMail" class="v">â€”</div></div>
      </div>

      <!-- edit -->
      <form id="profileForm" class="form hidden" novalidate>
        <div class="row" style="gap:8px">
          <input id="inFirst" class="input" placeholder="Nome" style="flex:1">
          <input id="inLast" class="input" placeholder="Cognome" style="flex:1">
        </div>
        <div>
          <label class="badge2" for="inDob">Data di nascita</label>
          <input id="inDob" class="input" type="date" max="2100-12-31">
        </div>
        <div class="notice">Lâ€™email non Ã¨ modificabile da qui.</div>
        <div class="actions">
          <button id="saveBtn" type="submit" class="btn">Salva</button>
          <button id="cancelBtn" type="button" class="btn outline">Annulla</button>
        </div>
      </form>

      <div class="hr"></div>
      <button id="logoutBtn" class="btn outline">Logout</button>
    </aside>
  </div>

  <div id="errBox" class="err" style="display:none"></div>
</main>

<script type="module">
/* ====== IMPORT ====== */
import { app, onUser, doSignOut, loadProfile, setDisplayName, saveDOB } from './auth.v2.js?v=3';
import {
  getFirestore, doc, getDoc, setDoc, updateDoc,
  collection, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

/* ====== SETUP ====== */
const db = getFirestore(app);

const nav  = document.getElementById('navArea');
const greet= document.getElementById('greeting');
const pfName = document.getElementById('pfName');
const pfDob  = document.getElementById('pfDob');
const pfMail = document.getElementById('pfMail');
const ticketsArea = document.getElementById('ticketsArea');
const errBox = document.getElementById('errBox');

const editBtn = document.getElementById('editBtn');
const viewBox = document.getElementById('profileView');
const formBox = document.getElementById('profileForm');
const inFirst = document.getElementById('inFirst');
const inLast  = document.getElementById('inLast');
const inDob   = document.getElementById('inDob');
const saveBtn = document.getElementById('saveBtn');
const cancelBtn = document.getElementById('cancelBtn');

document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await doSignOut();
  location.href = './login.html?from=./account-2.html';
});

function showError(e){ console.error(e); errBox.style.display='block'; errBox.textContent = `Errore: ${e?.message || e}`; }
function fmtDOB(dob){ if(!dob) return 'â€”'; try{ const d=new Date(dob); return d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});}catch{return 'â€”';} }
function emptyCTA(){
  ticketsArea.innerHTML = `
    <div class="empty">
      <div>Non hai biglietti attivi.</div>
      <a class="btn" href="./checkout.html">Compra ora il tuo biglietto</a>
    </div>`;
}
function ticketCard(t){
  const lab = t.type || 'Ticket';
  const who = (t.holderName || 'â€”');
  const code = (t.code || t.ticketId || 'â€”');
  const status = (t.status || 'active');
  return `
    <div class="ticket">
      <div>
        <div style="font-weight:900">${lab}</div>
        <div class="muted" style="font-size:13px">Intestato a: ${who}</div>
      </div>
      <div style="text-align:right">
        <div class="muted" style="font-size:13px">Codice</div>
        <div style="font-weight:900">${code}</div>
        <div class="muted" style="font-size:12px;margin-top:4px">Stato: ${status}</div>
      </div>
    </div>`;
}

/* ====== STATO ====== */
let CURRENT_USER = null;
let CURRENT_NAME = '';
let CURRENT_DOB = null;

/* ====== CARICAMENTO ====== */
onUser(async (u)=>{
  try{
    if(!u){ location.href = './login.html?from=./account-2.html'; return; }
    CURRENT_USER = u;

    nav.innerHTML = `<span>ðŸ‘‹ Ciao, ${(u.displayName||u.email||'Utente').split(' ')[0]}</span>`;
    greet.innerHTML = `Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong>`;

    // profilo
    let name = (u.displayName || '').trim();
    let dob  = null;
    try{
      const snap = await getDoc(doc(db,'users',u.uid));
      if(snap.exists()){
        const d = snap.data();
        if(d?.name) name = d.name;
        if(d?.dob)  dob  = d.dob;
      }else{
        const local = loadProfile(u.uid);
        if(local?.dob) dob = local.dob;
      }
    }catch(e){ console.warn('Profilo Firestore non disponibile', e); }

    CURRENT_NAME = name || (u.email?.split('@')[0] || 'â€”');
    CURRENT_DOB  = dob || null;

    pfName.textContent = CURRENT_NAME;
    pfDob.textContent  = fmtDOB(CURRENT_DOB);
    pfMail.textContent = u.email || 'â€”';

    // ticket
    try{
      const qOrd = query(collection(db,'orders'), where('uid','==',u.uid), where('status','==','active'));
      const ordersSnap = await getDocs(qOrd);
      const allTickets = [];
      for(const docOrd of ordersSnap.docs){
        const tSnap = await getDocs(collection(db, `orders/${docOrd.id}/tickets`));
        tSnap.forEach(t => allTickets.push({ orderId: docOrd.id, ticketId: t.id, ...t.data() }));
      }
      if(allTickets.length === 0) emptyCTA();
      else ticketsArea.innerHTML = `
        <div class="alert">Mostra il QR allâ€™ingresso. Se hai attivato la protezione puoi cambiare nominativo fino a 48h prima.</div>
        ${allTickets.map(ticketCard).join('')}
      `;
    }catch(e){ console.warn('Ticket non disponibili', e); emptyCTA(); }

  }catch(e){ showError(e); }
});

/* ====== EDIT UI ====== */
editBtn.addEventListener('click', ()=>{
  if(!CURRENT_USER) return;
  viewBox.classList.add('hidden');
  formBox.classList.remove('hidden');

  // pre-compila
  const parts = (CURRENT_NAME || '').split(' ');
  inFirst.value = parts[0] || '';
  inLast.value  = parts.slice(1).join(' ') || '';
  inDob.value   = (CURRENT_DOB ? String(CURRENT_DOB).substring(0,10) : '');
});

cancelBtn.addEventListener('click', ()=>{
  formBox.reset();
  formBox.classList.add('hidden');
  viewBox.classList.remove('hidden');
});

/* ====== SALVA ====== */
formBox.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!CURRENT_USER) return;

  const first = inFirst.value.trim();
  const last  = inLast.value.trim();
  const dob   = inDob.value ? new Date(inDob.value).toISOString() : null;

  const fullName = [first,last].filter(Boolean).join(' ').trim();
  if(!fullName){ alert('Inserisci almeno nome o cognome'); return; }

  try{
    saveBtn.disabled = true;

    // 1) Firebase Auth (displayName)
    await setDisplayName(CURRENT_USER, fullName);

    // 2) Firestore users/{uid}
    await setDoc(doc(db,'users',CURRENT_USER.uid), { name: fullName, dob: dob }, { merge:true });

    // 3) Fallback locale (DOB) per coerenza con il resto del sito
    if(dob) saveDOB(CURRENT_USER.uid, dob);

    // 4) Propagazione facoltativa ai ticket intestati allâ€™utente
    try{
      const qOrd = query(collection(db,'orders'), where('uid','==',CURRENT_USER.uid), where('status','==','active'));
      const ords = await getDocs(qOrd);
      for(const ord of ords.docs){
        const tSnap = await getDocs(collection(db,`orders/${ord.id}/tickets`));
        for(const t of tSnap.docs){
          const td = t.data();
          // aggiorna solo i ticket il cui holderUid Ã¨ lâ€™utente (o se il nome coincide al vecchio)
          if(td.holderUid === CURRENT_USER.uid || td.holderName === CURRENT_NAME){
            await updateDoc(doc(db,`orders/${ord.id}/tickets/${t.id}`), {
              holderUid: CURRENT_USER.uid,
              holderName: fullName
            });
          }
        }
      }
    }catch(_e){ /* Ã¨ ok se le regole non permettono la scrittura */ }

    // 5) UI refresh
    CURRENT_NAME = fullName;
    CURRENT_DOB  = dob;
    pfName.textContent = CURRENT_NAME;
    pfDob.textContent  = fmtDOB(CURRENT_DOB);
    // nav + greeting
    nav.innerHTML = `<span>ðŸ‘‹ Ciao, ${first || (CURRENT_USER.email?.split('@')[0] || 'Utente')}</span>`;
    document.getElementById('greeting').innerHTML = `Ciao, <strong>${first || (CURRENT_USER.email?.split('@')[0] || 'Utente')}</strong>`;

    formBox.classList.add('hidden');
    viewBox.classList.remove('hidden');

  }catch(e){ showError(e); }
  finally{ saveBtn.disabled = false; }
});

/* ====== ERROR VISUAL ====== */
window.addEventListener('error', (ev)=>{ showError(ev.error || ev.message); });
window.addEventListener('unhandledrejection', (ev)=>{ showError(ev.reason || 'Promise rejection'); });
</script>
</body>
</html>
