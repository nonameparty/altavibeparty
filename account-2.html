<script type="module">
import { app, onUser, doSignOut } from './auth.v2.js';
import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// --- helpers UI ---
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const nameEl = $('#p_name');
const dobEl  = $('#p_dob');
const mailEl = $('#p_mail');
const helloH1 = $('#helloTitle');    // se ce l'hai, altrimenti ignora
const ticketsBox = $('#ticketsBox'); // contenitore sinistro
const ctaBuy = $('#ctaBuy');         // bottone "Compra ora il tuo biglietto" (crealo se non c'√®)

// fallback se non esistono questi ID:
function text(el, v){ if(el) el.textContent = v; }

// --- Firestore ---
const db = getFirestore(app);

// crea profilo minimo se manca
async function ensureUserDoc(u) {
  const ref = doc(db, 'users', u.uid);
  const snap = await getDoc(ref);
  if (!snap.exists()) {
    // Prova a derivare nome/cognome da displayName/email
    const baseName = (u.displayName || u.email || '').trim();
    await setDoc(ref, {
      uid: u.uid,
      name: baseName,
      dob: null,
      email: u.email || null,
      role: 'customer',
      createdAt: Date.now()
    });
    return (await getDoc(ref)).data();
  }
  return snap.data();
}

// carica ordini/ticket dell‚Äôutente (per ora: lista ‚Äúattivi‚Äù)
async function loadMyTickets(u) {
  // Esempio: ordini con stato=active
  const q = query(collection(db, 'orders'), where('uid', '==', u.uid), where('status', '==', 'active'));
  const qs = await getDocs(q);
  const items = [];
  for (const o of qs.docs) {
    const orderId = o.id;
    const tRef = collection(db, `orders/${orderId}/tickets`);
    const tQs = await getDocs(tRef);
    tQs.forEach(t => items.push({ orderId, ticketId: t.id, ...t.data() }));
  }
  return items;
}

// renderizza sezione ‚ÄúI tuoi biglietti‚Äù
function renderTickets(tickets){
  if(!tickets || tickets.length===0){
    ticketsBox.innerHTML = `
      <div class="muted">Nessun biglietto attivo al momento.</div>
      <div style="margin-top:12px">
        <a id="buyNow" class="btn" href="./checkout.html">Compra ora il tuo biglietto</a>
      </div>
    `;
    return;
  }
  ticketsBox.innerHTML = tickets.map(t => `
    <div class="card" style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900">${t.type || 'Ticket'}</div>
          <div class="muted" style="font-size:13px">${t.holderName || '‚Äî'} ‚Ä¢ ${t.holderEmail || '‚Äî'}</div>
        </div>
        <div class="badge">QR disponibile</div>
      </div>
    </div>
  `).join('');
}

// render profilo
function renderProfile(userDoc, authUser){
  const full = userDoc?.name || (authUser.displayName || '');
  text(nameEl,  full || '‚Äî');
  text(dobEl,   userDoc?.dob ? new Date(userDoc.dob).toLocaleDateString('it-IT') : '‚Äî');
  text(mailEl,  authUser.email || '‚Äî');
  const first = (full || authUser.email || 'ospite').split(' ')[0];
  if(helloH1) helloH1.innerHTML = `Ciao, <strong>${first}</strong>`;
}

// main
function boot(){
  const nav = $('#navArea');
  const OUT = `<a href="./login.html?from=./account-2.html">Accedi</a> <a href="./signup.html">Registrati</a>`;
  const IN  = (u)=> `<span>üëã Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong></span>
                     <a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>`;

  onUser(async (u)=>{
    if(!u){
      if(nav) nav.innerHTML = OUT;
      // mostra ‚ÄúAccesso in corso‚Ä¶‚Äù gi√† presente, poi redirect volendo
      return;
    }
    if(nav){
      nav.innerHTML = IN(u);
      $('#logoutLink')?.addEventListener('click', async (e)=>{ e.preventDefault(); await doSignOut(); location.href='./login.html?from=./account-2.html'; });
    }

    // carica/crea profilo e render
    const userDoc = await ensureUserDoc(u);
    renderProfile(userDoc, u);

    // carica biglietti
    try{
      const tickets = await loadMyTickets(u);
      renderTickets(tickets);
    }catch(err){
      console.warn('Tickets non disponibili (ok in demo):', err);
      renderTickets([]); // cos√¨ appare il bottone "Compra ora..."
    }
  });
}

boot();
</script>
