<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Il tuo account â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--accent:#8b5cf6;--bg:#000;--text:#fff;--muted:rgba(255,255,255,.78);--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--ok:#22c55e}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}

.wrap{max-width:1100px;margin:auto;padding:24px}
h1{font-size:clamp(26px,4vw,36px);font-weight:900;letter-spacing:-.2px;margin-bottom:6px}
.subtitle{color:var(--muted)}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
.badge{background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:13px}

.grid{display:grid;gap:16px;margin-top:16px;grid-template-columns:1fr}
@media(min-width:980px){.grid{grid-template-columns:2fr 1fr}}

.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.card h2{font-size:20px;font-weight:900;margin-bottom:8px}

.empty{border:1px dashed var(--border);border-radius:14px;padding:18px}
.empty h3{font-weight:900;margin-bottom:6px}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;text-decoration:none;border:none;cursor:pointer}

.small{font-size:13px;color:var(--muted)}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.list{display:grid;gap:10px}

.row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;border:1px solid rgba(255,255,255,.12);background:#0b0b0b;border-radius:12px;padding:12px}
.ticket-title{font-weight:900}
.ticket-note{font-size:13px;color:rgba(255,255,255,.88)}
.ticket-right{text-align:right}
.qr{width:76px;height:76px;border-radius:10px;background:#111;border:1px solid var(--border);display:grid;place-items:center;font-size:11px;color:var(--muted)}

.profile-grid{display:grid;grid-template-columns:1fr;gap:8px}
.profile-row{display:grid;grid-template-columns:140px 1fr;gap:10px}
.k{font-size:12px;letter-spacing:.4px;text-transform:uppercase;color:rgba(255,255,255,.6)}
.v{font-weight:900}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span class="subtitle">Caricamentoâ€¦</span></nav>
  </div>
</header>

<main class="wrap">
  <h1 id="hello">Il tuo account</h1>
  <div class="subtitle" id="helloSub">Accesso in corsoâ€¦</div>

  <div class="badges">
    <span class="badge">Sab 21 Mar 2026</span>
    <span class="badge">22:30 â†’ 04:30</span>
    <span class="badge">Via Italia 38, Biella</span>
  </div>

  <div class="grid">
    <!-- SINISTRA: biglietti -->
    <section class="card">
      <h2>I tuoi biglietti</h2>
      <p id="ticketsHint" class="small" style="display:none">
        Mostra il QR allâ€™ingresso. Se hai attivato la protezione, puoi cambiare nominativo fino a 48h prima.
      </p>

      <div id="ticketsList" class="list" style="margin-top:12px"></div>

      <div id="emptyState" class="empty" style="display:none">
        <h3>Compra ora il tuo biglietto</h3>
        <p class="small">Scegli la prevendita e blocca lâ€™ingresso alla serata.</p>
        <div style="margin-top:10px"><a class="btn" href="./checkout.html">Acquista</a></div>
      </div>
    </section>

    <!-- DESTRA: profilo -->
    <aside class="card">
      <h2>Profilo</h2>
      <div id="profileBox">
        <div class="profile-grid">
          <div class="profile-row"><div class="k">Nome e cognome</div><div class="v" id="pfName">â€”</div></div>
          <div class="profile-row"><div class="k">Data di nascita</div><div class="v" id="pfDob">â€”</div></div>
          <div class="profile-row"><div class="k">Email</div><div class="v" id="pfEmail">â€”</div></div>
        </div>
      </div>
    </aside>
  </div>
</main>

<script type="module">
/* ======= Auth + Firestore ======= */
import { app as appFromAuth, onUser, doSignOut } from './auth.v2.js?v=3';
import { getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, serverTimestamp,
  collection, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = appFromAuth || getApp();
const db  = getFirestore(app);

const nav  = document.getElementById('navArea');
const hello= document.getElementById('hello');
const helloSub = document.getElementById('helloSub');

const pfName = document.getElementById('pfName');
const pfDob  = document.getElementById('pfDob');
const pfEmail= document.getElementById('pfEmail');

const ticketsHint = document.getElementById('ticketsHint');
const ticketsList = document.getElementById('ticketsList');
const emptyState  = document.getElementById('emptyState');

const OUT = `<a href="./login.html?from=./account-2.html">Accedi</a> <a href="./signup.html">Registrati</a>`;
const IN  = (u)=>`<span>ðŸ‘‹ Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong></span>
                  <a href="./checkout.html">Vai al checkout</a>
                  <a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>`;

function fmtDOB(iso){
  if(!iso) return 'â€”';
  const d = new Date(iso);
  if(isNaN(d.getTime())) return iso;
  return d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
}

async function ensureUserDoc(u){
  const uref = doc(db, 'users', u.uid);
  const snap = await getDoc(uref);
  if(!snap.exists()){
    const parts = (u.displayName||'').trim().split(' ');
    const firstName = parts[0] || '';
    const lastName  = parts.slice(1).join(' ') || '';
    await setDoc(uref, {
      uid: u.uid,
      email: u.email || '',
      firstName, lastName, dob: '',
      createdAt: serverTimestamp()
    }, { merge: true });
    return { firstName, lastName, dob:'', email:u.email||'' };
  }
  return snap.data();
}

async function renderFor(u){
  nav.innerHTML = IN(u);
  document.getElementById('logoutLink')?.addEventListener('click', async (e)=>{ e.preventDefault(); await doSignOut(); });

  const first = (u.displayName||u.email||'Utente').split(' ')[0];
  helloSub.innerHTML  = `Ciao, <strong>${first}</strong> â€” ecco i tuoi biglietti.`;

  // profilo
  const ud = await ensureUserDoc(u);
  pfName.textContent  = (ud.firstName||ud.lastName) ? `${ud.firstName||''} ${ud.lastName||''}`.trim() : (u.displayName||'â€”');
  pfDob.textContent   = fmtDOB(ud.dob||'');
  pfEmail.textContent = u.email || ud.email || 'â€”';

  // ordini/ticket
  const q = query(collection(db, 'orders'), where('uid','==',u.uid));
  const os = await getDocs(q);

  if(os.empty){
    ticketsHint.style.display = 'none';
    emptyState.style.display  = 'block';
    ticketsList.innerHTML = '';
    return;
  }

  let html = '';
  let any = false;
  for(const o of os.docs){
    const ts = await getDocs(collection(db,'orders',o.id,'tickets'));
    ts.forEach(t=>{
      any = true;
      const d = t.data();
      const map = {EB:'Early Bird', STD:'Standard', FAST:'Fast Entry', VIP:'VIP Entry'};
      const title = map[d.type] || d.type;
      const holder = `${d.holderName||'-'} ${d.holderSurname||''}`.trim();
      const mail   = d.holderEmail || '';
      const prot   = d.protection ? ' â€¢ Protezione attiva' : '';
      html += `<div class="row">
        <div>
          <div class="ticket-title">${title}</div>
          <div class="ticket-note">Intestatario: <strong>${holder||'â€”'}</strong> â€¢ ${mail||'â€”'}${prot}</div>
        </div>
        <div class="ticket-right"><div class="qr">QR</div></div>
      </div>`;
    });
  }
  if(any){
    ticketsHint.style.display = 'block';
    emptyState.style.display  = 'none';
    ticketsList.innerHTML = html;
  }else{
    ticketsHint.style.display = 'none';
    emptyState.style.display  = 'block';
    ticketsList.innerHTML = '';
  }
}

/* ---- Login flow robusto ---- */
function start(){
  let resolved = false;

  onUser(async (u)=>{
    resolved = true;
    if(!u){ nav.innerHTML = OUT; location.href='./login.html?from=./account-2.html'; return; }
    await renderFor(u);
  });

  // fallback dopo 2s se il wrapper non chiama
  setTimeout(async ()=>{
    if(resolved) return;
    const auth = getAuth();
    const u = auth.currentUser;
    if(!u){ nav.innerHTML = OUT; location.href='./login.html?from=./account-2.html'; return; }
    await renderFor(u);
  }, 2000);
}
start();
</script>
</body>
</html>
