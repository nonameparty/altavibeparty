<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Il tuo account â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
:root{--accent:#8b5cf6;--border:rgba(255,255,255,.12);--muted:rgba(255,255,255,.78);
  --ok:#22c55e;--warn:#f59e0b;--pending:#9ca3af}
*{box-sizing:border-box;margin:0;padding:0}
body{background:#000;color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh;display:grid;grid-template-rows:auto 1fr}
a{color:inherit;text-decoration:none}
.hidden{display:none}
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{margin-left:18px;opacity:.95}
nav a:hover{color:var(--accent)}
.wrap{max-width:1100px;margin:auto;padding:22px}
h1{font-size:34px;font-weight:900;letter-spacing:-.3px;margin-bottom:6px}
.kicker{color:var(--muted);margin-bottom:16px}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin:4px 0 18px}
.badge{background:#0f0f10;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;font-size:13px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:16px;padding:18px}
.card h2{font-size:20px;font-weight:900;margin-bottom:10px}
.muted{color:var(--muted)}
.ticket-list{display:grid;gap:10px}
.ticket{background:#0b0b0b;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px;display:grid;gap:8px}
.ticket .line{display:flex;justify-content:space-between;align-items:center}
.chip{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:4px 10px;border:1px solid #333;font-size:12px}
.chip.pending{background:#0f1115;color:#fff;border-color:#3b3b3b}
.chip.confirmed{background:rgba(34,197,94,.15);color:#b7ffcc;border-color:#2b7a3f}
.chip.flagged{background:rgba(245,158,11,.15);color:#ffe1a4;border-color:#8a6516}
.qr{display:grid;place-items:center;border-radius:12px;padding:10px;border:1px dashed rgba(255,255,255,.18)}
.qr.confirmed{background:rgba(34,197,94,.12)}
.qr.flagged{background:rgba(245,158,11,.12)}
.empty{display:grid;place-items:center;min-height:160px;border:1px dashed rgba(255,255,255,.25);border-radius:12px}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;cursor:pointer;border:none}
.btn.ghost{background:transparent;border:1px solid var(--border);color:#fff}
.row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
.row:last-child{border-bottom:none}
.lab{opacity:.8}
.val{font-weight:800}
.actions{display:flex;gap:10px;margin-top:14px}
.badge-admin{display:inline-block;padding:6px 10px;border:1px solid var(--accent);border-radius:999px;font-size:12px;margin-bottom:10px}
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#0f0f10;border:1px solid var(--border);border-radius:14px;padding:18px;width:min(520px,92vw)}
.modal h3{font-size:18px;font-weight:900;margin-bottom:10px}
.modal .grid{display:grid;grid-template-columns:1fr;gap:10px}
input{background:#0f0f10;border:1px solid var(--border);border-radius:10px;color:#fff;padding:10px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.notice{margin:10px 0;padding:12px;border-radius:10px;background:#2a1e0a;border:1px solid #8a6516;color:#ffdca6}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span class="muted">Caricamentoâ€¦</span></nav>
  </div>
</header>

<main class="wrap">
  <h1 id="title">Il tuo account</h1>
  <div id="hello" class="kicker">Accesso in corso...</div>

  <div class="badges">
    <span class="badge">Sab 21 Mar 2026</span>
    <span class="badge">22:30 â†’ 04:30</span>
    <span class="badge">Via Italia 38, Biella</span>
  </div>

  <div id="lockNotice" class="notice hidden"></div>

  <div class="grid">
    <section class="card">
      <h2>I tuoi biglietti</h2>
      <div id="tickets" class="ticket-list"></div>
      <div id="ticketsEmpty" class="empty hidden">
        <div style="text-align:center">
          <div class="muted" style="margin-bottom:10px">Non risultano biglietti attivi.</div>
          <a class="btn" href="./checkout.html">Compra ora il tuo biglietto</a>
        </div>
      </div>
    </section>

    <aside class="card">
      <h2>Profilo</h2>
      <div class="row"><div class="lab">Nome e cognome</div><div class="val" id="vName">â€”</div></div>
      <div class="row"><div class="lab">Data di nascita</div><div class="val" id="vDob">â€”</div></div>
      <div class="row"><div class="lab">Email</div><div class="val" id="vEmail">â€”</div></div>
      <div class="actions">
        <button id="btnEdit" class="btn">Modifica dati</button>
      </div>
    </aside>
  </div>

  <aside id="founderBox" class="card hidden" style="margin-top:16px">
    <span class="badge-admin">Founder</span>
    <h2>Pannello Founder</h2>
    <div id="founderHello" class="muted" style="margin-bottom:12px"></div>
    <div style="display:grid;gap:10px;grid-template-columns:repeat(2, minmax(200px, 1fr))">
      <a class="btn" href="./founder.html" style="text-align:center">Apri pannello</a>
      <a class="btn" href="./checkout.html" style="text-align:center">Nuovo ordine</a>
    </div>
  </aside>
</main>

<div id="modal" class="backdrop" aria-hidden="true">
  <div class="modal">
    <h3>Modifica profilo</h3>
    <div class="grid">
      <label>Nome e cognome
        <input id="inpName" placeholder="Es. Mario Rossi" />
      </label>
      <label>Data di nascita
        <input id="inpDob" type="date" />
      </label>
      <label>Email (non modificabile)
        <input id="inpEmail" disabled />
      </label>
    </div>
    <div class="modal-actions">
      <button id="mCancel" class="btn ghost">Annulla</button>
      <button id="mSave" class="btn">Salva</button>
    </div>
  </div>
</div>

<script type="module">
  import { app, onUser, doSignOut, requireActiveUser } from './auth.v2.js?v=6';
  import {
    getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

  await requireActiveUser('./login.html');

  const db = getFirestore(app);

  // UI
  const nav  = document.getElementById('navArea');
  const OUT  = `
    <a href="./login.html?from=./account-2.html">Acquista il tuo biglietto</a>
    <a href="./login.html">Accedi</a>
    <a href="./signup.html">Registrati</a>`;
  const IN = (u)=>`
    <span>ðŸ‘‹ Ciao, ${(u.displayName || (u.email?.split('@')[0]) || 'Utente').split(' ')[0]}</span>
    <a href="./checkout.html">Vai al checkout</a>
    <a href="#" id="logoutLink" style="color:#8b5cf6">Logout</a>`;

  const hello = document.getElementById('hello');
  const title = document.getElementById('title');
  const vName = document.getElementById('vName');
  const vDob  = document.getElementById('vDob');
  const vEmail= document.getElementById('vEmail');
  const ticketsWrap = document.getElementById('tickets');
  const ticketsEmpty= document.getElementById('ticketsEmpty');
  const founderBox   = document.getElementById('founderBox');
  const founderHello = document.getElementById('founderHello');
  const lockNotice   = document.getElementById('lockNotice');

  const modal   = document.getElementById('modal');
  const btnEdit = document.getElementById('btnEdit');
  const mCancel = document.getElementById('mCancel');
  const mSave   = document.getElementById('mSave');
  const inpName = document.getElementById('inpName');
  const inpDob  = document.getElementById('inpDob');
  const inpEmail= document.getElementById('inpEmail');

  const asDateStr = (dob) => {
    try {
      if(!dob) return 'â€”';
      if (/^\d{4}-\d{2}-\d{2}$/.test(dob)) return dob;
      const d = new Date(dob);
      if (isNaN(d)) return 'â€”';
      return d.toISOString().slice(0,10);
    } catch { return 'â€”'; }
  };

  function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }

  // QR content builder
  function qrPayload(uid, t){
    // JSON con uid/ticketId/name/dob (scanner li usa)
    return JSON.stringify({
      uid,
      ticketId: t.id || t.ticketId || '',
      name: t.name || '',
      dob: t.dob || ''
    });
  }

  function ticketChip(status){
    const s = (status||'pending').toLowerCase();
    const cls = s==='confirmed'?'confirmed': s==='flagged'?'flagged':'pending';
    const label = s==='confirmed'?'confermato': (s==='flagged'?'segnalato':'pending');
    return `<span class="chip ${cls}">Stato: <b>${label}</b></span>`;
  }

  function qrClass(status){
    const s = (status||'pending').toLowerCase();
    if (s==='confirmed') return 'qr confirmed';
    if (s==='flagged')   return 'qr flagged';
    return 'qr';
  }

  async function renderTickets(uid){
    // live
    const unsub = onSnapshot(collection(db,'users',uid,'tickets'), (snap)=>{
      const arr = [];
      snap.forEach(d=>arr.push({ id:d.id, ...d.data() }));
      ticketsWrap.innerHTML = '';
      if (!arr.length){
        ticketsEmpty.classList.remove('hidden');
        lockNotice.classList.add('hidden');
        return;
      }
      ticketsEmpty.classList.add('hidden');

      // Se esiste almeno un ticket locked, blocca modifiche nominativi
      const anyLocked = arr.some(t=> t.locked===true);
      if (anyLocked){
        const canRelock = arr.some(t=> t.canRelock===true); // una sola volta
        lockNotice.classList.remove('hidden');
        lockNotice.innerHTML = canRelock
          ? 'Hai sbloccato una volta i nominativi. Se confermi ora, non potrai piÃ¹ cambiare senza un nuovo pagamento.'
          : 'I nominativi sono bloccati perchÃ© il QR Ã¨ stato generato. Puoi sbloccare <b>una sola volta</b> (4â‚¬).';
        btnEdit.disabled = !canRelock; // se non ha ancora pagato sblocco: disabilita (collega alla tua cassa)
      } else {
        lockNotice.classList.add('hidden');
        btnEdit.disabled = false;
      }

      arr.forEach(t=>{
        const div = document.createElement('div');
        div.className = 'ticket';
        div.innerHTML = `
          <div class="line"><strong>${t.type || 'Biglietto'}</strong><span>${ticketChip(t.status)}</span></div>
          <div class="line"><span class="muted">ID</span><span>${t.id}</span></div>
          <div class="${qrClass(t.status)}"><canvas id="qr_${t.id}" width="180" height="180"></canvas></div>
          <div class="muted">Nome: <b>${t.name || 'â€”'}</b> â€¢ DOB: <b>${asDateStr(t.dob||'')}</b></div>
        `;
        ticketsWrap.appendChild(div);
        // genera QR
        const c = div.querySelector('#qr_'+t.id);
        try{
          window.QRCode.toCanvas(c, qrPayload(uid,t), { errorCorrectionLevel:'M', margin:1 }, (err)=>{ if(err) console.error(err); });
        }catch(e){ console.error(e); }
      });
    });
    return unsub;
  }

  async function isFounder(email){
    try{
      const snap = await getDoc(doc(db,'config','admins'));
      const founders = snap.exists() ? (snap.data().founders || {}) : {};
      return !!founders[(email||'').toLowerCase()];
    }catch(_){ return false; }
  }

  onUser(async (u)=>{
    if(!u){
      nav.innerHTML = OUT;
      const back = encodeURIComponent(location.pathname + location.search);
      location.href = `./login.html?from=${back}`;
      return;
    }
    nav.innerHTML = IN(u);
    document.getElementById('logoutLink')?.addEventListener('click', async(e)=>{
      e.preventDefault(); await doSignOut(); nav.innerHTML = OUT; location.href = './login.html?from=./account-2.html';
    });

    title.textContent = 'Il tuo account';
    hello.innerHTML = `Ciao, <strong>${(u.displayName || u.email || 'Utente').split(' ')[0]}</strong>`;

    // /users/{uid}
    const uref = doc(db,'users',u.uid);
    let usnap = await getDoc(uref);
    if(!usnap.exists()){
      await setDoc(uref, {
        uid: u.uid,
        email: (u.email||'').toLowerCase(),
        name:  (u.displayName || u.email || '').trim(),
        name_lc: (u.displayName || u.email || '').trim().toLowerCase(),
        dob:   '',
        role:  'customer',
        status:'active',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });
      usnap = await getDoc(uref);
    }
    const data = usnap.data() || {};
    vName.textContent  = data.name  || (u.displayName || 'â€”');
    vDob.textContent   = asDateStr(data.dob || '');
    vEmail.textContent = data.email || u.email || 'â€”';
    inpName.value  = data.name  || (u.displayName || '');
    inpDob.value   = asDateStr(data.dob || '');
    inpEmail.value = data.email || u.email || '';

    await renderTickets(u.uid);

    const founderOk = (data.role === 'founder') || await isFounder(u.email);
    if(founderOk){
      founderBox.classList.remove('hidden');
      founderHello.textContent = `Ciao ${data.name || (u.displayName || u.email)}, puoi gestire utenti e statistiche.`;
    }else{
      founderBox.classList.add('hidden');
    }
  });

  // Modifica profilo (bloccata se locked e non ha pagato sblocco)
  btnEdit.addEventListener('click', openModal);
  mCancel.addEventListener('click', closeModal);
  mSave.addEventListener('click', async ()=>{
    const name = (inpName.value||'').trim();
    const dob  = inpDob.value;
    if(!name){ alert('Inserisci nome e cognome.'); return; }

    const user = await new Promise(res=>onUser(res));
    if(!user) return;

    await setDoc(doc(db, 'users', user.uid), {
      name,
      name_lc: name.toLowerCase(),
      dob: dob || '',
      updatedAt: serverTimestamp()
    }, { merge:true });

    vName.textContent = name;
    vDob.textContent  = asDateStr(dob);
    closeModal();
  });
</script>
</body>
</html>
