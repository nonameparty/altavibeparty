<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Il tuo account â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{--accent:#8b5cf6;--accent-weak:rgba(139,92,246,.12);--bg:#000;--text:#fff;
--card:rgba(255,255,255,.06);--border:rgba(255,255,255,.12);--muted:rgba(255,255,255,.78);
--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;
--c-eb:#8b5cf6;--c-std:#60a5fa;--c-fast:#34d399;--c-vip:#f59e0b}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
a{color:inherit}
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1200px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:-.3px}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
nav a, nav span{color:#fff;text-decoration:none;margin-left:18px;font-size:14px;opacity:.95}
nav a:hover{color:var(--accent)}

.wrap{max-width:1100px;margin:auto;padding:20px}
h1{font-size:28px;font-weight:900;letter-spacing:-.2px}
.kicker{opacity:.9;margin:8px 0 16px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.badge{background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:13px}
.badge.role{border-color:var(--accent);}

.grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.section-title{font-weight:900;margin-bottom:8px;font-size:18px}

.ticket-list{display:grid;gap:12px}
.ticket{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;background:#0b0b0b;border:1px solid var(--border);border-radius:12px;padding:14px}
.ticket .title{font-weight:900;display:flex;align-items:center;gap:8px}
.tlabel{padding:3px 8px;border-radius:8px;border:1px solid currentColor;font-size:12px;font-weight:800}
.tlabel.eb{color:var(--c-eb)} .tlabel.std{color:var(--c-std)} .tlabel.fast{color:var(--c-fast)} .tlabel.vip{color:var(--c-vip)}
.tinfo{font-size:13px;color:var(--muted);margin-top:6px}
.tactions{display:flex;align-items:center;gap:8px}
.btn{display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#111;color:#fff;font-weight:800;text-decoration:none;cursor:pointer}
.btn.primary{background:var(--accent);color:#000;border:none}
.btn.ghost{background:transparent}

.note{font-size:13px;opacity:.85;margin-top:8px}
.hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
.small{font-size:13px;opacity:.75}

.empty{display:grid;place-items:center;border:1px dashed var(--border);border-radius:16px;padding:24px;color:var(--muted)}

.qr-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px}
.qr-card{background:#0b0b0b;border:1px solid var(--border);border-radius:16px;padding:18px;max-width:360px;width:100%}
.qr-card h3{font-weight:900;margin-bottom:8px}
.qr-actions{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.close{cursor:pointer;opacity:.85}
</style>
</head>
<body>

<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea"><span class="small">Caricamentoâ€¦</span></nav>
  </div>
</header>

<main class="wrap">
  <h1 id="hello">Il tuo account</h1>
  <div class="kicker" id="subtitle">Gestisci biglietti, QR e dati personali.</div>
  <div class="badges" id="roleBadges">
    <span class="badge role">Ruolo: <strong>&nbsp;â€”</strong></span>
    <span class="badge">Sab 21 Mar 2026</span>
    <span class="badge">22:30 â†’ 04:30</span>
    <span class="badge">Via Italia 38, Biella</span>
  </div>

  <div class="grid">
    <!-- SINISTRA: biglietti -->
    <section class="card">
      <div class="section-title">I tuoi biglietti</div>
      <div id="tickets" class="ticket-list"></div>
      <div id="ticketsEmpty" class="empty" style="display:none">
        <div>
          <div style="font-weight:900;margin-bottom:6px">Nessun biglietto attivo</div>
          <div class="small">Acquista ora la tua prevendita per TRAPPERREO.</div>
          <div style="margin-top:12px"><a class="btn primary" href="./checkout.html">Acquista ora</a></div>
        </div>
      </div>
      <div class="note">Mostra il QR allâ€™ingresso. Se hai attivato la protezione, puoi cambiare nominativo fino a 48h prima.</div>
    </section>

    <!-- DESTRA: profilo/azioni -->
    <aside class="card">
      <div class="section-title">Profilo</div>
      <div id="profileBox" class="small">Caricamento profiloâ€¦</div>
      <div class="hr"></div>
      <a class="btn" href="./checkout.html">Compra un altro biglietto</a>
      <a class="btn ghost" href="./account.html">Versione classica</a>
    </aside>
  </div>
</main>

<!-- Modal QR -->
<div id="qrModal" class="qr-modal" role="dialog" aria-modal="true" aria-labelledby="qrTitle">
  <div class="qr-card">
    <h3 id="qrTitle">Il tuo QR</h3>
    <canvas id="qrCanvas" style="display:block;margin:auto;border-radius:8px;background:#fff;padding:8px"></canvas>
    <div class="qr-actions">
      <span class="small" id="qrHint">Mostralo in cassa</span>
      <button class="btn" id="qrClose">Chiudi</button>
    </div>
  </div>
</div>

<!-- QR generator (piccolo, gratuito) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

<script type="module">
/* --------------------------------------------------
   Auth + Firestore (riuso del tuo setup)
-------------------------------------------------- */
import { onUser } from './auth.v2.js?v=3';
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ---- Config tua (uguale a checkout) ----
const firebaseConfig = {
  apiKey: "AIzaSyDF6BiYXreDirGnT3RPkGwDNlwj5ploUyo",
  authDomain: "trappereo.firebaseapp.com",
  projectId: "trappereo",
  storageBucket: "trappereo.firebasestorage.app",
  messagingSenderId: "767231932063",
  appId: "1:767231932063:web:b1431de1c04bbe5dc0d4aa",
  measurementId: "G-BDBRZQ6J8S"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* --------------------------------------------------
   UI helpers
-------------------------------------------------- */
const nav = document.getElementById('navArea');
const hello = document.getElementById('hello');
const subtitle = document.getElementById('subtitle');
const ticketsBox = document.getElementById('tickets');
const ticketsEmpty = document.getElementById('ticketsEmpty');
const roleBadges = document.getElementById('roleBadges');
const profileBox = document.getElementById('profileBox');

const qrModal = document.getElementById('qrModal');
const qrCanvas = document.getElementById('qrCanvas');
const qrClose  = document.getElementById('qrClose');

function money(n){ return n.toFixed(2).replace('.00','')+'â‚¬'; }
function typeLabel(t){
  switch(t){
    case 'EB':   return ['Early Bird','eb'];
    case 'STD':  return ['Standard','std'];
    case 'FAST': return ['Fast Entry','fast'];
    case 'VIP':  return ['VIP Entry','vip'];
    default: return [t,'std'];
  }
}
function fmtName(n,s){ return [n||'',s||''].filter(Boolean).join(' ') || 'â€”'; }

/* --------------------------------------------------
   Carica ruolo + biglietti dell'utente
-------------------------------------------------- */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href = './login.html?from=./account-2.html'; return; }

  // Nav semplice
  nav.innerHTML = `<span>ðŸ‘‹ Ciao, ${(u.displayName||u.email||'Utente').split(' ')[0]}</span>
                   <a href="./checkout.html">Vai al checkout</a>`;

  hello.textContent = `Il tuo account`;
  subtitle.innerHTML = `Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong> â€” ecco i tuoi biglietti.`;

  // ---- Ruolo (users/{uid}.role) ----
  let role = 'customer';
  try {
    const rd = await getDoc(doc(db,'users',u.uid));
    if (rd.exists() && rd.data().role) role = rd.data().role;
  } catch {}
  roleBadges.querySelector('.role strong').textContent = ' ' + role;

  // ---- Ordini dell'utente ----
  const qOrders = query(collection(db,'orders'), where('uid','==',u.uid));
  const ordersSnap = await getDocs(qOrders);

  const allTickets = [];
  for (const o of ordersSnap.docs){
    const orderId = o.id;
    // subcollection tickets
    const tSnap = await getDocs(collection(db,'orders',orderId,'tickets'));
    tSnap.forEach(t=>{
      const d=t.data();
      allTickets.push({ id:t.id, orderId, ...d });
    });
  }

  // Render
  if(allTickets.length===0){
    ticketsEmpty.style.display = 'grid';
  } else {
    ticketsBox.innerHTML = '';
    // ordina recenti (se createdAt non indicizzato â†’ nessun problema)
    allTickets.sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    for(const t of allTickets){
      const [label, cls] = typeLabel(t.type);
      const prot = t.protection ? `<span class="badge" style="border-color:var(--ok);color:var(--ok)">Protezione</span>` : '';
      const status = t.status || 'active';

      const row = document.createElement('div');
      row.className = 'ticket';
      row.innerHTML = `
        <div>
          <div class="title">${label} <span class="tlabel ${cls}">${cls.toUpperCase()}</span> ${prot}</div>
          <div class="tinfo">Intestato a: <strong>${fmtName(t.holderName,t.holderSurname)}</strong> Â· ${t.holderEmail||'â€”'} Â· Stato: ${status}</div>
        </div>
        <div class="tactions">
          <button class="btn" data-qr="${t.orderId}|${t.id}">Mostra QR</button>
        </div>
      `;
      ticketsBox.appendChild(row);
    }
  }

  // QR handlers
  ticketsBox.addEventListener('click',(e)=>{
    const b = e.target.closest('[data-qr]');
    if(!b) return;
    const payload = b.getAttribute('data-qr'); // ordine|ticket
    // Puoi cifrare/firmare lato server quando passerai a pagamento vero
    const displayText = `TRAPPERREO|${payload}`;
    qrModal.style.display='flex';
    QRCode.toCanvas(qrCanvas, displayText, { width: 256, margin: 1 }, err=>{ if(err) console.error(err); });
  });
  qrClose.addEventListener('click', ()=>{ qrModal.style.display='none'; });
  qrModal.addEventListener('click', (e)=>{ if(e.target===qrModal) qrModal.style.display='none'; });

  // Box profilo
  profileBox.innerHTML = `
    <div><strong>Nome:</strong> ${(u.displayName||'â€”')}</div>
    <div><strong>Email:</strong> ${u.email||'â€”'}</div>
    <div><strong>Ruolo:</strong> ${role}</div>
    <div class="hr"></div>
    <div class="small">Se i dati non sono corretti, aggiornali dal tuo account Google oppure contattaci.</div>
  `;
});
</script>
</body>
</html>
