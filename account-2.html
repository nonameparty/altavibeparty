<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Il tuo account â€” TRAPPERREO</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#000;--text:#fff;--accent:#8b5cf6;--border:rgba(255,255,255,.12);
  --card:rgba(255,255,255,.06);--muted:rgba(255,255,255,.78);
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;min-height:100vh}
header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(140%) blur(6px);background:rgba(0,0,0,.6);border-bottom:1px solid rgba(255,255,255,.08)}
.nav{max-width:1100px;margin:auto;padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.brand-badge{width:22px;height:22px;background:var(--accent);transform:skew(-6deg);border-radius:3px}
.wrap{max-width:1100px;margin:0 auto;padding:24px 20px}
h1{font-size:32px;font-weight:900;letter-spacing:-.2px;margin-bottom:8px}
.badges{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 16px}
.badge{background:#0f0f10;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:13px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
.h2{font-weight:900;font-size:22px;margin-bottom:8px}
.muted{color:var(--muted)}
.btn{display:inline-block;padding:12px 16px;border-radius:10px;background:var(--accent);color:#000;font-weight:900;text-decoration:none;border:none;cursor:pointer}
.btn.outline{background:transparent;color:#fff;border:1px solid var(--accent)}
.hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
.row{display:flex;justify-content:space-between;gap:14px;margin:8px 0}
.k{opacity:.75}
.v{font-weight:800}
.ticket{display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;margin:8px 0;background:#0b0b0b}
.empty{display:flex;align-items:center;justify-content:space-between;background:#0b0b0b;border:1px dashed rgba(255,255,255,.2);border-radius:12px;padding:14px}
.alert{background:rgba(139,92,246,.12);border:1px solid rgba(139,92,246,.4);border-radius:12px;padding:12px;font-size:14px;margin-bottom:10px}
.err{background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.4);border-radius:12px;padding:12px;margin-top:12px;font-size:14px}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="brand-badge"></div><div>TRAPPERREO</div></div>
    <nav id="navArea" class="muted">Caricamentoâ€¦</nav>
  </div>
</header>

<main class="wrap">
  <h1 id="title">Il tuo account</h1>
  <div id="greeting" class="muted">Accesso in corso...</div>

  <div class="badges">
    <span class="badge">Sab 21 Mar 2026</span>
    <span class="badge">22:30 â†’ 04:30</span>
    <span class="badge">Via Italia 38, Biella</span>
  </div>

  <div class="grid">
    <!-- Biglietti -->
    <section class="card">
      <div class="h2">I tuoi biglietti</div>
      <div id="ticketsArea">
        <!-- Se non ci sono ticket appare CTA -->
      </div>
    </section>

    <!-- Profilo -->
    <aside class="card">
      <div class="h2">Profilo</div>
      <div class="row"><div class="k">Nome e cognome</div><div id="pfName" class="v">â€”</div></div>
      <div class="row"><div class="k">Data di nascita</div><div id="pfDob" class="v">â€”</div></div>
      <div class="row"><div class="k">Email</div><div id="pfMail" class="v">â€”</div></div>
      <div class="hr"></div>
      <button id="logoutBtn" class="btn outline">Logout</button>
    </aside>
  </div>

  <div id="errBox" class="err" style="display:none"></div>
</main>

<script type="module">
/* ====== IMPORT ====== */
import { app, onUser, doSignOut, loadProfile } from './auth.v2.js?v=3';
import {
  getFirestore, doc, getDoc, collection, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

/* ====== SETUP ====== */
const db = getFirestore(app);

const nav  = document.getElementById('navArea');
const greet= document.getElementById('greeting');
const pfName = document.getElementById('pfName');
const pfDob  = document.getElementById('pfDob');
const pfMail = document.getElementById('pfMail');
const ticketsArea = document.getElementById('ticketsArea');
const errBox = document.getElementById('errBox');

document.getElementById('logoutBtn').addEventListener('click', async ()=>{
  await doSignOut();
  location.href = './login.html?from=./account-2.html';
});

/* ====== HELPERS UI ====== */
function showError(e){
  console.error(e);
  errBox.style.display='block';
  errBox.textContent = `Errore: ${e?.message || e}`;
}
function fmtDOB(dob){
  if(!dob) return 'â€”';
  try{
    const d=new Date(dob);
    return d.toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
  }catch{ return 'â€”'; }
}
function ticketCard(t){
  const lab = t.type || 'Ticket';
  const who = (t.holderName || 'â€”');
  const code = (t.code || t.ticketId || 'â€”');
  const status = (t.status || 'active');
  return `
    <div class="ticket">
      <div>
        <div style="font-weight:900">${lab}</div>
        <div class="muted" style="font-size:13px">Intestato a: ${who}</div>
      </div>
      <div style="text-align:right">
        <div class="muted" style="font-size:13px">Codice</div>
        <div style="font-weight:900">${code}</div>
        <div class="muted" style="font-size:12px;margin-top:4px">Stato: ${status}</div>
      </div>
    </div>`;
}
function emptyCTA(){
  ticketsArea.innerHTML = `
    <div class="empty">
      <div>Non hai biglietti attivi.</div>
      <a class="btn" href="./checkout.html">Compra ora il tuo biglietto</a>
    </div>
  `;
}

/* ====== CARICAMENTO DATI ====== */
onUser(async (u)=>{
  try{
    if(!u){
      // non loggato â†’ vai al login
      location.href = './login.html?from=./account-2.html';
      return;
    }

    // Navbar
    nav.innerHTML = `<span>ðŸ‘‹ Ciao, ${(u.displayName||u.email||'Utente').split(' ')[0]}</span>`;

    // Greeting
    greet.innerHTML = `Ciao, <strong>${(u.displayName||u.email||'Utente').split(' ')[0]}</strong>`;

    // Profilo da Firestore se presente
    let name = (u.displayName || '').trim();
    let dob  = null;

    try{
      const snap = await getDoc(doc(db,'users',u.uid));
      if(snap.exists()){
        const d = snap.data();
        if(d?.name) name = d.name;
        if(d?.dob)  dob = d.dob;
      }else{
        // fallback: dato locale (come nel tuo salvataggio attuale)
        const local = loadProfile(u.uid);
        if(local?.dob) dob = local.dob;
      }
    }catch(e){ console.warn('Profilo Firestore non disponibile', e); }

    pfName.textContent = name || (u.email?.split('@')[0] || 'â€”');
    pfDob.textContent  = fmtDOB(dob);
    pfMail.textContent = u.email || 'â€”';

    // Biglietti (orders/{orderId}/tickets) â€” se non ci sono, mostra CTA
    try{
      const qOrd = query(collection(db,'orders'), where('uid','==',u.uid), where('status','==','active'));
      const ordersSnap = await getDocs(qOrd);

      const allTickets = [];
      for(const docOrd of ordersSnap.docs){
        const ordId = docOrd.id;
        const tSnap = await getDocs(collection(db, `orders/${ordId}/tickets`));
        tSnap.forEach(t => allTickets.push({ orderId: ordId, ticketId: t.id, ...t.data() }));
      }

      if(allTickets.length === 0){
        emptyCTA();
      }else{
        ticketsArea.innerHTML = `
          <div class="alert">Mostra il QR allâ€™ingresso. Se hai attivato la protezione puoi cambiare nominativo fino a 48h prima.</div>
          ${allTickets.map(ticketCard).join('')}
        `;
      }
    }catch(e){
      console.warn('Query ticket fallita', e);
      emptyCTA();
    }

  }catch(e){
    showError(e);
  }
});

/* ====== SAFETY: mostra errori JS in pagina invece del bianco ====== */
window.addEventListener('error', (ev)=>{ showError(ev.error || ev.message); });
window.addEventListener('unhandledrejection', (ev)=>{ showError(ev.reason || 'Promise rejection'); });
</script>
</body>
</html>
